---
title: "CP_MDD_imaging_assoc"
author: "Hannah Casey"
date: "5/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## Load libraries
library(dplyr)
library(stringr)
library(nlme) #lme function
library(tidyr)
library(Hmisc)
library(lmerTest)
library(emmeans)
library(lme4)
set.seed(151097)
```

## Load in data

Load in dataframes containing imaging data and covariate from UK Biobank (created using UKB_imaging_prep.R script).

```{r load in data, include = FALSE}

## Set working directory
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
work_dir <- "~/Desktop/PhD/projects/UKB_CP_MDD_brain_structure/"
setwd(work_dir)

## Load in data
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Load dataframes containing imaging features of interest and covariates
UKB_imaging_covariates <- read.csv("/Volumes/GenScotDepression/users/hcasey/UKB_brain_structure_CP_MDD/UKB_imaging_covariates_qc.csv", header = TRUE)

UKB_imaging_covariates_long <- read.csv("/Volumes/GenScotDepression/users/hcasey/UKB_brain_structure_CP_MDD/UKB_imaging_covariates_long_qc.csv", header = TRUE)

## Load in Chronic Pain (Keira's Phenotype) (changes to imaging timepoint) and Depression (Natasha's Phenotype) data
UKB_CP <- read.csv("/Users/hannahcasey/Desktop/PhD/projects/UKB_chronic_pain_phenotype/output/UKB_chronic_pain_phenotype_imaging.csv")

## Remame ID column, f_eid -> f_eid
UKB_CP <- UKB_CP %>% 
  dplyr::rename(f.eid = n_eid)

## Identify chronic pain individuals (at least one site of chronic pain)
UKB_CP$chronic_pain <- NA
UKB_CP$chronic_pain[UKB_CP$chronic_pain_sites > 0] <- 1
UKB_CP$chronic_pain[UKB_CP$chronic_pain_sites < 1] <- 0

## Load in MDD derived from Natasha's Algorithm
UKB_MDD <- read.csv("/Users/hannahcasey/Desktop/PhD/projects/UKB_depression_phenotype/output/UKB_depression_phenotype.csv")

## Remame ID column, f_eid -> f_eid
UKB_MDD <- UKB_MDD %>% 
  dplyr::rename(f.eid = f_eid)

## Sort participants into comorbidity groups
## Merge depression and chronic pain data 
UKB_CP_MDD <- full_join(UKB_MDD, UKB_CP[,c("f.eid", "chronic_pain", "chronic_pain_sites")], by = "f.eid")

## Load in neurological status at imgaing assessment
UKB_neurological <- read.csv("/Users/hannahcasey/Desktop/PhD/projects/UKB_CP_MDD_brain_structure/resources/UKB_neurological.csv")

## Exclude those with neurological condition
UKB_neurological_exclude <- UKB_neurological$f_eid[UKB_neurological$neurological == 1]
UKB_CP_MDD <- UKB_CP_MDD[(!UKB_CP_MDD$f.eid %in% UKB_neurological_exclude),]

## Create new column indicating which comorbid group participant belong to
UKB_CP_MDD$comorbidity_group <- NA
UKB_CP_MDD$comorbidity_group[UKB_CP_MDD$recurrent_depression == 0  & UKB_CP_MDD$chronic_pain == 0] <- "No Probable Recurrent MDD + No Chronic Pain"
UKB_CP_MDD$comorbidity_group[UKB_CP_MDD$recurrent_depression == 1 & UKB_CP_MDD$chronic_pain == 0] <- "Probable Recurrent MDD + No Chronic Pain"
UKB_CP_MDD$comorbidity_group[UKB_CP_MDD$recurrent_depression == 0  & UKB_CP_MDD$chronic_pain == 1] <- "No Probable Recurrent MDD + Chronic Pain"
UKB_CP_MDD$comorbidity_group[UKB_CP_MDD$recurrent_depression == 1 & UKB_CP_MDD$chronic_pain == 1] <- "Probable Recurrent MDD + Chronic Pain"

## Check frequency of each comorbidity group
table(UKB_CP_MDD$comorbidity_group)

## Create column indicating if participants have CP+MDD+
UKB_CP_MDD$comorbidity_status <- NA
UKB_CP_MDD$comorbidity_status[UKB_CP_MDD$recurrent_depression == 0  & UKB_CP_MDD$chronic_pain == 0] <- 0
UKB_CP_MDD$comorbidity_status[UKB_CP_MDD$recurrent_depression == 1 & UKB_CP_MDD$chronic_pain == 0] <- 0
UKB_CP_MDD$comorbidity_status[UKB_CP_MDD$recurrent_depression == 0  & UKB_CP_MDD$chronic_pain == 1] <- 0
UKB_CP_MDD$comorbidity_status[UKB_CP_MDD$recurrent_depression == 1 & UKB_CP_MDD$chronic_pain == 1] <-1

```

## Merge chronic pain and depression data with preprocessed imaging dataset

```{r Merge CP and MDD data with imaging}

UKB_CP_MDD_imaging_covariates <-  left_join(UKB_imaging_covariates, UKB_CP_MDD, by = "f.eid")
UKB_CP_MDD_imaging_covariates_long <-  left_join(UKB_imaging_covariates_long, UKB_CP_MDD, by = "f.eid")
```

## Get baseline characteristics for each subgroup in analysis

```{r Get baseline characteristics}

## retains only essential variables
UKB_CP_MDD_imaging_covariates_complete <- UKB_CP_MDD_imaging_covariates %>%
  select(f.eid, BMI_raw, sex, age_raw, ICV, recurrent_depression, chronic_pain, comorbidity_group)

## Get data with complete imaging
UKB_CP_MDD_imaging_covariates_complete <- UKB_CP_MDD_imaging_covariates_complete[!is.na(UKB_CP_MDD_imaging_covariates_complete$ICV),]

## Get number of males and female with phenotyping for each disorder and proportion of females
n_depression_data_f <- nrow(UKB_CP_MDD_imaging_covariates_complete[(!is.na(UKB_CP_MDD_imaging_covariates_complete$recurrent_depression)) & (UKB_CP_MDD_imaging_covariates_complete$sex == "Female"),])
n_depression_data_m <- nrow(UKB_CP_MDD_imaging_covariates_complete[(!is.na(UKB_CP_MDD_imaging_covariates_complete$recurrent_depression)) & (UKB_CP_MDD_imaging_covariates_complete$sex == "Male"),])
n_depression_text <- paste0(n_depression_data_f, "/", n_depression_data_m, " (", round(n_depression_data_f/(n_depression_data_f + n_depression_data_m), 2) * 100, "%)")

n_CP_data_f <- nrow(UKB_CP_MDD_imaging_covariates_complete[(!is.na(UKB_CP_MDD_imaging_covariates_complete$chronic_pain)) & (UKB_CP_MDD_imaging_covariates_complete$sex == "Female"),])
n_CP_data_m <- nrow(UKB_CP_MDD_imaging_covariates_complete[(!is.na(UKB_CP_MDD_imaging_covariates_complete$chronic_pain)) & (UKB_CP_MDD_imaging_covariates_complete$sex == "Male"),])
n_CP_text <- paste0(n_CP_data_f, "/", n_CP_data_m, " (", round(n_CP_data_f/(n_CP_data_f + n_CP_data_m), 2) * 100, "%)")

n_CPMDD_data_f <- nrow(UKB_CP_MDD_imaging_covariates_complete[(!is.na(UKB_CP_MDD_imaging_covariates_complete$comorbidity_group)) & (UKB_CP_MDD_imaging_covariates_complete$sex == "Female"),])
n_CPMDD_data_m <- nrow(UKB_CP_MDD_imaging_covariates_complete[(!is.na(UKB_CP_MDD_imaging_covariates_complete$comorbidity_group)) & (UKB_CP_MDD_imaging_covariates_complete$sex == "Male"),])
n_CPMDD_text <- paste0(n_CPMDD_data_f, "/", n_CPMDD_data_m, " (", round(n_CPMDD_data_f/(n_CPMDD_data_f + n_CPMDD_data_m), 2) * 100, "%)")

## Get number of males and female cases and proportion of female cases of each disorder
n_depression_cases_f <- sum(UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 1 &(UKB_CP_MDD_imaging_covariates_complete$sex == "Female"), na.rm = TRUE)
n_depression_cases_m <- sum(UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 1 &(UKB_CP_MDD_imaging_covariates_complete$sex == "Male"), na.rm = TRUE)
n_depression_cases_text <- paste0(n_depression_cases_f, "/",n_depression_cases_m, " (", round(n_depression_cases_f/(n_depression_cases_f + n_depression_cases_m), 2) * 100, "%)")

n_CP_cases_f <- sum(UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 1 &(UKB_CP_MDD_imaging_covariates_complete$sex == "Female"), na.rm = TRUE)
n_CP_cases_m <- sum(UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 1 &(UKB_CP_MDD_imaging_covariates_complete$sex == "Male"), na.rm = TRUE)
n_CP_cases_text <- paste0(n_CP_cases_f, "/",n_CP_cases_m, " (", round(n_CP_cases_f/(n_CP_cases_f + n_CP_cases_m), 2) * 100, "%)")

n_CPMDD_cases_f <- sum(UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + Chronic Pain" &(UKB_CP_MDD_imaging_covariates_complete$sex == "Female"), na.rm = TRUE)
n_CPMDD_cases_m <- sum(UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + Chronic Pain" &(UKB_CP_MDD_imaging_covariates_complete$sex == "Male"), na.rm = TRUE)
n_CPMDD_cases_text <- paste0(n_CPMDD_cases_f, "/",n_CPMDD_cases_m, " (", round(n_CPMDD_cases_f/(n_CPMDD_cases_f + n_CPMDD_cases_m), 2) * 100, "%)")

n_CPnoMDD_cases_f <- sum(UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain" &(UKB_CP_MDD_imaging_covariates_complete$sex == "Female"), na.rm = TRUE)
n_CPnoMDD_cases_m <- sum(UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain" &(UKB_CP_MDD_imaging_covariates_complete$sex == "Male"), na.rm = TRUE)
n_CPnoMDD_cases_text <- paste0(n_CPnoMDD_cases_f, "/",n_CPnoMDD_cases_m, " (", round(n_CPnoMDD_cases_f/(n_CPnoMDD_cases_f + n_CPnoMDD_cases_m), 2) * 100, "%)")

n_noCPMDD_cases_f <- sum(UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain" &(UKB_CP_MDD_imaging_covariates_complete$sex == "Female"), na.rm = TRUE)
n_noCPMDD_cases_m <- sum(UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain" &(UKB_CP_MDD_imaging_covariates_complete$sex == "Male"), na.rm = TRUE)
n_noCPMDD_cases_text <- paste0(n_noCPMDD_cases_f, "/",n_noCPMDD_cases_m, " (", round(n_noCPMDD_cases_f/(n_noCPMDD_cases_f + n_noCPMDD_cases_m), 2) * 100, "%)")

n_noCPnoMDD_cases_f <- sum(UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" &(UKB_CP_MDD_imaging_covariates_complete$sex == "Female"), na.rm = TRUE)
n_noCPnoMDD_cases_m <- sum(UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" &(UKB_CP_MDD_imaging_covariates_complete$sex == "Male"), na.rm = TRUE)
n_noCPnoMDD_cases_text <- paste0(n_noCPnoMDD_cases_f, "/",n_noCPnoMDD_cases_m, " (", round(n_noCPnoMDD_cases_f/(n_noCPnoMDD_cases_f + n_noCPnoMDD_cases_m), 2) * 100, "%)")

## Get average age of female/male cases/controls each disroder
age_depression_f <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
age_depression_m <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)
age_CP_f <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
age_CP_m <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)

age_no_depression_f <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
age_no_depression_m <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)
age_no_CP_f <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
age_no_CP_m <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)

age_CPMDD_f <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
age_noCPMDD_f <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
age_CPnoMDD_f <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
age_noCPnoMDD_f <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)

age_CPMDD_m <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)
age_noCPMDD_m <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)
age_CPnoMDD_m <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)
age_noCPnoMDD_m <- mean(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)

age_depression_f_text <- paste0(round(age_depression_f, 2),"/", round(age_no_depression_f, 2))
age_depression_m_text <- paste0(round(age_depression_m,2), "/", round(age_no_depression_m,2))
age_CP_f_text <- paste0(round(age_CP_f, 2),"/", round(age_no_CP_f, 2))
age_CP_m_text <- paste0(round(age_CP_m,2), "/", round(age_no_CP_m, 2))
age_CPMDD_f_text <- paste0(round(age_CPMDD_f,2), "/", round(age_noCPnoMDD_f,2))
age_CPMDD_m_text <- paste0(round(age_CPMDD_m,2), "/", round(age_noCPnoMDD_m,2))
age_noCPMDD_f_text <- paste0(round(age_noCPMDD_f,2), "/", round(age_noCPnoMDD_f,2))
age_noCPMDD_m_text <- paste0(round(age_noCPMDD_m,2), "/", round(age_noCPnoMDD_m,2))
age_CPnoMDD_f_text <- paste0(round(age_CPnoMDD_f,2), "/", round(age_noCPnoMDD_f,2))
age_CPnoMDD_m_text <- paste0(round(age_CPnoMDD_m,2), "/", round(age_noCPnoMDD_m,2))
age_noCPnoMDD_f_text <- paste0(round(age_noCPnoMDD_f,2), "/", round(age_noCPnoMDD_f,2))
age_noCPnoMDD_m_text <- paste0(round(age_noCPnoMDD_m,2), "/", round(age_noCPnoMDD_m,2))

## Get average BMI of female/male cases/controls each disroder
BMI_depression_f <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
BMI_depression_m <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)
BMI_CP_f <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
BMI_CP_m <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)

BMI_no_depression_f <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
BMI_no_depression_m <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)
BMI_no_CP_f <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
BMI_no_CP_m <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)

BMI_CPMDD_f <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
BMI_noCPMDD_f <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
BMI_CPnoMDD_f <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)
BMI_noCPnoMDD_f <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], na.rm = TRUE)

BMI_CPMDD_m <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)
BMI_noCPMDD_m <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)
BMI_CPnoMDD_m <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)
BMI_noCPnoMDD_m <- mean(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], na.rm = TRUE)

BMI_depression_f_text <- paste0(round(BMI_depression_f, 2),"/", round(BMI_no_depression_f, 2))
BMI_depression_m_text <- paste0(round(BMI_depression_m,2), "/", round(BMI_no_depression_m,2))
BMI_CP_f_text <- paste0(round(BMI_CP_f, 2),"/", round(BMI_no_CP_f, 2))
BMI_CP_m_text <- paste0(round(BMI_CP_m,2), "/", round(BMI_no_CP_m, 2))
BMI_CPMDD_f_text <- paste0(round(BMI_CPMDD_f,2), "/", round(BMI_noCPnoMDD_f,2))
BMI_CPMDD_m_text <- paste0(round(BMI_CPMDD_m,2), "/", round(BMI_noCPnoMDD_m,2))
BMI_noCPMDD_f_text <- paste0(round(BMI_noCPMDD_f,2), "/", round(BMI_noCPnoMDD_f,2))
BMI_noCPMDD_m_text <- paste0(round(BMI_noCPMDD_m,2), "/", round(BMI_noCPnoMDD_m,2))
BMI_CPnoMDD_f_text <- paste0(round(BMI_CPnoMDD_f,2), "/", round(BMI_noCPnoMDD_f,2))
BMI_CPnoMDD_m_text <- paste0(round(BMI_CPnoMDD_m,2), "/", round(BMI_noCPnoMDD_m,2))
BMI_noCPnoMDD_f_text <- paste0(round(BMI_noCPnoMDD_f,2), "/", round(BMI_noCPnoMDD_f,2))
BMI_noCPnoMDD_m_text <- paste0(round(BMI_noCPnoMDD_m,2), "/", round(BMI_noCPnoMDD_m,2))

## Perform t-test to determine if age and BMI are significantly different between female/male cases/controls in each disorder
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"])
if (t$p.value < 0.05){
  age_depression_f_text <- paste0(age_depression_f_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"])
if (t$p.value < 0.05){
  age_depression_m_text <- paste0(age_depression_m_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"])
if (t$p.value < 0.05){
  age_CP_f_text <- paste0(age_CP_f_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"])
if (t$p.value < 0.05){
  age_CP_m_text <- paste0(age_CP_m_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"])
if (t$p.value < 0.05){
  age_CPMDD_f_text <- paste0(age_CPMDD_f_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"])
if (t$p.value < 0.05){
  age_CPMDD_m_text <- paste0(age_CPMDD_m_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"])
if (t$p.value < 0.05){
  age_CPnoMDD_f_text <- paste0(age_CPnoMDD_f_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"])
if (t$p.value < 0.05){
  age_CPnoMDD_m_text <- paste0(age_CPnoMDD_m_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"])
if (t$p.value < 0.05){
  age_noCPMDD_f_text <- paste0(age_noCPMDD_f_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], UKB_CP_MDD_imaging_covariates_complete$age_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"])
if (t$p.value < 0.05){
  age_noCPMDD_m_text <- paste0(age_noCPMDD_m_text, " *")
}

t <- t.test(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"])
if (t$p.value < 0.05){
  BMI_depression_f_text <- paste0(BMI_depression_f_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$recurrent_depression == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"])
if (t$p.value < 0.05){
  BMI_depression_m_text <- paste0(BMI_depression_m_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"])
if (t$p.value < 0.05){
  BMI_CP_f_text <- paste0(BMI_CP_f_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 1 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$chronic_pain == 0 & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"])
if (t$p.value < 0.05){
  BMI_CP_m_text <- paste0(BMI_CP_m_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"])
if (t$p.value < 0.05){
  BMI_CPMDD_f_text <- paste0(BMI_CPMDD_f_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"])
if (t$p.value < 0.05){
  BMI_CPMDD_m_text <- paste0(BMI_CPMDD_m_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"])
if (t$p.value < 0.05){
  BMI_CPnoMDD_f_text <- paste0(BMI_CPnoMDD_f_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"])
if (t$p.value < 0.05){
  BMI_CPnoMDD_m_text <- paste0(BMI_CPnoMDD_m_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"], UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Female"])
if (t$p.value < 0.05){
  BMI_noCPMDD_f_text <- paste0(BMI_noCPMDD_f_text, " *")
}
t <- t.test(UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"], UKB_CP_MDD_imaging_covariates_complete$BMI_raw[UKB_CP_MDD_imaging_covariates_complete$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain" & UKB_CP_MDD_imaging_covariates_complete$sex == "Male"])
if (t$p.value < 0.05){
  BMI_noCPMDD_m_text <- paste0(BMI_noCPMDD_m_text, " *")
}


UKB_CP_MDD_demographics <- data.frame(Groups = c("MDD", "CP", "CP+MDD+", "CP+MDD-", "CP-MDD+", "CP-MDD-"), `n_female_male_prop_female` = c(n_depression_text, n_CP_text, n_CPMDD_text, n_CPMDD_text, n_CPMDD_text, n_CPMDD_text), `n_cases_female_male_prop_female` = c(n_depression_cases_text, n_CP_cases_text, n_CPMDD_cases_text, n_CPnoMDD_cases_text, n_noCPMDD_cases_text, n_noCPnoMDD_cases_text), `age_female_case_control` = c(age_depression_f_text, age_CP_f_text, age_CPMDD_f_text, age_noCPMDD_f_text, age_CPnoMDD_f_text, age_noCPnoMDD_f_text), age_male_case_control = c(age_depression_m_text, age_CP_m_text, age_CPMDD_m_text, age_noCPMDD_m_text, age_CPnoMDD_m_text, age_noCPnoMDD_m_text), `BMI_female_case_control` = c(BMI_depression_f_text, BMI_CP_f_text, BMI_CPMDD_f_text, BMI_noCPMDD_f_text, BMI_CPnoMDD_f_text, BMI_noCPnoMDD_f_text), BMI_male_case_control = c(BMI_depression_m_text, BMI_CP_m_text, BMI_CPMDD_m_text, BMI_noCPMDD_m_text, BMI_CPnoMDD_m_text, BMI_noCPnoMDD_m_text))
```

## Define functions to carry out hemisphere interaction analysis, glm and lme analysis
```{r Functions for statistcial analysis}

## Create functions to carry out association analysis and hemisphere interaction analysis
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Function to adjust p.values if dataframes with more rows than comparisons being made
p.adjust.new <- function (p, method = p.adjust.methods, n = length(p)) 
{
    method <- match.arg(method)
    if (method == "fdr") 
        method <- "BH"
    nm <- names(p)
    p <- as.numeric(p)
    p0 <- setNames(p, nm)
    if (all(nna <- !is.na(p))) 
        nna <- TRUE
    else p <- p[nna]
    lp <- length(p)
    #stopifnot(n >= lp)
    if (n <= 1) 
        return(p0)
    if (n == 2 && method == "hommel") 
        method <- "hochberg"
    p0[nna] <- switch(method, bonferroni = pmin(1, n * p), holm = {
        i <- seq_len(lp)
        o <- order(p)
        ro <- order(o)
        pmin(1, cummax((n + 1L - i) * p[o]))[ro]
    }, hommel = {
        if (n > lp) p <- c(p, rep.int(1, n - lp))
        i <- seq_len(n)
        o <- order(p)
        p <- p[o]
        ro <- order(o)
        q <- pa <- rep.int(min(n * p/i), n)
        for (j in (n - 1L):2L) {
            ij <- seq_len(n - j + 1L)
            i2 <- (n - j + 2L):n
            q1 <- min(j * p[i2]/(2L:j))
            q[ij] <- pmin(j * p[ij], q1)
            q[i2] <- q[n - j + 1L]
            pa <- pmax(pa, q)
        }
        pmax(pa, p)[if (lp < n) ro[1L:lp] else ro]
    }, hochberg = {
        i <- lp:1L
        o <- order(p, decreasing = TRUE)
        ro <- order(o)
        pmin(1, cummin((n + 1L - i) * p[o]))[ro]
    }, BH = {
        i <- lp:1L
        o <- order(p, decreasing = TRUE)
        ro <- order(o)
        pmin(1, cummin(n/i * p[o]))[ro]
    }, BY = {
        i <- lp:1L
        o <- order(p, decreasing = TRUE)
        ro <- order(o)
        q <- sum(1/(1L:n))
        pmin(1, cummin(q * n/i * p[o]))[ro]
    }, none = p)
    p0
}

## Function to analyze unilateral brain structures
unilateral_structure_assoc <- function(dependent, independent, covariates, dataset, n_comparisons, structural_subtype){
  
  ## Input:
  ## dependent: names of dependent variables
  ## independent: name of independent variable
  ## covariates: array of covariates
  ## dataset: df contating data
  ## n_comparisons: number of multiple comparisons to account for
  ## structural_subtype: name of structural subtype being analysed
  
  ## Create dataframe to store association analysis output
  output <-  data.frame(brain_phenotype=character(), beta=numeric(), std=numeric(), p.value=numeric(),
                                             p.adjust=numeric(), Lower_95CI=numeric(), Upper_95CI=numeric(), n=numeric())
  
  for (i in 1:length(dependent)){
    
    mod <- paste0(dependent[i], "~", independent,  "+" ,  paste(covariates, collapse = " + "))
    glm1 <- glm(as.formula(mod),
                data = dataset,
                na.action = na.exclude)
    
    output[i,"brain_phenotype"] <- dependent[i]
    output[i, "beta"] <- summary(glm1)[["coefficients"]][independent, "Estimate"]
    output[i, "std"] <- summary(glm1)[["coefficients"]][independent, "Std. Error"]
    output[i, "p.value"] <- summary(glm1)[["coefficients"]][independent, "Pr(>|t|)"]
    output[i, c("Lower_95CI", "Upper_95CI")] <- confint(glm1)[independent,]
    output[i, c("n")] <- nobs(glm1)
  }
  
  ## Adjust p-value
  output$p.adjust[!grepl("global|Global", output$brain_phenotype)] <- p.adjust.new(output$p.value[!grepl("global|Global", output$brain_phenotype)], method = "fdr", n = n_comparisons)
  
  ## Do not adjust global measures
  output$p.adjust[grepl("global|Global", output$brain_phenotype)] <- output$p.value[grepl("global|Global", output$brain_phenotype)]
  
  ## Add column indicating brain strucutre sup type being analysed
  output$brain_structure_type <- structural_subtype
    
  return(output)
}

## Function to analyze hemisphere interaction
hemisphere_interaction <- function(dependent, independent, covariates, dataset, n_comparisons, hemisphere_col, structural_subtype){
  
  ## Input:
  ## dependent: names of dependent variables
  ## independent: name of independent variable
  ## covariates: array of covariates
  ## dataset: df contating data
  ## n_comparisons: number of multiple comparisons to account for
  ## hemisphere_col: name of hemisphere column
  ## structural_subtype: name of structural subtype being analysed
  
  ## Create dataframe to store interaction analysis output
  output <- data.frame(interaction_p=numeric())
  ## Run interaction analysis
  for (i in dependent){
    
    mod <- paste0("`",i,"`", "~", independent,"*", hemisphere_col, "+", paste(covariates, collapse = " + "))
  
    ## Carry out interaction analysis
    lm1 <- lm(mod, data = dataset)
  
    output[i,"interaction_p"] <- summary(lm1)[["coefficients"]][paste0(independent, ":hemi"), "Pr(>|t|)"]
  }
  
  ## Adjust p-value
  #output$interaction_p_adjust <- p.adjust.new(output$interaction_p, method = "fdr", n = n_comparisons)
  #output$interaction_p_adjust <- output$interaction_p
  
  ## If statement to notify if any significant interactions are present
  if (any(output$interaction_p < 0.05)){
    return(row.names(output)[output$interaction_p < 0.05])
  }else{
  }
}

## Function to analyze bilateral brain structures
bilateral_structure_assoc <- function(dependent, independent, covariates, dataset, n_comparisons, hemisphere_col, id_col, structural_subtype){
  
  ## Input:
  ## dependent: names of dependent variables
  ## independent: name of independent variable
  ## covariates: array of covariates
  ## dataset: df contating data
  ## n_comparisons: number of multiple comparisons to account for
  ## hemisphere_col: name of hemisphere column
  ## id_col: name of ID column
  ## structural_subtype: name of structural subtype being analysed
  
  ## Create dataframe to store association analysis output
  output <-  data.frame(brain_phenotype=character(), beta=numeric(), std=numeric(), p.value=numeric(),
                        p.adjust=numeric(), Lower_95CI=numeric(), Upper_95CI=numeric(), n=numeric())
  
  ## Run association analysis using lme
  for (i in 1:length(dependent)){
    
    mod <- paste0("`",dependent[i],"`","~", independent , "+", paste(covariates, collapse = " + "),"+", hemisphere_col ," +(1 |" , id_col,")")
    
    lme1 <- lme4::lmer(as.formula(as.character(mod)),data=dataset,
                 na.action=na.exclude)
    
    
    output[i,"brain_phenotype"] <- dependent[i]
    output[i, "beta"] <- summary(lme1)[["coefficients"]][independent, "Estimate"]
    output[i, "std"] <- summary(lme1)[["coefficients"]][independent, "Std. Error"]
    output[i, "p.value"] <- 2*pt(-abs(summary(lme1)[["coefficients"]][independent, "t value"]),df=(nobs(lme1)/2)-1) #calculate p-value from t-value
    output[i, c("Lower_95CI", "Upper_95CI")] <- confint(lme1)[independent,]
    output[i, c("n")] <- sapply(ranef(lme1),nrow)
  }
  
  ## Adjust p-value
  output$p.adjust <- p.adjust.new(output$p.value, method = "fdr", n = n_comparisons)
  
  ## Add column indicating brain strucutre sup type being analysed
  output$brain_structure_type <- structural_subtype
  
  return(output)
}

## Function to analyze unilateral brain structures in groups
unilateral_structure_assoc_group <- function(dependent, independent, covariates, dataset, n_comparisons, structural_subtype){
  
  ## Input:
  ## dependent: names of dependent variables
  ## independent: name of independent variable
  ## covariates: array of covariates
  ## dataset: df contating data
  ## n_comparisons: number of multiple comparisons to account for
  ## structural_subtype: name of structural subtype being analysed
  
  ## Create dataframe to store association analysis output
  output <-  data.frame(brain_phenotype=character(), groups=character(), beta=numeric(), std=numeric(), p.value=numeric(),p.adjust=numeric(), Lower_95CI=numeric(), Upper_95CI=numeric(), n=numeric())
  
  for (i in 1:length(dependent)){
    
    mod <- paste0(dependent[i], "~", independent,  "+" ,  paste(covariates, collapse = " + "))
    
    anova1 <- aov(as.formula(mod),
                data = dataset)

    ## If significant between group difference found, carry out pairwise assoication
    if (summary(anova1)[[1]][independent, "Pr(>F)"] < 0.05){
      
      emmeans1 <- emmeans(anova1, specs = pairwise ~ comorbidity_group, adjust = "none")
      
      output[rep(dependent[i], 6), "brain_phenotype"] <-  dependent[i]
      output[output$brain_phenotype == dependent[i], "groups"] <-  as.data.frame(emmeans1$contrasts)[1]
      output[output$brain_phenotype == dependent[i], "beta"] <-  as.data.frame(emmeans1$contrasts)["estimate"]
      output[output$brain_phenotype == dependent[i], "std"] <-  as.data.frame(emmeans1$contrasts)["SE"]
      output[output$brain_phenotype == dependent[i], "p.value"] <-  as.data.frame(emmeans1$contrasts)["p.value"]
      output[output$brain_phenotype == dependent[i], c("Lower_95CI", "Upper_95CI")] <- confint(emmeans1$contrasts)[c(5,6)]
      output[output$brain_phenotype == dependent[i], c("n")] <- nobs(anova1)

    }else{
      ## Do nothing
    }
  }
  
  ## If some significant differences were detected between groups, apply p-value adjustment
  if(nrow(output) > 0){
  
    ## Adjust p-value
    output$p.adjust[!grepl("global|Global", output$brain_phenotype)] <- p.adjust.new(output$p.value[!grepl("global|Global", output$brain_phenotype)], method = "fdr", n = nrow(output))
    
    ## Check if global measures present
    if(any(grepl("global|Global", output$brain_phenotype))){
      ## Iterate through each gloabl measute and addjust for group comparison
      for (global_measure in unique(grep("global|Global", output$brain_phenotype, value = T))){
        output$p.adjust[output$brain_phenotype == global_measure] <- p.adjust.new(output$p.value[output$brain_phenotype == global_measure], method = "fdr", n = 6)
      }
    }
    
    ## Add column indicating brain strucutre sup type being analysed
    output$brain_structure_type <- structural_subtype
    
    }else{
      ## Do nothing
    }
  return(output)
}

## Function to analyze hemisphere interaction in groups
hemisphere_interaction_group <- function(dependent, independent, covariates, dataset, n_comparisons, hemisphere_col, structural_subtype){
  
  ## Input:
  ## dependent: names of dependent variables
  ## independent: name of independent variable
  ## covariates: array of covariates
  ## dataset: df contating data
  ## n_comparisons: number of multiple comparisons to account for
  ## hemisphere_col: name of hemisphere column
  ## structural_subtype: name of structural subtype being analysed
  
  ## Create dataframe to store interaction analysis output
  output <- data.frame(interaction_p=numeric())
  ## Run interaction analysis
  for (i in dependent){
    
    mod <- paste0("`",i,"`", "~", independent,"*", hemisphere_col, "+", paste(covariates, collapse = " + "))
  
    ## Carry out interaction analysis
    anova1 <- aov(as.formula(mod), data = dataset)
            
    output[i,"brain_phenotype"] <- i
    output[i,"interaction_p"] <- summary(anova1)[[1]]["comorbidity_group:hemi", "Pr(>F)"]
  }
  
  ## Adjust p-value
  #output$interaction_p_adjust <- p.adjust.new(output$interaction_p, method = "fdr", n = n_comparisons)
  #output$interaction_p_adjust <- output$interaction_p
  
  ## If statement to notify if any significant interactions are present
  if (any(output$interaction_p < 0.05)){
    return(row.names(output)[output$interaction_p < 0.05])
  }else{
  }
}

## Function to analyze bilateral brain structures in groups
bilateral_structure_assoc_group <- function(dependent, independent, covariates, dataset, n_comparisons, hemisphere_col, id_col, structural_subtype){
  
  ## Input:
  ## dependent: names of dependent variables
  ## independent: name of independent variable
  ## covariates: array of covariates
  ## dataset: df contating data
  ## n_comparisons: number of multiple comparisons to account for
  ## hemisphere_col: name of hemisphere column
  ## id_col: name of ID column
  ## structural_subtype: name of structural subtype being analysed
  
  ## Create dataframe to store association analysis output
  output <-  data.frame(brain_phenotype=character(), groups=character(), beta=numeric(), std=numeric(), p.value=numeric(),p.adjust=numeric(), Lower_95CI=numeric(), Upper_95CI=numeric(), n=numeric())
  
  ## Run association analysis using lme
  for (i in 1:length(dependent)){
    
    mod <- paste0("`",dependent[i],"`","~", independent , "+", paste(covariates, collapse = " + "),"+", hemisphere_col ," +(1 |" , id_col,")")
    
    lme1 <- lmerTest::lmer(as.formula(as.character(mod)),data=dataset,
                 na.action=na.exclude)
  
    anova1 <- anova(lme1)

    ## If significant between group difference found, carry out pairwise assoication
    if (anova1[independent, "Pr(>F)"] < 0.05){
      
      emmeans1 <- emmeans(lme1, list(pairwise ~ comorbidity_group), adjust = "none")
      
      output[rep(dependent[i], 6), "brain_phenotype"] <-  dependent[i]
      output[output$brain_phenotype == dependent[i], "groups"] <-  as.data.frame(emmeans1$`pairwise differences of comorbidity_group`)[[1]]
      output[output$brain_phenotype == dependent[i], "beta"] <-  as.data.frame(emmeans1$`pairwise differences of comorbidity_group`)["estimate"]
      output[output$brain_phenotype == dependent[i], "std"] <-  as.data.frame(emmeans1$`pairwise differences of comorbidity_group`)["SE"]
      output[output$brain_phenotype == dependent[i], "p.value"] <-  as.data.frame(emmeans1$`pairwise differences of comorbidity_group`)["p.value"]
      output[output$brain_phenotype == dependent[i], c("Lower_95CI", "Upper_95CI")] <- confint(emmeans1)$`pairwise differences of comorbidity_group`[c(5,6)]
      output[output$brain_phenotype == dependent[i], c("n")] <- sapply(ranef(lme1),nrow)

    }else{
      ## Do nothing
    }
  }
  
  ## If some significant differences were detected between groups, apply p-value adjustment
  if(nrow(output) > 0){
  
    ## Adjust p-value
    output$p.adjust <- p.adjust.new(output$p.value, method = "fdr", n = nrow(output))
    
    ## Add column indicating brain strucutre sup type being analysed
    output$brain_structure_type <- structural_subtype
    
    }else{
      ## Do nothing
    }
  return(output)
}

```

## Define association analysis inputs

```{r define association analysis input}

## Define covariates to be used in association analysis
brain_structure_covariates_T1 <- c("sex", "age", "age_squared", "ICV", "BMI", "assessment_centre_first_imaging", "X_position", "Y_position", "Z_position")
brain_structure_covariates_diffusion <- c("sex", "age", "age_squared", "BMI", "assessment_centre_first_imaging", "X_position", "Y_position", "Z_position")

## Define subsets of brain structure variables
## General cortical measures
cortical_volume_general <- grep("volume.*lobe|volume.*global", names(UKB_imaging_covariates), value = TRUE)
cortical_area_general <- grep("area.*lobe|area.*global", names(UKB_imaging_covariates), value = TRUE)
cortical_thickness_general <- grep("thickness.*lobe|thickness.*global", names(UKB_imaging_covariates), value = TRUE)

## SubCortical Regional Volume
sub_cortical_volume_bilateral <- grep("sub_cortical.*left|sub_cortical.*right", names(UKB_imaging_covariates), value = TRUE)

## Regional cortical measures
temp <- grep("volume.*left|volume.*right", names(UKB_imaging_covariates), value = TRUE)
cortical_volume_bilateral <- temp[!temp %in% sub_cortical_volume_bilateral]
cortical_volume_bilateral <- cortical_volume_bilateral[!grepl("sub_cortical", cortical_volume_bilateral)]

cortical_area_bilateral <- grep("area.*left|area.*right", names(UKB_imaging_covariates), value = TRUE)
cortical_thickness_bilateral <- grep("thickness.*left|thickness.*right", names(UKB_imaging_covariates), value = TRUE)

## Individual bilateral FA tracts
FA_bilateral <- grep("FA.*left|FA.*right", names(UKB_imaging_covariates), value = TRUE)

## Individual bilateral MD tracts
MD_bilateral <- grep("MD.*left|MD.*right", names(UKB_imaging_covariates), value = TRUE)

## Individual unilateral FA tracts
FA_unilateral <- c("FA_forceps_major", "FA_forceps_minor", "FA_middle_cerebellar_peduncle")

## Individual unilateral MD tracts
MD_unilateral <- c("MD_forceps_major", "MD_forceps_minor", "MD_middle_cerebellar_peduncle")

## General FA measures
FA_general <- c("FA_global", "FA_association_fibres", "FA_thalamic_radiations", "FA_projection_fibres")

## General MD measures
MD_general <- c("MD_global", "MD_association_fibres", "MD_thalamic_radiations", "MD_projection_fibres")

## Remove hemishpere indicator from long formatted (bilateral) measures as hemiphere indicated in column
sub_cortical_volume_bilateral <- unique(gsub("_left|_right", "", sub_cortical_volume_bilateral))
cortical_volume_bilateral <- unique(gsub("_left|_right", "", cortical_volume_bilateral))
cortical_thickness_bilateral <- unique(gsub("_left|_right", "", cortical_thickness_bilateral))
cortical_area_bilateral <- unique(gsub("_left|_right", "", cortical_area_bilateral))
FA_bilateral <- unique(gsub("_left|_right", "", FA_bilateral))
MD_bilateral <- unique(gsub("_left|_right", "", MD_bilateral))

```

## Check class and range of covariates
```{r Class and range of covariates}

lapply(UKB_CP_MDD_imaging_covariates_long[,brain_structure_covariates_T1], class)
lapply(UKB_CP_MDD_imaging_covariates_long[,brain_structure_covariates_T1], summary)

```

## Carry out association analysis
```{r association analysis}

## Loop through each disorder to carry out association analysis

for (disorder in c("chronic_pain", "recurrent_depression")){
  
  ##Subcortical Volume ----
  ## flag if any bilateral hemisphere measurements need to be analyzed separately
  hemisphere_interactions <- hemisphere_interaction(dependent = sub_cortical_volume_bilateral,
                         independent = disorder,
                         covariates = brain_structure_covariates_T1,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons = length(sub_cortical_volume_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Subcortical Volume")
  
  
  subcortical_volume_assoc <- bilateral_structure_assoc(dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions],
                           independent = disorder,
                           covariates = brain_structure_covariates_T1,
                           dataset = UKB_CP_MDD_imaging_covariates_long,
                           n_comparisons = length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Subcortical Volume",
                           id_col = "f.eid")
  
    if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
    
    subcortical_volume_assoc <- rbind(subcortical_volume_assoc,
                                      unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = disorder,
                                                                 covariates = brain_structure_covariates_T1,
                                                                 dataset = UKB_CP_MDD_imaging_covariates,
                                                                 n_comparisons = length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                 structural_subtype = "Subcortical Volume")
    )
    
    ## Apply multiple comparison correction
    subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr")
    
  }
  
  ## Cortical Volume ----
  
  hemisphere_interactions <- hemisphere_interaction(dependent = cortical_volume_bilateral,
                         independent = disorder,
                         covariates = brain_structure_covariates_T1,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons = length(cortical_volume_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Volume")
  
  cortical_volume_assoc <- bilateral_structure_assoc(dependent = cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions],
                           independent = disorder,
                           covariates = brain_structure_covariates_T1,
                           dataset = UKB_CP_MDD_imaging_covariates_long,
                           n_comparisons = length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Volume",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
    
    cortical_volume_assoc <- rbind(cortical_volume_assoc,
                                      unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = disorder,
                                                                 covariates = brain_structure_covariates_T1,
                                                                 dataset = UKB_CP_MDD_imaging_covariates,
                                                                 n_comparisons = length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                 structural_subtype = "Cortical Regional Volume")
    )
    
    ## Apply multiple comparison correction
    cortical_volume_assoc$p.adjust <- p.adjust.new(cortical_volume_assoc$p.value, method = "fdr")

  }
  
  
  cortical_volume_general_assoc <- unilateral_structure_assoc(dependent = cortical_volume_general,
                           independent = disorder,
                           covariates = brain_structure_covariates_T1,
                           dataset = UKB_CP_MDD_imaging_covariates,
                           n_comparisons = length(cortical_volume_general) -1,
                           structural_subtype = "Cortical Volume Global and Lobal Measures")
  
  ## Cortical Thickness ----
  hemisphere_interactions <- hemisphere_interaction(dependent = cortical_thickness_bilateral,
                         independent = disorder,
                         covariates = brain_structure_covariates_T1,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons = length(cortical_thickness_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Thickness")
  
  cortical_thickness_assoc <- bilateral_structure_assoc(dependent = cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions],
                           independent = disorder,
                           covariates = brain_structure_covariates_T1,
                           dataset = UKB_CP_MDD_imaging_covariates_long,
                           n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Thickness",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
    
    cortical_thickness_assoc <- rbind(cortical_thickness_assoc,
                                      unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = disorder,
                                                                 covariates = brain_structure_covariates_T1,
                                                                 dataset = UKB_CP_MDD_imaging_covariates,
                                                                 n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                 structural_subtype = "Cortical Regional Thickness")
    )
    
    ## Apply multiple comparison correction
    cortical_thickness_assoc$p.adjust <- p.adjust.new(cortical_thickness_assoc$p.value, method = "fdr")

  }
  
  cortical_thickness_general_assoc <- unilateral_structure_assoc(dependent = cortical_thickness_general,
                           independent = disorder,
                           covariates = brain_structure_covariates_T1,
                           dataset = UKB_CP_MDD_imaging_covariates,
                           n_comparisons = length(cortical_thickness_general) -1,
                           structural_subtype = "Cortical Thickness Global and Lobal Measures")
  
  ## Cortical Area ----
  
  hemisphere_interactions <- hemisphere_interaction(dependent = cortical_area_bilateral,
                         independent = disorder,
                         covariates = brain_structure_covariates_T1,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons = length(cortical_area_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Area")
  
  cortical_area_assoc <- bilateral_structure_assoc(dependent = cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions],
                           independent = disorder,
                           covariates = brain_structure_covariates_T1,
                           dataset = UKB_CP_MDD_imaging_covariates_long,
                           n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Area",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
    
    cortical_area_assoc <- rbind(cortical_area_assoc,
                                      unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = disorder,
                                                                 covariates = brain_structure_covariates_T1,
                                                                 dataset = UKB_CP_MDD_imaging_covariates,
                                                                 n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                 structural_subtype = "Cortical Regional Area")
    )
    
    
    ## Apply multiple comparison correction
    cortical_area_assoc$p.adjust <- p.adjust.new(cortical_area_assoc$p.value, method = "fdr")

  }
  
  cortical_area_general_assoc <- unilateral_structure_assoc(dependent = cortical_area_general,
                           independent = disorder,
                           covariates = brain_structure_covariates_T1,
                           dataset = UKB_CP_MDD_imaging_covariates,
                           n_comparisons = length(cortical_area_general) -1,
                           structural_subtype = "Cortical Area Global and Lobal Measures")
  ## FA ----
  
  hemisphere_interactions <- hemisphere_interaction(dependent = FA_bilateral,
                         independent = disorder,
                         covariates = brain_structure_covariates_diffusion,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons = length(FA_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "FA Tracts")
  
  
  FA_bilateral_assoc <- bilateral_structure_assoc(dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions],
                           independent = disorder,
                           covariates = brain_structure_covariates_diffusion,
                           dataset = UKB_CP_MDD_imaging_covariates_long,
                           n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "FA Tracts",
                           id_col = "f.eid")
  
      if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
    
    FA_bilateral_assoc <- rbind(FA_bilateral_assoc,
                                      unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = disorder,
                                                                 covariates = brain_structure_covariates_T1,
                                                                 dataset = UKB_CP_MDD_imaging_covariates,
                                                                 n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                 structural_subtype = "FA Tracts")
    )
    
    ## Apply multiple comparison correction
    FA_bilateral_assoc$p.adjust <- p.adjust.new(FA_bilateral_assoc$p.value, method = "fdr")
  }
  
  
  FA_unilateral_assoc <- unilateral_structure_assoc(dependent = FA_unilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_diffusion,
                           dataset = UKB_CP_MDD_imaging_covariates,
                           n_comparisons = length(FA_unilateral),
                           structural_subtype = "FA Tracts")
  
  
  FA_general_assoc <- unilateral_structure_assoc(dependent = FA_general,
                           independent = disorder,
                           covariates = brain_structure_covariates_diffusion,
                           dataset = UKB_CP_MDD_imaging_covariates,
                           n_comparisons = length(FA_general) -1,
                           structural_subtype = "FA General Measures")
  
  ## MD ----
  
  hemisphere_interactions <- hemisphere_interaction(dependent = MD_bilateral,
                         independent = disorder,
                         covariates = brain_structure_covariates_diffusion,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons = length(MD_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "MD Tracts")
  
  MD_bilateral_assoc <- bilateral_structure_assoc(dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions],
                           independent = disorder,
                           covariates = brain_structure_covariates_diffusion,
                           dataset = UKB_CP_MDD_imaging_covariates_long,
                           n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "MD Tracts",
                           id_col = "f.eid")
  
      if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
    
    MD_bilateral_assoc <- rbind(MD_bilateral_assoc,
                                      unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = disorder,
                                                                 covariates = brain_structure_covariates_T1,
                                                                 dataset = UKB_CP_MDD_imaging_covariates,
                                                                 n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                 structural_subtype = "MD Tracts")
    )
    
    ## Apply multiple comparison correction
    subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr")
  }
  
  MD_unilateral_assoc <- unilateral_structure_assoc(dependent = MD_unilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_diffusion,
                           dataset = UKB_CP_MDD_imaging_covariates,
                           n_comparisons = length(MD_unilateral),
                           structural_subtype = "MD Tracts")
  
  MD_general_assoc <- unilateral_structure_assoc(dependent = MD_general,
                           independent = disorder,
                           covariates = brain_structure_covariates_diffusion,
                           dataset = UKB_CP_MDD_imaging_covariates,
                           n_comparisons = length(MD_general) -1,
                           structural_subtype = "MD General Measures")
  
  ## Combine association results
  all_assoc <- do.call("rbind", list(subcortical_volume_assoc, cortical_volume_assoc, cortical_area_assoc, cortical_thickness_assoc, cortical_area_general_assoc, cortical_thickness_general_assoc, cortical_volume_general_assoc, FA_bilateral_assoc, FA_general_assoc, FA_unilateral_assoc, MD_bilateral_assoc, MD_general_assoc, MD_unilateral_assoc))
  
  ## Add column indicating disorder
  all_assoc$disorder<- disorder
  
  if (disorder == "chronic_pain"){
    CP_MDD_structure_assoc_all <- all_assoc
  }else{
    CP_MDD_structure_assoc_all <- rbind(CP_MDD_structure_assoc_all, all_assoc)
  }
  
  paste(disorder, "and brain strucutre association complete")
}
```

## Carry out association for comorbidity groups

```{r association in comorbidity groups}

## Set CP-MDD- as reference group
UKB_CP_MDD_imaging_covariates_long$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_long$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") 
UKB_CP_MDD_imaging_covariates$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") 


##Subcortical Volume ----
## flag if any bilateral hemisphere measurements need to be analyzed separately
hemisphere_interactions <- hemisphere_interaction_group(dependent = sub_cortical_volume_bilateral,
                       independent = "comorbidity_group",
                       covariates = brain_structure_covariates_T1,
                       dataset = UKB_CP_MDD_imaging_covariates_long,
                       n_comparisons = length(sub_cortical_volume_bilateral),
                       hemisphere_col = "hemi",
                       structural_subtype = "Subcortical Volume")


subcortical_volume_assoc <- bilateral_structure_assoc_group(dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions],
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons =  length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                         hemisphere_col = "hemi",
                         structural_subtype = "Subcortical Volume",
                         id_col = "f.eid")

if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately

  subcortical_volume_assoc <- rbind(subcortical_volume_assoc,
                                    unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                               independent = "comorbidity_group",
                                                               covariates = brain_structure_covariates_T1,
                                                               dataset = UKB_CP_MDD_imaging_covariates,
                                                               n_comparisons = length(sub_cortical_volume_bilateral), ## Adjusted for after
                                                               structural_subtype = "Subcortical Volume")
  )
  
  ## Adjust pvalues
  subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr")
}

## Cortical Volume ----

hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_volume_bilateral,
                       independent = "comorbidity_group",
                       covariates = brain_structure_covariates_T1,
                       dataset = UKB_CP_MDD_imaging_covariates_long,
                       n_comparisons = length(cortical_volume_bilateral),
                       hemisphere_col = "hemi",
                       structural_subtype = "Cortical Regional Volume")

cortical_volume_assoc <- bilateral_structure_assoc_group(dependent =  cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions],
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons =  length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Volume",
                         id_col = "f.eid")

if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately

  cortical_volume_assoc <- rbind(cortical_volume_assoc,
                                    unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                               independent = "comorbidity_group",
                                                               covariates = brain_structure_covariates_T1,
                                                               dataset = UKB_CP_MDD_imaging_covariates,
                                                               n_comparisons = length(sub_cortical_volume_bilateral), ## Adjusted for after
                                                               structural_subtype = "Cortical Regional Volume")
  )
  
  ## Adjust pvalues
  cortical_volume_assoc$p.adjust <- p.adjust.new(cortical_volume_assoc$p.value, method = "fdr")
}


cortical_volume_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_volume_general,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1,
                         dataset = UKB_CP_MDD_imaging_covariates,
                         n_comparisons = length(cortical_volume_general) -1,
                         structural_subtype = "Cortical Volume Global and Lobal Measures")


## Cortical Thickness ----

hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_thickness_bilateral,
                       independent = "comorbidity_group",
                       covariates = brain_structure_covariates_T1,
                       dataset = UKB_CP_MDD_imaging_covariates_long,
                       n_comparisons = length(cortical_thickness_bilateral),
                       hemisphere_col = "hemi",
                       structural_subtype = "Cortical Regional Thickness")

cortical_thickness_assoc <- bilateral_structure_assoc_group(dependent =  cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions],
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Thickness",
                         id_col = "f.eid")

if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately

  cortical_thickness_assoc <- rbind(cortical_thickness_assoc,
                                    unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                               independent = "comorbidity_group",
                                                               covariates = brain_structure_covariates_T1,
                                                               dataset = UKB_CP_MDD_imaging_covariates,
                                                               n_comparisons = length(sub_cortical_thickness_bilateral), ## Adjusted for after
                                                               structural_subtype = "Cortical Regional Thickness")
  )
  
  ## Adjust pvalues
  cortical_thickness_assoc$p.adjust <- p.adjust.new(cortical_thickness_assoc$p.value, method = "fdr")
}

cortical_thickness_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_thickness_general,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1,
                         dataset = UKB_CP_MDD_imaging_covariates,
                         n_comparisons = length(cortical_thickness_general) -1,
                         structural_subtype = "Cortical Thickness Global and Lobal Measures")

## Cortical Area ----

hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_area_bilateral,
                       independent = "comorbidity_group",
                       covariates = brain_structure_covariates_T1,
                       dataset = UKB_CP_MDD_imaging_covariates_long,
                       n_comparisons = length(cortical_area_bilateral),
                       hemisphere_col = "hemi",
                       structural_subtype = "Cortical Regional Area")

cortical_area_assoc <- bilateral_structure_assoc_group(dependent =  cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions],
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Area",
                         id_col = "f.eid")

if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately

  cortical_area_assoc <- rbind(cortical_area_assoc,
                                    unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                               independent = "comorbidity_group",
                                                               covariates = brain_structure_covariates_T1,
                                                               dataset = UKB_CP_MDD_imaging_covariates,
                                                               n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after
                                                               structural_subtype = "Cortical Regional Area")
  )
  
  ## Adjust pvalues
  cortical_area_assoc$p.adjust <- p.adjust.new(cortical_area_assoc$p.value, method = "fdr")
}

cortical_area_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_area_general,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1,
                         dataset = UKB_CP_MDD_imaging_covariates,
                         n_comparisons = length(cortical_area_general) -1,
                         structural_subtype = "Cortical Area Global and Lobal Measures")


##FA ----

hemisphere_interactions <- hemisphere_interaction_group(dependent = FA_bilateral,
                       independent = "comorbidity_group",
                       covariates = brain_structure_covariates_diffusion,
                       dataset = UKB_CP_MDD_imaging_covariates_long,
                       n_comparisons = length(FA_bilateral),
                       hemisphere_col = "hemi",
                       structural_subtype = "FA Tracts")


FA_bilateral_assoc <- bilateral_structure_assoc_group(dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions],
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_diffusion,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                         hemisphere_col = "hemi",
                         structural_subtype = "FA Tracts",
                         id_col = "f.eid")

if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately

  FA_bilateral_assoc <- rbind(FA_bilateral_assoc,
                        unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                        independent = "comorbidity_group",
                        covariates = brain_structure_covariates_T1,
                        dataset = UKB_CP_MDD_imaging_covariates,
                        n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after
                        structural_subtype = "FA Tracts")
  )
  
  ## Adjust pvalues
  FA_bilateral_assoc$p.adjust <- p.adjust.new(FA_bilateral_assoc$p.value, method = "fdr")
}


FA_unilateral_assoc <- unilateral_structure_assoc_group(dependent = FA_unilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_diffusion,
                         dataset = UKB_CP_MDD_imaging_covariates,
                         n_comparisons = length(FA_unilateral),
                         structural_subtype = "FA Tracts")


FA_general_assoc <- unilateral_structure_assoc_group(dependent = FA_general,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_diffusion,
                         dataset = UKB_CP_MDD_imaging_covariates,
                         n_comparisons = length(FA_general) -1,
                         structural_subtype = "FA General Measures")

##MD ----

hemisphere_interactions <- hemisphere_interaction_group(dependent = MD_bilateral,
                       independent = "comorbidity_group",
                       covariates = brain_structure_covariates_diffusion,
                       dataset = UKB_CP_MDD_imaging_covariates_long,
                       n_comparisons = length(MD_bilateral),
                       hemisphere_col = "hemi",
                       structural_subtype = "MD Tracts")

MD_bilateral_assoc <- bilateral_structure_assoc_group(dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions],
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_diffusion,
                         dataset = UKB_CP_MDD_imaging_covariates_long,
                         n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                         hemisphere_col = "hemi",
                         structural_subtype = "MD Tracts",
                         id_col = "f.eid")

if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately

  MD_bilateral_assoc <- rbind(MD_bilateral_assoc,
                        unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                        independent = "comorbidity_group",
                        covariates = brain_structure_covariates_T1,
                        dataset = UKB_CP_MDD_imaging_covariates,
                        n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after
                        structural_subtype = "MD Tracts")
  )
  
  ## Adjust pvalues
  FA_bilateral_assoc$p.adjust <- p.adjust.new(FA_bilateral_assoc$p.value, method = "fdr")
}

MD_unilateral_assoc <- unilateral_structure_assoc_group(dependent = MD_unilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_diffusion,
                         dataset = UKB_CP_MDD_imaging_covariates,
                         n_comparisons = length(MD_unilateral),
                         structural_subtype = "MD Tracts")

MD_general_assoc <- unilateral_structure_assoc_group(dependent = MD_general,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_diffusion,
                         dataset = UKB_CP_MDD_imaging_covariates,
                         n_comparisons = length(MD_general) -1,
                         structural_subtype = "MD General Measures")

## Combine association results
comorbidity_structure_assoc_all <- do.call("rbind", list(subcortical_volume_assoc, cortical_volume_assoc, cortical_area_assoc, cortical_thickness_assoc, cortical_area_general_assoc, cortical_thickness_general_assoc, cortical_volume_general_assoc, FA_bilateral_assoc, FA_general_assoc, FA_unilateral_assoc, MD_bilateral_assoc, MD_general_assoc, MD_unilateral_assoc))

## Add column indicating disorder
comorbidity_structure_assoc_all$disorder<- "comorbidity"




```

## Carry out sex-stratified association analysis

```{r sex-stratified association analysis}

## Get sex-specific dataframes
UKB_CP_MDD_imaging_covariates_long_females <- UKB_CP_MDD_imaging_covariates_long[UKB_CP_MDD_imaging_covariates_long$sex == "Female",]

UKB_CP_MDD_imaging_covariates_long_males <- UKB_CP_MDD_imaging_covariates_long[UKB_CP_MDD_imaging_covariates_long$sex == "Male",]

UKB_CP_MDD_imaging_covariates_females <- UKB_CP_MDD_imaging_covariates[UKB_CP_MDD_imaging_covariates$sex == "Female",]
UKB_CP_MDD_imaging_covariates_males <- UKB_CP_MDD_imaging_covariates[UKB_CP_MDD_imaging_covariates$sex == "Male",]

## Remove sex as covariate
brain_structure_covariates_T1_no_sex <- brain_structure_covariates_T1[brain_structure_covariates_T1 != "sex"]
brain_structure_covariates_diffusion_no_sex <- brain_structure_covariates_diffusion[brain_structure_covariates_diffusion != "sex"]

## Loop through each disorder to carry out association analysis

for (sex in c("females", "males")){
  for (disorder in c("chronic_pain", "recurrent_depression")){
    
    ##Subcortical Volume ----
    ## flag if any bilateral hemisphere measurements need to be analyzed separately
    hemisphere_interactions <- hemisphere_interaction(dependent = sub_cortical_volume_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(sub_cortical_volume_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "Subcortical Volume")
    
    
    subcortical_volume_assoc <- bilateral_structure_assoc(dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                             n_comparisons = length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "Subcortical Volume",
                             id_col = "f.eid")
    
      if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      subcortical_volume_assoc <- rbind(subcortical_volume_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                                                                   n_comparisons = length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "Subcortical Volume")
      )
      
      ## Adjust pvalues
      subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr")
    }
    
    ## Cortical Volume ----
    
    hemisphere_interactions <- hemisphere_interaction(dependent = cortical_volume_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(cortical_volume_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Volume")
    
    cortical_volume_assoc <- bilateral_structure_assoc(dependent = cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                             n_comparisons = length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "Cortical Regional Volume",
                             id_col = "f.eid")
    
    if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      cortical_volume_assoc <- rbind(cortical_volume_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                                                                   n_comparisons = length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "Cortical Regional Volume")
      )
      
      ## Adjust pvalues
      cortical_volume_assoc$p.adjust <- p.adjust.new(cortical_volume_assoc$p.value, method = "fdr")
    }
    
    
    cortical_volume_general_assoc <- unilateral_structure_assoc(dependent = cortical_volume_general,
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                             n_comparisons = length(cortical_volume_general) -1,
                             structural_subtype = "Cortical Volume Global and Lobal Measures")
    
    ## Cortical Thickness ----
    hemisphere_interactions <- hemisphere_interaction(dependent = cortical_thickness_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(cortical_thickness_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Thickness")
    
    cortical_thickness_assoc <- bilateral_structure_assoc(dependent = cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                             n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "Cortical Regional Thickness",
                             id_col = "f.eid")
    
    if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      cortical_thickness_assoc <- rbind(cortical_thickness_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                                                                   n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "Cortical Regional Thickness")
      )
      
      ## Adjust pvalues
      cortical_thickness_assoc$p.adjust <- p.adjust.new(cortical_thickness_assoc$p.value, method = "fdr")
    }
    
    cortical_thickness_general_assoc <- unilateral_structure_assoc(dependent = cortical_thickness_general,
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                             n_comparisons = length(cortical_thickness_general) -1,
                             structural_subtype = "Cortical Thickness Global and Lobal Measures")
    
    ## Cortical Area ----
    
    hemisphere_interactions <- hemisphere_interaction(dependent = cortical_area_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(cortical_area_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Area")
    
    cortical_area_assoc <- bilateral_structure_assoc(dependent = cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                             n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "Cortical Regional Area",
                             id_col = "f.eid")
    
    if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      cortical_area_assoc <- rbind(cortical_area_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                                                                   n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "Cortical Regional Area")
      )
      
      ## Adjust pvalues
      cortical_area_assoc$p.adjust <- p.adjust.new(cortical_area_assoc$p.value, method = "fdr")
    }
    
    cortical_area_general_assoc <- unilateral_structure_assoc(dependent = cortical_area_general,
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                             n_comparisons = length(cortical_area_general) -1,
                             structural_subtype = "Cortical Area Global and Lobal Measures")
    ## FA ----
    
    hemisphere_interactions <- hemisphere_interaction(dependent = FA_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(FA_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "FA Tracts")
    
    
    FA_bilateral_assoc <- bilateral_structure_assoc(dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                             n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "FA Tracts",
                             id_col = "f.eid")
    
        if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      FA_bilateral_assoc <- rbind(FA_bilateral_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                                                                   n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "FA Tracts")
      )
      
      ## Adjust pvalues
      FA_bilateral_assoc$p.adjust <- p.adjust.new(FA_bilateral_assoc$p.value, method = "fdr")
    }
    
    
    FA_unilateral_assoc <- unilateral_structure_assoc(dependent = FA_unilateral,
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                             n_comparisons = length(FA_unilateral),
                             structural_subtype = "FA Tracts")
    
    
    FA_general_assoc <- unilateral_structure_assoc(dependent = FA_general,
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                             n_comparisons = length(FA_general) -1,
                             structural_subtype = "FA General Measures")
    
    ## MD ----
    
    hemisphere_interactions <- hemisphere_interaction(dependent = MD_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(MD_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "MD Tracts")
    
    MD_bilateral_assoc <- bilateral_structure_assoc(dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                             n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "MD Tracts",
                             id_col = "f.eid")
    
        if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      MD_bilateral_assoc <- rbind(MD_bilateral_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                                                                   n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "MD Tracts")
      )
      
      ## Adjust pvalues
      MD_bilateral_assoc$p.adjust <- p.adjust.new(MD_bilateral_assoc$p.value, method = "fdr")
    }
    
    MD_unilateral_assoc <- unilateral_structure_assoc(dependent = MD_unilateral,
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                             n_comparisons = length(MD_unilateral),
                             structural_subtype = "MD Tracts")
    
    MD_general_assoc <- unilateral_structure_assoc(dependent = MD_general,
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                             n_comparisons = length(MD_general) -1,
                             structural_subtype = "MD General Measures")
    
    ## Combine association results
    all_assoc <- do.call("rbind", list(subcortical_volume_assoc, cortical_volume_assoc, cortical_area_assoc, cortical_thickness_assoc, cortical_area_general_assoc, cortical_thickness_general_assoc, cortical_volume_general_assoc, FA_bilateral_assoc, FA_general_assoc, FA_unilateral_assoc, MD_bilateral_assoc, MD_general_assoc, MD_unilateral_assoc))
  
    ## Add column indicating disorder
    all_assoc$disorder<- disorder
    
    ## append association analysis
    if (disorder == "chronic_pain"){
      assign(paste0("CP_MDD_structure_assoc_", sex), all_assoc)
    }else{
      assign(paste0("CP_MDD_structure_assoc_", sex) , rbind(get(paste0("CP_MDD_structure_assoc_", sex)), all_assoc))
    }
    paste("sex-stratified", disorder, "and brain strucutre association complete")
  }
}
```

## Carry out sex-stratified association for comorbidity groups

```{r sex-stratified assocaition in comorbidity groups}

## Set CP-MDD- as reference group
UKB_CP_MDD_imaging_covariates_long_females$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_long_females$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") 
UKB_CP_MDD_imaging_covariates_females$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_females$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain")

## Set CP-MDD- as reference group
UKB_CP_MDD_imaging_covariates_long_males$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_long_males$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") 
UKB_CP_MDD_imaging_covariates_males$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_males$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") 

for (sex in c("females", "males")){
  
    
   ##Subcortical Volume ----
  hemisphere_interactions <- hemisphere_interaction_group(dependent = sub_cortical_volume_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                         n_comparisons = length(sub_cortical_volume_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Subcortical Volume")
  
  
  subcortical_volume_assoc <- bilateral_structure_assoc_group(dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Subcortical Volume",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    subcortical_volume_assoc <- rbind(subcortical_volume_assoc,
                                      unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = "comorbidity_group",
                                                                 covariates = brain_structure_covariates_T1_no_sex,
                                                                 dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                                                                 n_comparisons = length(sub_cortical_volume_bilateral), ## Adjusted for after
                                                                 structural_subtype = "Subcortical Volume")
    )
    
    ## Adjust pvalues
    subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr")
  }
  
  ## Cortical Volume ----
  
  hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_volume_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                         n_comparisons = length(cortical_volume_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Volume")
  
  cortical_volume_assoc <- bilateral_structure_assoc_group(dependent = cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Volume",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    cortical_volume_assoc <- rbind(cortical_volume_assoc,
                                      unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = "comorbidity_group",
                                                                 covariates = brain_structure_covariates_T1_no_sex,
                                                                 dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                                                                 n_comparisons = length(sub_cortical_volume_bilateral), ## Adjusted for after
                                                                 structural_subtype = "Cortical Regional Volume")
    )
    
    ## Adjust pvalues
    cortical_volume_assoc$p.adjust <- p.adjust.new(cortical_volume_assoc$p.value, method = "fdr")
  }
  
  
  cortical_volume_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_volume_general,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                           n_comparisons = length(cortical_volume_general) -1,
                           structural_subtype = "Cortical Volume Global and Lobal Measures")
  
  
  ## Cortical Thickness ----
  
  hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_thickness_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                         n_comparisons = length(cortical_thickness_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Thickness")
  
  cortical_thickness_assoc <- bilateral_structure_assoc_group(dependent = cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Thickness",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    cortical_thickness_assoc <- rbind(cortical_thickness_assoc,
                                      unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = "comorbidity_group",
                                                                 covariates = brain_structure_covariates_T1_no_sex,
                                                                 dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                                                                 n_comparisons = length(sub_cortical_thickness_bilateral), ## Adjusted for after
                                                                 structural_subtype = "Cortical Regional Thickness")
    )
    
    ## Adjust pvalues
    cortical_thickness_assoc$p.adjust <- p.adjust.new(cortical_thickness_assoc$p.value, method = "fdr")
  }
  
  cortical_thickness_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_thickness_general,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                           n_comparisons = length(cortical_thickness_general) -1,
                           structural_subtype = "Cortical Thickness Global and Lobal Measures")
  
  ## Cortical Area ----
  
  hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_area_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                         n_comparisons = length(cortical_area_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Area")
  
  cortical_area_assoc <- bilateral_structure_assoc_group(dependent = cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Area",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    cortical_area_assoc <- rbind(cortical_area_assoc,
                                      unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = "comorbidity_group",
                                                                 covariates = brain_structure_covariates_T1_no_sex,
                                                                 dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                                                                 n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after
                                                                 structural_subtype = "Cortical Regional Area")
    )
    
    ## Adjust pvalues
    cortical_area_assoc$p.adjust <- p.adjust.new(cortical_area_assoc$p.value, method = "fdr")
  }
  
  cortical_area_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_area_general,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                           n_comparisons = length(cortical_area_general) -1,
                           structural_subtype = "Cortical Area Global and Lobal Measures")
  
  
  ##FA ----
  
  hemisphere_interactions <- hemisphere_interaction_group(dependent = FA_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_diffusion_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                         n_comparisons = length(FA_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "FA Tracts")
  
  
  FA_bilateral_assoc <- bilateral_structure_assoc_group(dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "FA Tracts",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    FA_bilateral_assoc <- rbind(FA_bilateral_assoc,
                          unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                          independent = "comorbidity_group",
                          covariates = brain_structure_covariates_T1_no_sex,
                          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                          n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after
                          structural_subtype = "FA Tracts")
    )
    
    ## Adjust pvalues
    FA_bilateral_assoc$p.adjust <- p.adjust.new(FA_bilateral_assoc$p.value, method = "fdr")
  }
  
  
  FA_unilateral_assoc <- unilateral_structure_assoc_group(dependent = FA_unilateral,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                           n_comparisons = length(FA_unilateral),
                           structural_subtype = "FA Tracts")
  
  
  FA_general_assoc <- unilateral_structure_assoc_group(dependent = FA_general,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                           n_comparisons = length(FA_general) -1,
                           structural_subtype = "FA General Measures")
  
  ##MD ----
  
  hemisphere_interactions <- hemisphere_interaction_group(dependent = MD_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_diffusion_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                         n_comparisons = length(MD_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "MD Tracts")
  
  MD_bilateral_assoc <- bilateral_structure_assoc_group(dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "MD Tracts",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    MD_bilateral_assoc <- rbind(MD_bilateral_assoc,
                          unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                          independent = "comorbidity_group",
                          covariates = brain_structure_covariates_T1_no_sex,
                          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                          n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after
                          structural_subtype = "MD Tracts")
    )
    
    ## Adjust pvalues
    MD_bilateral_assoc$p.adjust <- p.adjust.new(MD_bilateral_assoc$p.value, method = "fdr")
  }
  
  MD_unilateral_assoc <- unilateral_structure_assoc_group(dependent = MD_unilateral,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                           n_comparisons = length(MD_unilateral),
                           structural_subtype = "MD Tracts")
  
  MD_general_assoc <- unilateral_structure_assoc_group(dependent = MD_general,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
                           n_comparisons = length(MD_general) -1,
                           structural_subtype = "MD General Measures")
  
  ## Combine association results
  assign(paste0("comorbidity_structure_assoc_", sex), do.call("rbind", list(subcortical_volume_assoc, cortical_volume_assoc, cortical_area_assoc, cortical_thickness_assoc, cortical_area_general_assoc, cortical_thickness_general_assoc, cortical_volume_general_assoc, FA_bilateral_assoc, FA_general_assoc, FA_unilateral_assoc, MD_bilateral_assoc, MD_general_assoc, MD_unilateral_assoc)))
  
}

## Add column indicating disorder
comorbidity_structure_assoc_females$disorder<- "comorbidity"
comorbidity_structure_assoc_males$disorder<- "comorbidity"

```

## Get equal numbers of male and females in each sample

```{r balance datasets between sexes}
UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced <- UKB_CP_MDD_imaging_covariates %>%
  select(f.eid, BMI, sex, age, recurrent_depression, ICV, volume_paracentral_right, assessment_centre_first_imaging, sub_cortical_volume_thalamus_left, MD_acoustic_radiation_left) %>%
  na.omit() 

UKB_CP_MDD_imaging_covariates_chronic_pain_balanced <- UKB_CP_MDD_imaging_covariates %>%
  select(f.eid, BMI, sex, age, chronic_pain, volume_paracentral_right, assessment_centre_first_imaging, sub_cortical_volume_thalamus_left, MD_acoustic_radiation_left) %>%
  na.omit() 

UKB_CP_MDD_imaging_covariates_CPMDD_balanced <- UKB_CP_MDD_imaging_covariates %>%
  select(f.eid, BMI, sex, age, comorbidity_group, volume_paracentral_right, assessment_centre_first_imaging, sub_cortical_volume_thalamus_left, MD_acoustic_radiation_left) %>%
  na.omit()
  

## Get same number of male/female cases and controls
## Get number of male/female cases/controls
n_depression_cases_male <- sum((UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$sex == "Male" & UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$recurrent_depression == 1), na.rm = TRUE)
n_depression_cases_female <- sum((UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$recurrent_depression == 1), na.rm = TRUE)
n_depression_controls_male <- sum((UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$sex == "Male" & UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$recurrent_depression == 0), na.rm = TRUE)
n_depression_controls_female <- sum((UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$recurrent_depression == 0), na.rm = TRUE)

n_CP_cases_male <- sum((UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$sex == "Male" & UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$chronic_pain == 1), na.rm = TRUE)
n_CP_cases_female <- sum((UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$chronic_pain == 1), na.rm = TRUE)
n_CP_controls_male <- sum((UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$sex == "Male" & UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$chronic_pain == 0), na.rm = TRUE)
n_CP_controls_female <- sum((UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$chronic_pain == 0), na.rm = TRUE)


n_CPMDD_male <- sum((UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Male" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "Probable Recurrent MDD + Chronic Pain"), na.rm = TRUE)
n_CPMDD_female <- sum((UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "Probable Recurrent MDD + Chronic Pain"), na.rm = TRUE)
n_CPnoMDD_male <- sum((UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Male" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain"), na.rm = TRUE)
n_CPnoMDD_female <- sum((UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain"), na.rm = TRUE)
n_noCPMDD_male <- sum((UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Male" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain"), na.rm = TRUE)
n_noCPMDD_female <- sum((UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain"), na.rm = TRUE)
n_noCPnoMDD_male <- sum((UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Male" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain"), na.rm = TRUE)
n_noCPnoMDD_female <- sum((UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain"), na.rm = TRUE)


## Sample random female/male cases/controls to remove
row_n_depression_female_cases_exclude <- sample(which(UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$recurrent_depression == 1), (n_depression_cases_female - n_depression_cases_male), replace = FALSE, prob = NULL)
row_n_depression_male_controls_exclude <- sample(which(UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$sex == "Male" & UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$recurrent_depression == 0), (n_depression_controls_male - n_depression_controls_female), replace = FALSE, prob = NULL)

row_n_CP_female_cases_exclude <- sample(which(UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$chronic_pain == 1), (n_CP_cases_female - n_CP_cases_male), replace = FALSE, prob = NULL)
row_n_CP_female_controls_exclude <- sample(which(UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$chronic_pain == 0), (n_CP_controls_female - n_CP_controls_male), replace = FALSE, prob = NULL)

row_n_CPMDD_female_exclude <- sample(which(UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "Probable Recurrent MDD + Chronic Pain"), (n_CPMDD_female - n_CPMDD_male), replace = FALSE, prob = NULL)
row_n_CPnoMDD_male_exclude <- sample(which(UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Male" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "No Probable Recurrent MDD + Chronic Pain"), (n_CPnoMDD_male - n_CPnoMDD_female), replace = FALSE, prob = NULL)
row_n_noCPMDD_female_exclude <- sample(which(UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Female" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "Probable Recurrent MDD + No Chronic Pain"), (n_noCPMDD_female - n_noCPMDD_male), replace = FALSE, prob = NULL)
row_n_noCPnoMDD_male_exclude <- sample(which(UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex == "Male" & UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group == "No Probable Recurrent MDD + No Chronic Pain"), (n_noCPnoMDD_male - n_noCPnoMDD_female), replace = FALSE, prob = NULL)

## Remove cases/controls
UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced <- UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced[-c(row_n_depression_female_cases_exclude, row_n_depression_male_controls_exclude),]
UKB_CP_MDD_imaging_covariates_chronic_pain_balanced <- UKB_CP_MDD_imaging_covariates_chronic_pain_balanced[-c(row_n_CP_female_cases_exclude, row_n_CP_female_controls_exclude),]
UKB_CP_MDD_imaging_covariates_CPMDD_balanced <- UKB_CP_MDD_imaging_covariates_CPMDD_balanced[-c(row_n_CPMDD_female_exclude, row_n_CPnoMDD_male_exclude, row_n_noCPMDD_female_exclude, row_n_noCPnoMDD_male_exclude),]


## Double check that n of female/male cases/cotrols are equal in each disorder
table(UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$recurrent_depression, UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$sex)
table(UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$chronic_pain, UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$sex)
table(UKB_CP_MDD_imaging_covariates_CPMDD_balanced$comorbidity_group, UKB_CP_MDD_imaging_covariates_CPMDD_balanced$sex)
```

## Carry out association analysis in sex-balanced datasets

```{r sex-stratified association analysis in balanced datasets}

## Get sex-specific and sex-balanced dataframes
UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced_females <- UKB_CP_MDD_imaging_covariates[(UKB_CP_MDD_imaging_covariates$f.eid %in% UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$f.eid & UKB_CP_MDD_imaging_covariates$sex == "Female"),]
UKB_CP_MDD_imaging_covariates_long_recurrent_depression_balanced_females <- UKB_CP_MDD_imaging_covariates_long[(UKB_CP_MDD_imaging_covariates_long$f.eid %in% UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$f.eid & UKB_CP_MDD_imaging_covariates_long$sex == "Female"),]
UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced_males <- UKB_CP_MDD_imaging_covariates[(UKB_CP_MDD_imaging_covariates$f.eid %in% UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$f.eid & UKB_CP_MDD_imaging_covariates$sex == "Male"),]
UKB_CP_MDD_imaging_covariates_long_recurrent_depression_balanced_males <- UKB_CP_MDD_imaging_covariates_long[(UKB_CP_MDD_imaging_covariates_long$f.eid %in% UKB_CP_MDD_imaging_covariates_recurrent_depression_balanced$f.eid & UKB_CP_MDD_imaging_covariates_long$sex == "Male"),]

UKB_CP_MDD_imaging_covariates_chronic_pain_balanced_females <- UKB_CP_MDD_imaging_covariates[(UKB_CP_MDD_imaging_covariates$f.eid %in% UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$f.eid & UKB_CP_MDD_imaging_covariates$sex == "Female"),]
UKB_CP_MDD_imaging_covariates_long_chronic_pain_balanced_females <- UKB_CP_MDD_imaging_covariates_long[(UKB_CP_MDD_imaging_covariates_long$f.eid %in% UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$f.eid & UKB_CP_MDD_imaging_covariates_long$sex == "Female"),]
UKB_CP_MDD_imaging_covariates_chronic_pain_balanced_males <- UKB_CP_MDD_imaging_covariates[(UKB_CP_MDD_imaging_covariates$f.eid %in% UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$f.eid & UKB_CP_MDD_imaging_covariates$sex == "Male"),]
UKB_CP_MDD_imaging_covariates_long_chronic_pain_balanced_males <- UKB_CP_MDD_imaging_covariates_long[(UKB_CP_MDD_imaging_covariates_long$f.eid %in% UKB_CP_MDD_imaging_covariates_chronic_pain_balanced$f.eid & UKB_CP_MDD_imaging_covariates_long$sex == "Male"),]

UKB_CP_MDD_imaging_covariates_CPMDD_balanced_females <- UKB_CP_MDD_imaging_covariates[(UKB_CP_MDD_imaging_covariates$f.eid %in% UKB_CP_MDD_imaging_covariates_CPMDD_balanced$f.eid & UKB_CP_MDD_imaging_covariates$sex == "Female"),]
UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_females <- UKB_CP_MDD_imaging_covariates_long[(UKB_CP_MDD_imaging_covariates_long$f.eid %in% UKB_CP_MDD_imaging_covariates_CPMDD_balanced$f.eid & UKB_CP_MDD_imaging_covariates_long$sex == "Female"),]
UKB_CP_MDD_imaging_covariates_CPMDD_balanced_males <- UKB_CP_MDD_imaging_covariates[(UKB_CP_MDD_imaging_covariates$f.eid %in% UKB_CP_MDD_imaging_covariates_CPMDD_balanced$f.eid & UKB_CP_MDD_imaging_covariates$sex == "Male"),]
UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_males <- UKB_CP_MDD_imaging_covariates_long[(UKB_CP_MDD_imaging_covariates_long$f.eid %in% UKB_CP_MDD_imaging_covariates_CPMDD_balanced$f.eid & UKB_CP_MDD_imaging_covariates_long$sex == "Male"),]


## Loop through each disorder to carry out association analysis

for (sex in c("females", "males")){
  for (disorder in c("chronic_pain", "recurrent_depression")){
    
    ##Subcortical Volume ----
    ## flag if any bilateral hemisphere measurements need to be analyzed separately
    hemisphere_interactions <- hemisphere_interaction(dependent = sub_cortical_volume_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",disorder, "_balanced_", sex)),
                           n_comparisons = length(sub_cortical_volume_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "Subcortical Volume")
    
    
    subcortical_volume_assoc <- bilateral_structure_assoc(dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",disorder, "_balanced_", sex)),
                             n_comparisons = length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "Subcortical Volume",
                             id_col = "f.eid")
    
      if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      subcortical_volume_assoc <- rbind(subcortical_volume_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                                                                   n_comparisons = length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "Subcortical Volume")
      )
      
      ## Adjust pvalues
      subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr")
    }
    
    ## Cortical Volume ----
    
    hemisphere_interactions <- hemisphere_interaction(dependent = cortical_volume_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",disorder, "_balanced_", sex)),
                           n_comparisons = length(cortical_volume_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Volume")
    
    cortical_volume_assoc <- bilateral_structure_assoc(dependent = cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",disorder, "_balanced_", sex)),
                             n_comparisons = length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "Cortical Regional Volume",
                             id_col = "f.eid")
    
    if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      cortical_volume_assoc <- rbind(cortical_volume_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                                                                   n_comparisons = length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "Cortical Regional Volume")
      )

      ## Adjust pvalues
      cortical_volume_assoc$p.adjust <- p.adjust.new(cortical_volume_assoc$p.value, method = "fdr")
    }
    
    
    cortical_volume_general_assoc <- unilateral_structure_assoc(dependent = cortical_volume_general,
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                             n_comparisons = length(cortical_volume_general) -1,
                             structural_subtype = "Cortical Volume Global and Lobal Measures")
    
    ## Cortical Thickness ----
    hemisphere_interactions <- hemisphere_interaction(dependent = cortical_thickness_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",disorder, "_balanced_", sex)),
                           n_comparisons = length(cortical_thickness_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Thickness")
    
    cortical_thickness_assoc <- bilateral_structure_assoc(dependent = cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",disorder, "_balanced_", sex)),
                             n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "Cortical Regional Thickness",
                             id_col = "f.eid")
    
    if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      cortical_thickness_assoc <- rbind(cortical_thickness_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                                                                   n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "Cortical Regional Thickness")
      )
      
      ## Adjust pvalues
      cortical_thickness_assoc$p.adjust <- p.adjust.new(cortical_thickness_assoc$p.value, method = "fdr")

    }
    
    cortical_thickness_general_assoc <- unilateral_structure_assoc(dependent = cortical_thickness_general,
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                            dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                             n_comparisons = length(cortical_thickness_general) -1,
                             structural_subtype = "Cortical Thickness Global and Lobal Measures")
    
    ## Cortical Area ----
    
    hemisphere_interactions <- hemisphere_interaction(dependent = cortical_area_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
                           n_comparisons = length(cortical_area_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Area")
    
    cortical_area_assoc <- bilateral_structure_assoc(dependent = cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",disorder, "_balanced_", sex)),
                             n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "Cortical Regional Area",
                             id_col = "f.eid")
    
    if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      cortical_area_assoc <- rbind(cortical_area_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                                                                   n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "Cortical Regional Area")
      )
      
      ## Adjust pvalues
      cortical_area_assoc$p.adjust <- p.adjust.new(cortical_area_assoc$p.value, method = "fdr")
    }
    
    cortical_area_general_assoc <- unilateral_structure_assoc(dependent = cortical_area_general,
                             independent = disorder,
                             covariates = brain_structure_covariates_T1_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                             n_comparisons = length(cortical_area_general) -1,
                             structural_subtype = "Cortical Area Global and Lobal Measures")
    ## FA ----
    
    hemisphere_interactions <- hemisphere_interaction(dependent = FA_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",disorder, "_balanced_", sex)),
                           n_comparisons = length(FA_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "FA Tracts")
    
    
    FA_bilateral_assoc <- bilateral_structure_assoc(dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",disorder, "_balanced_", sex)),
                             n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "FA Tracts",
                             id_col = "f.eid")
    
        if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      FA_bilateral_assoc <- rbind(FA_bilateral_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                                                                   n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "FA Tracts")
      )
      
      ## Adjust pvalues
      FA_bilateral_assoc$p.adjust <- p.adjust.new(FA_bilateral_assoc$p.value, method = "fdr")
    }
    
    
    FA_unilateral_assoc <- unilateral_structure_assoc(dependent = FA_unilateral,
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                             n_comparisons = length(FA_unilateral),
                             structural_subtype = "FA Tracts")
    
    
    FA_general_assoc <- unilateral_structure_assoc(dependent = FA_general,
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                             n_comparisons = length(FA_general) -1,
                             structural_subtype = "FA General Measures")
    
    ## MD ----
    
    hemisphere_interactions <- hemisphere_interaction(dependent = MD_bilateral,
                           independent = disorder,
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",disorder, "_balanced_", sex)),
                           n_comparisons = length(MD_bilateral),
                           hemisphere_col = "hemi",
                           structural_subtype = "MD Tracts")
    
    MD_bilateral_assoc <- bilateral_structure_assoc(dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions],
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",disorder, "_balanced_", sex)),
                             n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                             hemisphere_col = "hemi",
                             structural_subtype = "MD Tracts",
                             id_col = "f.eid")
    
        if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
      
      MD_bilateral_assoc <- rbind(MD_bilateral_assoc,
                                        unilateral_structure_assoc(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                   independent = disorder,
                                                                   covariates = brain_structure_covariates_T1_no_sex,
                                                                   dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                                                                   n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                                                                   structural_subtype = "MD Tracts")
      )
      
      ## Adjust pvalues
      MD_bilateral_assoc$p.adjust <- p.adjust.new(MD_bilateral_assoc$p.value, method = "fdr")
    }
    
    MD_unilateral_assoc <- unilateral_structure_assoc(dependent = MD_unilateral,
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                             n_comparisons = length(MD_unilateral),
                             structural_subtype = "MD Tracts")
    
    MD_general_assoc <- unilateral_structure_assoc(dependent = MD_general,
                             independent = disorder,
                             covariates = brain_structure_covariates_diffusion_no_sex,
                             dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",disorder, "_balanced_", sex)),
                             n_comparisons = length(MD_general) -1,
                             structural_subtype = "MD General Measures")
    
    ## Combine association results
    all_assoc <- do.call("rbind", list(subcortical_volume_assoc, cortical_volume_assoc, cortical_area_assoc, cortical_thickness_assoc, cortical_area_general_assoc, cortical_thickness_general_assoc, cortical_volume_general_assoc, FA_bilateral_assoc, FA_general_assoc, FA_unilateral_assoc, MD_bilateral_assoc, MD_general_assoc, MD_unilateral_assoc))
    
    ## Add column indicating disorder
    all_assoc$disorder  <- disorder
    
    ## append association analysis
    if (disorder == "chronic_pain"){
      assign(paste0("balanced_CP_MDD_structure_assoc_", sex), all_assoc)
    }else{
      assign(paste0("balanced_CP_MDD_structure_assoc_", sex) , rbind(get(paste0("balanced_CP_MDD_structure_assoc_", sex)), all_assoc))
    }
    paste("sex-stratified", disorder, "and brain strucutre association complete")
  }
}
```

## Carry out sex-stratified association for comorbidity groups sex-balanced datasets

```{r sex-stratified assocaition in comorbidity groups}

## Set CP-MDD- as reference group
UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_males$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_males$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") 
UKB_CP_MDD_imaging_covariates_CPMDD_balanced_males$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_CPMDD_balanced_males$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") 

UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_females$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_females$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") 
UKB_CP_MDD_imaging_covariates_CPMDD_balanced_females$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_CPMDD_balanced_females$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") 

for (sex in c("females", "males")){
  
  ## Subcortical Volume
  ## flag if any bilateral hemisphere measurements need to be analyzed separately
  hemisphere_interactions <- hemisphere_interaction_group(dependent = sub_cortical_volume_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                         n_comparisons = length(sub_cortical_volume_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Subcortical Volume")
  
  subcortical_volume_assoc <- bilateral_structure_assoc_group(dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                           n_comparisons = length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Subcortical Volume",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    subcortical_volume_assoc <- rbind(subcortical_volume_assoc,
                                      unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = "comorbidity_group",
                                                                 covariates = brain_structure_covariates_T1_no_sex,
                                                                 dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                                                                 n_comparisons = length(sub_cortical_volume_bilateral), ## Adjusted for after
                                                                 structural_subtype = "Subcortical Volume")
    )
    
    ## Adjust pvalues
    subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr")
  }
  
  ## Cortical Volume ----
  
  hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_volume_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                         n_comparisons = length(cortical_volume_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Volume")
  
  cortical_volume_assoc <- bilateral_structure_assoc_group(dependent = cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                           n_comparisons = length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Volume",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    cortical_volume_assoc <- rbind(cortical_volume_assoc,
                                      unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = "comorbidity_group",
                                                                 covariates = brain_structure_covariates_T1_no_sex,
                                                                 dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                                                                 n_comparisons = length(sub_cortical_volume_bilateral), ## Adjusted for after
                                                                 structural_subtype = "Cortical Regional Volume")
    )
    
    ## Adjust pvalues
    cortical_volume_assoc$p.adjust <- p.adjust.new(cortical_volume_assoc$p.value, method = "fdr")
  }
  
  
  cortical_volume_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_volume_general,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                           n_comparisons = length(cortical_volume_general) -1,
                           structural_subtype = "Cortical Volume Global and Lobal Measures")
  
  
  ## Cortical Thickness ----
  
  hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_thickness_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                         n_comparisons = length(cortical_thickness_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Thickness")
  
  cortical_thickness_assoc <- bilateral_structure_assoc_group(dependent = cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                           n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Thickness",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    cortical_thickness_assoc <- rbind(cortical_thickness_assoc,
                                      unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = "comorbidity_group",
                                                                 covariates = brain_structure_covariates_T1_no_sex,
                                                                 dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                                                                 n_comparisons = length(sub_cortical_thickness_bilateral), ## Adjusted for after
                                                                 structural_subtype = "Cortical Regional Thickness")
    )
    
    ## Adjust pvalues
    cortical_thickness_assoc$p.adjust <- p.adjust.new(cortical_thickness_assoc$p.value, method = "fdr")
  }
  
  cortical_thickness_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_thickness_general,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                           n_comparisons = length(cortical_thickness_general) -1,
                           structural_subtype = "Cortical Thickness Global and Lobal Measures")
  
  ## Cortical Area ----
  
  hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_area_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_T1_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                         n_comparisons = length(cortical_area_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "Cortical Regional Area")
  
  cortical_area_assoc <- bilateral_structure_assoc_group(dependent = cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                           n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "Cortical Regional Area",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    cortical_area_assoc <- rbind(cortical_area_assoc,
                                      unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                                                                 independent = "comorbidity_group",
                                                                 covariates = brain_structure_covariates_T1_no_sex,
                                                                 dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                                                                 n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after
                                                                 structural_subtype = "Cortical Regional Area")
    )
    
    ## Adjust pvalues
    cortical_area_assoc$p.adjust <- p.adjust.new(cortical_area_assoc$p.value, method = "fdr")
  }
  
  cortical_area_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_area_general,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_T1_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                           n_comparisons = length(cortical_area_general) -1,
                           structural_subtype = "Cortical Area Global and Lobal Measures")
  
  
  ##FA ----
  
  hemisphere_interactions <- hemisphere_interaction_group(dependent = FA_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_diffusion_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                         n_comparisons = length(FA_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "FA Tracts")
  
  
  FA_bilateral_assoc <- bilateral_structure_assoc_group(dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                           n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "FA Tracts",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    FA_bilateral_assoc <- rbind(FA_bilateral_assoc,
                          unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                          independent = "comorbidity_group",
                          covariates = brain_structure_covariates_T1_no_sex,
                          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                          n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after
                          structural_subtype = "FA Tracts")
    )
    
    ## Adjust pvalues
    FA_bilateral_assoc$p.adjust <- p.adjust.new(FA_bilateral_assoc$p.value, method = "fdr")
  }
  
  
  FA_unilateral_assoc <- unilateral_structure_assoc_group(dependent = FA_unilateral,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                           n_comparisons = length(FA_unilateral),
                           structural_subtype = "FA Tracts")
  
  
  FA_general_assoc <- unilateral_structure_assoc_group(dependent = FA_general,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                           n_comparisons = length(FA_general) -1,
                           structural_subtype = "FA General Measures")
  
  ##MD ----
  
  hemisphere_interactions <- hemisphere_interaction_group(dependent = MD_bilateral,
                         independent = "comorbidity_group",
                         covariates = brain_structure_covariates_diffusion_no_sex,
                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                         n_comparisons = length(MD_bilateral),
                         hemisphere_col = "hemi",
                         structural_subtype = "MD Tracts")
  
  MD_bilateral_assoc <- bilateral_structure_assoc_group(dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions],
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_CPMDD_balanced_",sex)),
                           n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
                           hemisphere_col = "hemi",
                           structural_subtype = "MD Tracts",
                           id_col = "f.eid")
  
  if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately
  
    MD_bilateral_assoc <- rbind(MD_bilateral_assoc,
                          unilateral_structure_assoc_group(dependent = paste0(hemisphere_interactions, c("_right", "_left")),
                          independent = "comorbidity_group",
                          covariates = brain_structure_covariates_T1_no_sex,
                          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                          n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after
                          structural_subtype = "MD Tracts")
    )
    
    ## Adjust pvalues
    MD_bilateral_assoc$p.adjust <- p.adjust.new(MD_bilateral_assoc$p.value, method = "fdr")
  }
  
  MD_unilateral_assoc <- unilateral_structure_assoc_group(dependent = MD_unilateral,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                           n_comparisons = length(MD_unilateral),
                           structural_subtype = "MD Tracts")
  
  MD_general_assoc <- unilateral_structure_assoc_group(dependent = MD_general,
                           independent = "comorbidity_group",
                           covariates = brain_structure_covariates_diffusion_no_sex,
                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_CPMDD_balanced_",sex)),
                           n_comparisons = length(MD_general) -1,
                           structural_subtype = "MD General Measures")
  
  ## Combine association results
  assign(paste0("balanced_comorbidity_structure_assoc_", sex), do.call("rbind", list(subcortical_volume_assoc, cortical_volume_assoc, cortical_area_assoc, cortical_thickness_assoc, cortical_area_general_assoc, cortical_thickness_general_assoc, cortical_volume_general_assoc, FA_bilateral_assoc, FA_general_assoc, FA_unilateral_assoc, MD_bilateral_assoc, MD_general_assoc, MD_unilateral_assoc)))
  
}

## Add column indicating disorder
balanced_comorbidity_structure_assoc_females$disorder<- "comorbidity"
balanced_comorbidity_structure_assoc_males$disorder<- "comorbidity"

```

## Save results

```{r Save output}
## Save output
write.csv(CP_MDD_structure_assoc_all, paste0(work_dir,"output/CP_MDD_structure_assoc_all.csv"), quote = FALSE, row.names = FALSE)

write.csv(CP_MDD_structure_assoc_females, paste0(work_dir,"output/CP_MDD_structure_assoc_females.csv"), quote = FALSE, row.names = FALSE)

write.csv(CP_MDD_structure_assoc_males, paste0(work_dir,"output/CP_MDD_structure_assoc_males.csv"), quote = FALSE, row.names = FALSE)

write.csv(balanced_CP_MDD_structure_assoc_females, paste0(work_dir,"output/balanced_CP_MDD_structure_assoc_females.csv"), quote = FALSE, row.names = FALSE)

write.csv(balanced_CP_MDD_structure_assoc_males, paste0(work_dir,"output/balanced_CP_MDD_structure_assoc_males.csv"), quote = FALSE, row.names = FALSE)

write.csv(comorbidity_structure_assoc_all, paste0(work_dir,"output/comorbidity_structure_assoc_all.csv"), quote = FALSE, row.names = FALSE)

write.csv(comorbidity_structure_assoc_females, paste0(work_dir,"output/comorbidity_structure_assoc_females.csv"), quote = FALSE, row.names = FALSE)

write.csv(comorbidity_structure_assoc_males, paste0(work_dir,"output/comorbidity_structure_assoc_males.csv"), quote = FALSE, row.names = FALSE)

write.csv(balanced_comorbidity_structure_assoc_females, paste0(work_dir,"output/balanced_comorbidity_structure_assoc_females.csv"), quote = FALSE, row.names = FALSE)

write.csv(balanced_comorbidity_structure_assoc_males, paste0(work_dir,"output/balanced_comorbidity_structure_assoc_males.csv"), quote = FALSE, row.names = FALSE)

write.csv(UKB_CP_MDD_demographics, paste0(work_dir,"output/UKB_CP_MDD_demographics.csv"), quote = FALSE, row.names = FALSE)

```






