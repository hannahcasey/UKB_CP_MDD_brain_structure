---
title: "CP_MDD_imaging_assoc"
author: "Hannah Casey"
date: "5/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## Load libraries
library(dplyr)
library(stringr)
library(nlme) #lme function
library(tidyr)
library(Hmisc)
library(emmeans)
library(lme4)
library(lmerTest)
library(htmlTable)
set.seed(151097)
```

## Load in data

Load in dataframes containing imaging data and covariate from UK Biobank (created using UKB_imaging_prep.R script).

```{r load in data, include = FALSE}

## Set working directory
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#work_dir <- ""
setwd(work_dir)

## Load in data
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Load dataframes containing imaging features of interest and covariates
UKB_imaging_covariates <- read.csv(paste0(work_dir, "/resources/UKB_imaging_covariates_qc.csv"), header = TRUE)

UKB_imaging_covariates_long <- read.csv(paste0(work_dir, "/resources/UKB_imaging_covariates_long_qc.csv"), header = TRUE)

## Load in chronic pain at imaging data
UKB_CP <- read.csv(paste0(work_dir,"/../UKB_chronic_pain_phenotype/output/UKB_chronic_pain_phenotype_imaging.csv"))

## Remame ID column, f_eid -> f_eid
UKB_CP <- UKB_CP %>% 
  dplyr::rename(f.eid = n_eid)

## Load in current deppresion at imaging data
UKB_Dep <- read.csv(paste0(work_dir, "/resources/UKB_current_depression_imaging.csv"), header = TRUE)

## Load in eligible participants and filter data
eligible_IDs <- read.csv(paste0(work_dir, "/resources/eligible.csv"), header = TRUE)

UKB_imaging_covariates <- UKB_imaging_covariates[UKB_imaging_covariates$f.eid %in% eligible_IDs$x,]
UKB_imaging_covariates_long <- UKB_imaging_covariates_long[UKB_imaging_covariates_long$f.eid %in% eligible_IDs$x,]
```

## Merge chronic pain and depression data with imaging dataset
```{r Merge CP and MDD data with imaging}
UKB_CP_MDD_imaging_covariates <-  left_join(UKB_imaging_covariates, UKB_CP, by = "f.eid")
UKB_CP_MDD_imaging_covariates <- left_join(UKB_CP_MDD_imaging_covariates, UKB_Dep, by = "f.eid")

UKB_CP_MDD_imaging_covariates_long <-  left_join(UKB_imaging_covariates_long, UKB_CP, by = "f.eid")
UKB_CP_MDD_imaging_covariates_long <- left_join(UKB_CP_MDD_imaging_covariates_long, UKB_Dep, by = "f.eid")

UKB_CP_MDD_imaging_covariates$sex[UKB_CP_MDD_imaging_covariates$sex == "Male"] <- 0
UKB_CP_MDD_imaging_covariates$sex[UKB_CP_MDD_imaging_covariates$sex == "Female"] <- 1
UKB_CP_MDD_imaging_covariates$sex <- as.numeric(UKB_CP_MDD_imaging_covariates$sex)
UKB_CP_MDD_imaging_covariates_long$sex[UKB_CP_MDD_imaging_covariates_long$sex == "Male"] <- 0
UKB_CP_MDD_imaging_covariates_long$sex[UKB_CP_MDD_imaging_covariates_long$sex == "Female"] <- 1
UKB_CP_MDD_imaging_covariates_long$sex <- as.numeric(UKB_CP_MDD_imaging_covariates_long$sex)
```

## Get baseline characteristics for each subgroup in analysis
```{r Get baseline characteristics}
UKB_CP_MDD_imaging_covariates_female <- subset(UKB_CP_MDD_imaging_covariates, sex == 1)
UKB_CP_MDD_imaging_covariates_male <- subset(UKB_CP_MDD_imaging_covariates, sex == 0)

n_full <- nrow(UKB_CP_MDD_imaging_covariates)
n_female <- nrow(UKB_CP_MDD_imaging_covariates_female)
n_male <- nrow(UKB_CP_MDD_imaging_covariates_male)

age_mean_full <- round(mean(UKB_CP_MDD_imaging_covariates$age_raw),2)
age_mean_female <- round(mean(UKB_CP_MDD_imaging_covariates_female$age_raw),2)
age_mean_male <- round(mean(UKB_CP_MDD_imaging_covariates_male$age_raw),2)
age_sd_full <- round(sd(UKB_CP_MDD_imaging_covariates$age_raw),2)
age_sd_female <- round(sd(UKB_CP_MDD_imaging_covariates_female$age_raw),2)
age_sd_male <- round(sd(UKB_CP_MDD_imaging_covariates_male$age_raw),2)

depression_n_full <- sum(UKB_CP_MDD_imaging_covariates$depression, na.rm = T)
depression_n_female <- sum(UKB_CP_MDD_imaging_covariates_female$depression, na.rm = T)
depression_n_male <- sum(UKB_CP_MDD_imaging_covariates_male$depression, na.rm = T)

depression_percent_full <- round(sum(UKB_CP_MDD_imaging_covariates$depression, na.rm = T)/sum(!is.na(UKB_CP_MDD_imaging_covariates$depression)) * 100,2)
depression_percent_female <- round(sum(UKB_CP_MDD_imaging_covariates_female$depression, na.rm = T)/sum(!is.na(UKB_CP_MDD_imaging_covariates_female$depression)) * 100,2)
depression_percent_male <- round(sum(UKB_CP_MDD_imaging_covariates_male$depression, na.rm = T)/sum(!is.na(UKB_CP_MDD_imaging_covariates_male$depression)) * 100,2)

chronic_pain_n_full <- sum(UKB_CP_MDD_imaging_covariates$chronic_pain_status, na.rm = T)
chronic_pain_n_female <- sum(UKB_CP_MDD_imaging_covariates_female$chronic_pain_status, na.rm = T)
chronic_pain_n_male <- sum(UKB_CP_MDD_imaging_covariates_male$chronic_pain_status, na.rm = T)

chronic_pain_percent_full <- round(sum(UKB_CP_MDD_imaging_covariates$chronic_pain_status == 1, na.rm = T)/sum(!is.na(UKB_CP_MDD_imaging_covariates$chronic_pain_status)) * 100,2)
chronic_pain_percent_female <- round(sum(UKB_CP_MDD_imaging_covariates_female$chronic_pain_status == 1, na.rm = T)/sum(!is.na(UKB_CP_MDD_imaging_covariates_female$chronic_pain_status)) * 100,2)
chronic_pain_percent_male <- round(sum(UKB_CP_MDD_imaging_covariates_male$chronic_pain_status == 1, na.rm = T)/sum(!is.na(UKB_CP_MDD_imaging_covariates_male$chronic_pain_status)) * 100,2)

comorbid_n_full <- sum(UKB_CP_MDD_imaging_covariates$chronic_pain_status == 1 & UKB_CP_MDD_imaging_covariates$depression == 1, na.rm = T)
comorbid_n_female <- sum(UKB_CP_MDD_imaging_covariates_female$chronic_pain_status == 1 & UKB_CP_MDD_imaging_covariates_female$depression == 1, na.rm = T)
comorbid_n_male <- sum(UKB_CP_MDD_imaging_covariates_male$chronic_pain_status == 1 & UKB_CP_MDD_imaging_covariates_male$depression == 1, na.rm = T)

comorbid_percent_full <- round(sum(UKB_CP_MDD_imaging_covariates$chronic_pain_status == 1 & UKB_CP_MDD_imaging_covariates$depression == 1, na.rm = T)/sum(!is.na(UKB_CP_MDD_imaging_covariates$chronic_pain_status) & !is.na(UKB_CP_MDD_imaging_covariates$depression)) * 100,2)

comorbid_percent_female <- round(sum(UKB_CP_MDD_imaging_covariates_female$chronic_pain_status == 1 & UKB_CP_MDD_imaging_covariates_female$depression == 1, na.rm = T)/sum(!is.na(UKB_CP_MDD_imaging_covariates_female$chronic_pain_status) & !is.na(UKB_CP_MDD_imaging_covariates_female$chronic_pain_status)) * 100,2)

comorbid_percent_male <- round(sum(UKB_CP_MDD_imaging_covariates_male$chronic_pain_status == 1 & UKB_CP_MDD_imaging_covariates_male$depression == 1, na.rm = T)/sum(!is.na(UKB_CP_MDD_imaging_covariates_male$chronic_pain_status) & !is.na(UKB_CP_MDD_imaging_covariates_male$depression)) * 100,2)


descriptives_df <- data.frame(
  Variables = c("Mean Age (SD)", "Depression (%)",  "Chronic Pain (%)", "Comorbid Chronic Pain and Depression (%)"), 
  full_temp = c(
    paste0(age_mean_full, " (", age_sd_full, ")"), ## Age full sample
    paste0(txtInt(depression_n_full), " (", depression_percent_full,  "%)"), ## Depression full sample
    paste0(txtInt(chronic_pain_n_full), " (", chronic_pain_percent_full, "%)"), ## Chronic pain full sample
    paste0(txtInt(comorbid_n_full), " (", comorbid_percent_full,  "%)") ## Comorbidity in full sample
    ),
  female_temp = c(
    paste0(age_mean_female, " (", age_sd_female, ")"), ## Age female sample
    paste0(txtInt(depression_n_female), " (", depression_percent_female, "%)"), ## Depression female sample
    paste0(txtInt(chronic_pain_n_female), " (", chronic_pain_percent_female, "%)"), ## Chronic pain female sample
    paste0(txtInt(comorbid_n_female), " (", comorbid_percent_female, "%)") ## Comorbidity in female sample
    ),
  male_temp = c(
    paste0(age_mean_male, " (", age_sd_male, ")"), ## Age male sample
    paste0(txtInt(depression_n_male), " (", depression_percent_male, "%)"), ## Depression male sample
    paste0(txtInt(chronic_pain_n_male), " (", chronic_pain_percent_male, "%)"), ## Chronic pain male sample
    paste0(txtInt(comorbid_n_male), " (", comorbid_percent_male, "%)") ## Comorbidity in male sample
    ))


names(descriptives_df) <- c("Variables", paste0("Full sample (n = ",txtInt(n_full), ")"), paste0("Female sample (n = ",txtInt(n_female), ")"), paste0("Male sample (n = ",txtInt(n_male), ")"))
```

## Define functions to carry out association and interaction analyses
```{r Functions for statistcial analysis}

## Create functions to carry out association analysis and hemisphere interaction analysis
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Function to adjust p.values if dataframes with more rows than comparisons being made
p.adjust.new <- function (p, method = p.adjust.methods, n = length(p)) 
{
    method <- match.arg(method)
    if (method == "fdr") 
        method <- "BH"
    nm <- names(p)
    p <- as.numeric(p)
    p0 <- setNames(p, nm)
    if (all(nna <- !is.na(p))) 
        nna <- TRUE
    else p <- p[nna]
    lp <- length(p)
    #stopifnot(n >= lp)
    if (n <= 1) 
        return(p0)
    if (n == 2 && method == "hommel") 
        method <- "hochberg"
    p0[nna] <- switch(method, bonferroni = pmin(1, n * p), holm = {
        i <- seq_len(lp)
        o <- order(p)
        ro <- order(o)
        pmin(1, cummax((n + 1L - i) * p[o]))[ro]
    }, hommel = {
        if (n > lp) p <- c(p, rep.int(1, n - lp))
        i <- seq_len(n)
        o <- order(p)
        p <- p[o]
        ro <- order(o)
        q <- pa <- rep.int(min(n * p/i), n)
        for (j in (n - 1L):2L) {
            ij <- seq_len(n - j + 1L)
            i2 <- (n - j + 2L):n
            q1 <- min(j * p[i2]/(2L:j))
            q[ij] <- pmin(j * p[ij], q1)
            q[i2] <- q[n - j + 1L]
            pa <- pmax(pa, q)
        }
        pmax(pa, p)[if (lp < n) ro[1L:lp] else ro]
    }, hochberg = {
        i <- lp:1L
        o <- order(p, decreasing = TRUE)
        ro <- order(o)
        pmin(1, cummin((n + 1L - i) * p[o]))[ro]
    }, BH = {
        i <- lp:1L
        o <- order(p, decreasing = TRUE)
        ro <- order(o)
        pmin(1, cummin(n/i * p[o]))[ro]
    }, BY = {
        i <- lp:1L
        o <- order(p, decreasing = TRUE)
        ro <- order(o)
        q <- sum(1/(1L:n))
        pmin(1, cummin(q * n/i * p[o]))[ro]
    }, none = p)
    p0
}

## Function to analyze unilateral brain structures 
unilateral_structure_assoc <- function(dependent, independent, covariates, dataset, n_comparisons, structural_subtype){
  
  ## Input:
  ## dependent: names of dependent variables
  ## independent: name of independent variable
  ## covariates: array of covariates
  ## dataset: df contating data
  ## n_comparisons: number of multiple comparisons to account for
  ## structural_subtype: name of structural subtype being analysed
  
  ## Create dataframe to store association analysis output
  output <-  data.frame(brain_phenotype=character(), beta=numeric(), std=numeric(), p.value=numeric(),
                                             p.adjust=numeric(), Lower_95CI=numeric(), Upper_95CI=numeric())
  
  for (i in 1:length(dependent)){
    
    mod <- paste0(dependent[i], "~", independent,  "+" ,  paste(covariates, collapse = " + "))
    glm1 <- glm(as.formula(mod),
                data = dataset,
                na.action = na.exclude)
    
    output[i,"brain_phenotype"] <- dependent[i]
    output[i, "beta"] <- summary(glm1)[["coefficients"]][independent, "Estimate"]
    output[i, "std"] <- summary(glm1)[["coefficients"]][independent, "Std. Error"]
    output[i, "p.value"] <- summary(glm1)[["coefficients"]][independent, "Pr(>|t|)"]
    output[i, c("Lower_95CI", "Upper_95CI")] <- confint(glm1)[independent,]
  }
  
  ## Adjust p-value
  output$p.adjust[!grepl("global|Global", output$brain_phenotype)] <- p.adjust.new(output$p.value[!grepl("global|Global", output$brain_phenotype)], method = "fdr", n = n_comparisons)
  
  ## Do not adjust global measures
  output$p.adjust[grepl("global|Global", output$brain_phenotype)] <- output$p.value[grepl("global|Global", output$brain_phenotype)]
  
  ## Add column indicating brain strucutre sup type being analysed
  output$brain_structure_type <- structural_subtype
    
  return(output)
}

## Function to analyze hemisphere interaction
hemisphere_interaction <- function(dependent, independent, covariates, dataset, hemisphere_col, structural_subtype, interaction_terms = NULL, sex_interaction = FALSE, sex_variable = "sex"){
  
  ## Input:
  ## dependent: names of dependent variables
  ## independent: name of independent variable
  ## covariates: array of covariates
  ## dataset: df contating data
  ## hemisphere_col: name of hemisphere column
  ## structural_subtype: name of structural subtype being analysed
  
  ## Create dataframe to store interaction analysis output
  output <- data.frame(interaction_p=numeric())
  ## Run interaction analysis
  for (i in dependent){
    
    if (!is.null(interaction_terms) && length(interaction_terms) > 0) {  ## If interaction terms supplied, add to model
      if (sex_interaction) {  ## If sex interaction, model covariates separately by sex
        mod <- paste0(
          "`", i, "` ~ ", independent, " * ", paste(c(interaction_terms, hemisphere_col), collapse = " * "), " + ",
          paste(covariates, "*", sex_variable, collapse = " + ")
        )
      } else {
        mod <- paste0(
          "`", i, "` ~ ", independent, " * ", paste(c(interaction_terms, hemisphere_col), collapse = " * "), " + ",
          paste(covariates, collapse = " + ")
        )
      }
      ## String to index model output
      index_string <- paste0(c(independent, interaction_terms, hemisphere_col), collapse = ":")  
    } else {  ## If no interaction terms provided
      mod <- paste0(
        "`", i, "` ~ ", independent, " + ", independent, " * ", hemisphere_col, " + ", paste(covariates, collapse = " + ")
      )
      ## String to index model output
      index_string <- paste0(c(independent, hemisphere_col), collapse = ":")  
    }
    
    ## Carry out interaction analysis
    lm1 <- glm(mod, data = dataset)
  
    output[i,"interaction_p"] <- summary(lm1)[["coefficients"]][index_string, "Pr(>|t|)"]
    
  }
  
  ## If statement to notify if any significant interactions are present
  if (any(output$interaction_p < 0.05)){
    return(row.names(output)[output$interaction_p < 0.05])
  }else{
  }
}

## Function to analyze bilateral brain structures
bilateral_structure_assoc <- function(dependent, independent, covariates, dataset, n_comparisons, hemisphere_col, id_col, structural_subtype){
  
  ## Input:
  ## dependent: names of dependent variables
  ## independent: name of independent variable
  ## covariates: array of covariates
  ## dataset: df contating data
  ## n_comparisons: number of multiple comparisons to account for
  ## hemisphere_col: name of hemisphere column
  ## id_col: name of ID column
  ## structural_subtype: name of structural subtype being analysed
  
  ## Create dataframe to store association analysis output
  output <-  data.frame(brain_phenotype=character(), beta=numeric(), std=numeric(), p.value=numeric(),
                        p.adjust=numeric(), Lower_95CI=numeric(), Upper_95CI=numeric())
  
  ## Run association analysis using lme
  for (i in 1:length(dependent)){
    
    mod <- paste0("`",dependent[i],"`","~", independent , "+", paste(covariates, collapse = " + "),"+", hemisphere_col ," +(1 |" , id_col,")")
    
    lme1 <- lmerTest::lmer(as.formula(as.character(mod)),data=dataset,
                 na.action=na.exclude)
    
    
    output[i,"brain_phenotype"] <- dependent[i]
    output[i, "beta"] <- summary(lme1)[["coefficients"]][independent, "Estimate"]
    output[i, "std"] <- summary(lme1)[["coefficients"]][independent, "Std. Error"]
    output[i, "p.value"] <- 2*pt(-abs(summary(lme1)[["coefficients"]][independent, "t value"]),df=(nobs(lme1)/2)-1) #calculate p-value from t-value
    output[i, c("Lower_95CI", "Upper_95CI")] <- confint(lme1)[independent,]
  }
  
  ## Adjust p-value
  output$p.adjust <- p.adjust.new(output$p.value, method = "fdr", n = n_comparisons)
  
  ## Add column indicating brain strucutre sup type being analysed
  output$brain_structure_type <- structural_subtype
  
  return(output)
}

## Functions to analyze interactions in bilateral brain structures
bilateral_interaction <- function(dependent, independent, interaction_terms, covariates, dataset, hemisphere_col, id_col, structural_subtype, sex_interaction, sex_variable){
  
  ## Input:
  ## dependent: names of dependent variables
  ## independent: name of independent variable
  ## interaction_terms: names of interaction variables
  ## covariates: array of covariates
  ## dataset: df contating data
  ## hemisphere_col: name of hemisphere column
  ## id_col: name of ID column
  ## structural_subtype: name of structural subtype being analysed
  ## sex_interaction: if sex interaction analysis
  
  ## Create dataframe to store interaction analysis output
  output <- data.frame()
  ## Run interaction analysis
  for (i in dependent){

    ## Model covariates separately for males and females if sex-interaction is being analysed
    if (sex_interaction){
      mod <- as.formula(paste0(
        i, "~", independent, "*", paste0(interaction_terms, collapse = "*"), "+",  
        paste0(c(covariates, hemisphere_col), "*", sex_variable, collapse = " + "), "+", 
        "(1 |", id_col, ")"))
     } else{
      mod <- as.formula(paste0(
        i, "~", independent, "*", paste0(interaction_terms, collapse = "*"), "+", 
        paste0(c(covariates, hemisphere_col), collapse = " + "), "+", 
        "(1 |", id_col, ")"))
     }
    
    index_string <- paste0(c(independent,interaction_terms), collapse = ":")
     
    ## Interaction analysis
    lme1 <- lmerTest::lmer(mod,data=dataset,
                       na.action=na.exclude)

    ## Extract output
    index <- grepl(index_string,rownames(summary(lme1)[["coefficients"]]))
    
    output[i,"interaction"] <- row.names(summary(lme1)[["coefficients"]])[index]
    output[i,"brain_phenotype"] <- i
    output[i,"disorder"] <- independent
    output[i,"beta"] <- summary(lme1)[["coefficients"]][index, "Estimate"]
    output[i,"std"] <- summary(lme1)[["coefficients"]][index, "Std. Error"]
    output[i,"p.value"] <- summary(lme1)[["coefficients"]][index, "Pr(>|t|)"]
  }
  
    ## Add column indicating brain strucutre sup type being analysed
    output$brain_structure_type <- structural_subtype
  
    return(output)
}

unilateral_interaction <- function(dependent, independent, interaction_terms, covariates, dataset, structural_subtype, sex_interaction, sex_variable){
  
  ## Input:
  ## dependent: names of dependent variables
  ## independent: name of independent variable
  ## interaction_terms: names of interaction variables
  ## covariates: array of covariates
  ## dataset: df contating data
  ## structural_subtype: name of structural subtype being analysed
  ## sex_interaction: if sex interaction analysis

  ## Create dataframe to store interaction analysis output
  output <- data.frame()
  ## Run interaction analysis
  for (i in dependent){
    
    ## Define formula
        ## Model covariates separately for males and females if sex-interaction is being analysed
    if (sex_interaction){
      mod <- as.formula(paste0(
        i, "~", independent, "*", paste0(interaction_terms, collapse = "*"), "+",  
        paste0(covariates, "*", sex_variable, collapse = " + ")
        ))
     } else{
       mod <- as.formula(paste(
         i, "~", independent, "*", paste0(interaction_terms, collapse = "*"), "+", 
         paste(covariates, collapse = " + ")
         ))
     }
    
    index_string <- paste0(c(independent,interaction_terms), collapse = ":")

    ## Interaction analysis
    glm1 <- glm(mod,
                data = dataset,
                na.action = na.exclude)
    
    ## Extract output
    index <- grepl(index_string,rownames(summary(glm1)[["coefficients"]]))
    
    output[i,"interaction"] <- row.names(summary(glm1)[["coefficients"]])[index]
    output[i,"brain_phenotype"] <- i
    output[i,"disorder"] <- independent
    output[i, "beta"] <- summary(glm1)[["coefficients"]][index, "Estimate"]
    output[i, "std"] <- summary(glm1)[["coefficients"]][index, "Std. Error"]
    output[i, "p.value"] <- summary(glm1)[["coefficients"]][index, "Pr(>|t|)"]
    
  }
  
  ## Add column indicating brain strucutre sup type being analysed
  output$brain_structure_type <- structural_subtype
  
  return(output)
}
```

## Define association analysis inputs
```{r define association analysis input}
## Define covariates to be used in association analysis
brain_structure_covariates_T1 <- c("sex", "age", "age_squared", "ICV", "assessment_centre_first_imaging", "X_position", "Y_position", "Z_position")
brain_structure_covariates_diffusion <- c("sex", "age", "age_squared", "assessment_centre_first_imaging", "X_position", "Y_position", "Z_position")

## Define subsets of brain structure variables
## General cortical measures
cortical_volume_general <- grep("volume.*lobe|volume.*global", names(UKB_imaging_covariates), value = TRUE)
cortical_area_general <- grep("area.*lobe|area.*global", names(UKB_imaging_covariates), value = TRUE)
cortical_thickness_general <- grep("thickness.*lobe|thickness.*global", names(UKB_imaging_covariates), value = TRUE)

## SubCortical Regional Volume
sub_cortical_volume_bilateral <- grep("sub_cortical.*left|sub_cortical.*right", names(UKB_imaging_covariates), value = TRUE)

## Regional cortical measures
temp <- grep("volume.*left|volume.*right", names(UKB_imaging_covariates), value = TRUE)
cortical_volume_bilateral <- temp[!temp %in% sub_cortical_volume_bilateral]
cortical_volume_bilateral <- cortical_volume_bilateral[!grepl("sub_cortical", cortical_volume_bilateral)]

cortical_area_bilateral <- grep("area.*left|area.*right", names(UKB_imaging_covariates), value = TRUE)
cortical_thickness_bilateral <- grep("thickness.*left|thickness.*right", names(UKB_imaging_covariates), value = TRUE)

## Individual bilateral FA tracts
FA_bilateral <- grep("FA.*left|FA.*right", names(UKB_imaging_covariates), value = TRUE)

## Individual bilateral MD tracts
MD_bilateral <- grep("MD.*left|MD.*right", names(UKB_imaging_covariates), value = TRUE)

## Individual unilateral FA tracts
FA_unilateral <- c("FA_forceps_major", "FA_forceps_minor", "FA_middle_cerebellar_peduncle")

## Individual unilateral MD tracts
MD_unilateral <- c("MD_forceps_major", "MD_forceps_minor", "MD_middle_cerebellar_peduncle")

## General FA measures
FA_general <- c("FA_global", "FA_association_fibres", "FA_thalamic_radiations", "FA_projection_fibres")

## General MD measures
MD_general <- c("MD_global", "MD_association_fibres", "MD_thalamic_radiations", "MD_projection_fibres")

## Remove hemishpere indicator from long formatted (bilateral) measures as hemiphere indicated in column
sub_cortical_volume_bilateral <- unique(gsub("_left|_right", "", sub_cortical_volume_bilateral))
cortical_volume_bilateral <- unique(gsub("_left|_right", "", cortical_volume_bilateral))
cortical_thickness_bilateral <- unique(gsub("_left|_right", "", cortical_thickness_bilateral))
cortical_area_bilateral <- unique(gsub("_left|_right", "", cortical_area_bilateral))
FA_bilateral <- unique(gsub("_left|_right", "", FA_bilateral))
MD_bilateral <- unique(gsub("_left|_right", "", MD_bilateral))

```

## Check class and range of covariates
```{r Class and range of covariates}
lapply(UKB_CP_MDD_imaging_covariates_long[,brain_structure_covariates_T1], class)
lapply(UKB_CP_MDD_imaging_covariates_long[,brain_structure_covariates_T1], summary)
```

## Carry out association analysis
```{r association analysis}
for (disorder in c("chronic_pain_status", "depression", "depression_sensitivity")) {

  ## Subcortical Volume ----
  ## Flag if any bilateral hemisphere measurements need to be analyzed separately
  hemisphere_interactions <- hemisphere_interaction(
    dependent = sub_cortical_volume_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Subcortical Volume"
  )

  subcortical_volume_assoc <- bilateral_structure_assoc(
    dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions],
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    n_comparisons = length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
    hemisphere_col = "hemi",
    structural_subtype = "Regional Subcortical Volume",
    id_col = "f.eid"
  )

  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    subcortical_volume_assoc <- rbind(
      subcortical_volume_assoc,
      unilateral_structure_assoc(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        covariates = brain_structure_covariates_T1,
        dataset = UKB_CP_MDD_imaging_covariates,
        n_comparisons = length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
        structural_subtype = "Regional Subcortical Volume"
      )
    )

    ## Apply multiple comparison correction
    subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr")
  }

  ## Cortical Volume ----
  hemisphere_interactions <- hemisphere_interaction(
    dependent = cortical_volume_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Volume"
  )

  cortical_volume_assoc <- bilateral_structure_assoc(
    dependent = cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions],
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    n_comparisons = length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Volume",
    id_col = "f.eid"
  )

  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    cortical_volume_assoc <- rbind(
      cortical_volume_assoc,
      unilateral_structure_assoc(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        covariates = brain_structure_covariates_T1,
        dataset = UKB_CP_MDD_imaging_covariates,
        n_comparisons = length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
        structural_subtype = "Regional Cortical Volume"
      )
    )

    ## Apply multiple comparison correction
    cortical_volume_assoc$p.adjust <- p.adjust.new(cortical_volume_assoc$p.value, method = "fdr")
  }

  cortical_volume_general_assoc <- unilateral_structure_assoc(
    dependent = cortical_volume_general,
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates,
    n_comparisons = length(cortical_volume_general) - 1,
    structural_subtype = "Global and Lobal Cortical Volume"
  )

  ## Cortical Thickness ----
  hemisphere_interactions <- hemisphere_interaction(
    dependent = cortical_thickness_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Thickness"
  )

  cortical_thickness_assoc <- bilateral_structure_assoc(
    dependent = cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions],
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Thickness",
    id_col = "f.eid"
  )

  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    cortical_thickness_assoc <- rbind(
      cortical_thickness_assoc,
      unilateral_structure_assoc(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        covariates = brain_structure_covariates_T1,
        dataset = UKB_CP_MDD_imaging_covariates,
        n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
        structural_subtype = "Regional Cortical Thickness"
      )
    )

    ## Apply multiple comparison correction
    cortical_thickness_assoc$p.adjust <- p.adjust.new(cortical_thickness_assoc$p.value, method = "fdr")
  }

  cortical_thickness_general_assoc <- unilateral_structure_assoc(
    dependent = cortical_thickness_general,
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates,
    n_comparisons = length(cortical_thickness_general) - 1,
    structural_subtype = "Global and Lobal Cortical Thickness"
  )

  ## Cortical Area ----
  hemisphere_interactions <- hemisphere_interaction(
    dependent = cortical_area_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Area"
  )

  cortical_area_assoc <- bilateral_structure_assoc(
    dependent = cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions],
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Area",
    id_col = "f.eid"
  )

  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    cortical_area_assoc <- rbind(
      cortical_area_assoc,
      unilateral_structure_assoc(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        covariates = brain_structure_covariates_T1,
        dataset = UKB_CP_MDD_imaging_covariates,
        n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
        structural_subtype = "Regional Cortical Area"
      )
    )

    ## Apply multiple comparison correction
    cortical_area_assoc$p.adjust <- p.adjust.new(cortical_area_assoc$p.value, method = "fdr")
  }

  cortical_area_general_assoc <- unilateral_structure_assoc(
    dependent = cortical_area_general,
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates,
    n_comparisons = length(cortical_area_general) - 1,
    structural_subtype = "Global and Lobal Cortical Area"
  )
  
  
  ## Combine association results
  all_assoc <- do.call(
    "rbind",
    list(
      subcortical_volume_assoc, cortical_volume_assoc,
      cortical_thickness_assoc, cortical_volume_general_assoc
    )
  )
  
  ## FA ----
  
  ## Flag if any bilateral hemisphere measurements need to be analyzed separately
  hemisphere_interactions <- hemisphere_interaction(
    dependent = FA_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_diffusion,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Fractional Anisotropy"
  )
  
  FA_bilateral_assoc <- bilateral_structure_assoc(
    dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions],
    independent = disorder,
    covariates = brain_structure_covariates_diffusion,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
    hemisphere_col = "hemi",
    structural_subtype = "Fractional Anisotropy",
    id_col = "f.eid"
  )
  
  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    FA_bilateral_assoc <- rbind(
      FA_bilateral_assoc,
      unilateral_structure_assoc(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        covariates = brain_structure_covariates_T1,
        dataset = UKB_CP_MDD_imaging_covariates,
        n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
        structural_subtype = "Fractional Anisotropy"
      )
    )
  
    ## Apply multiple comparison correction
    FA_bilateral_assoc$p.adjust <- p.adjust.new(FA_bilateral_assoc$p.value, method = "fdr")
  }
  
  FA_unilateral_assoc <- unilateral_structure_assoc(
    dependent = FA_unilateral,
    independent = disorder,
    covariates = brain_structure_covariates_diffusion,
    dataset = UKB_CP_MDD_imaging_covariates,
    n_comparisons = length(FA_unilateral),
    structural_subtype = "Fractional Anisotropy"
  )
  
  FA_general_assoc <- unilateral_structure_assoc(
    dependent = FA_general,
    independent = disorder,
    covariates = brain_structure_covariates_diffusion,
    dataset = UKB_CP_MDD_imaging_covariates,
    n_comparisons = length(FA_general) - 1,
    structural_subtype = "General Fractional Anisotropy"
  )
  
  ## MD ----
  
  ## Flag if any bilateral hemisphere measurements need to be analyzed separately
  hemisphere_interactions <- hemisphere_interaction(
    dependent = MD_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_diffusion,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Mean Diffusivity"
  )
  
  MD_bilateral_assoc <- bilateral_structure_assoc(
    dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions],
    independent = disorder,
    covariates = brain_structure_covariates_diffusion,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
    hemisphere_col = "hemi",
    structural_subtype = "Mean Diffusivity",
    id_col = "f.eid"
  )
  
  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    MD_bilateral_assoc <- rbind(
      MD_bilateral_assoc,
      unilateral_structure_assoc(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        covariates = brain_structure_covariates_T1,
        dataset = UKB_CP_MDD_imaging_covariates,
        n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2),
        structural_subtype = "Mean Diffusivity"
      )
    )
  
    ## Apply multiple comparison correction
    subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr")
  }
  
  MD_unilateral_assoc <- unilateral_structure_assoc(
    dependent = MD_unilateral,
    independent = disorder,
    covariates = brain_structure_covariates_diffusion,
    dataset = UKB_CP_MDD_imaging_covariates,
    n_comparisons = length(MD_unilateral),
    structural_subtype = "Mean Diffusivity"
  )
  
  MD_general_assoc <- unilateral_structure_assoc(
    dependent = MD_general,
    independent = disorder,
    covariates = brain_structure_covariates_diffusion,
    dataset = UKB_CP_MDD_imaging_covariates,
    n_comparisons = length(MD_general) - 1,
    structural_subtype = "General Mean Diffusivity"
  )

   ## Combine association results
  all_assoc <- do.call(
    "rbind", list(
      subcortical_volume_assoc, cortical_volume_assoc, cortical_area_assoc,
      cortical_thickness_assoc, cortical_area_general_assoc, cortical_thickness_general_assoc,
      cortical_volume_general_assoc, FA_bilateral_assoc, FA_general_assoc, FA_unilateral_assoc,
      MD_bilateral_assoc, MD_general_assoc, MD_unilateral_assoc
      ))
 
  ## Add column indicating disorder
  all_assoc$disorder <- disorder

  if (disorder == "chronic_pain_status") {
    CP_MDD_structure_assoc_all <- all_assoc
  } else {
    CP_MDD_structure_assoc_all <- rbind(CP_MDD_structure_assoc_all, all_assoc)
  }

  paste(disorder, "and brain structure association complete")
}

```

## Carry out sex interaction analysis 
```{r sex interaction analysis}
## Carry out sex interaction analysis  

## Remove sex as a covariate  
brain_structure_covariates_T1_no_sex <- brain_structure_covariates_T1[brain_structure_covariates_T1 != "sex"]
brain_structure_covariates_diffusion_no_sex <- brain_structure_covariates_diffusion[brain_structure_covariates_diffusion != "sex"]

for (disorder in c("chronic_pain_status", "depression", "depression_sensitivity")) {

  ## Subcortical Volume ----
  ## Flag if any bilateral hemisphere measurements need to be analyzed separately
  hemisphere_interactions <- hemisphere_interaction(
    dependent = sub_cortical_volume_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Subcortical Volume", 
    interaction_terms = "sex", 
    sex_interaction = TRUE, 
    sex_variable = "sex"
  )

  subcortical_volume_sex_interaction <- bilateral_interaction(
    dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions],
    independent = disorder,  
    interaction_terms = "sex", 
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_T1_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Subcortical Volume",
    id_col = "f.eid"
  )

  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    subcortical_volume_sex_interaction <- rbind(
      subcortical_volume_sex_interaction,
      unilateral_interaction(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        sex_variable = "sex",
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = UKB_CP_MDD_imaging_covariates,
        structural_subtype = "Regional Subcortical Volume"
      )
    )
  }

  ## Cortical Volume ----
  hemisphere_interactions <- hemisphere_interaction(
    dependent = cortical_volume_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Volume",
    interaction_terms = "sex", 
    sex_interaction = TRUE, 
    sex_variable = "sex"
  )

  cortical_volume_sex_interaction <- bilateral_interaction(
    dependent = cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions],
    independent = disorder, 
    interaction_terms =  "sex", 
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_T1_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Volume",
    id_col = "f.eid"
  )

  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    cortical_volume_sex_interaction <- rbind(
      cortical_volume_sex_interaction,
      unilateral_interaction(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        interaction_terms =  "sex", 
        sex_interaction = TRUE, 
        sex_variable = "sex",
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = UKB_CP_MDD_imaging_covariates,
        structural_subtype = "Regional Cortical Volume"
      )
    )
  }

  cortical_volume_general_sex_interaction <- unilateral_interaction(
    dependent = cortical_volume_general,
    independent = disorder, 
    interaction_terms = "sex",
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_T1_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates,
    structural_subtype = "Global and Lobal Cortical Volume"
  )

  ## Cortical Thickness ----
  hemisphere_interactions <- hemisphere_interaction(
    dependent = cortical_thickness_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Thickness",
    interaction_terms = "sex", 
    sex_interaction = TRUE, 
    sex_variable = "sex"
  )

  cortical_thickness_sex_interaction <- bilateral_interaction(
    dependent = cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions],
    independent = disorder,
    interaction_terms = "sex",
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_T1_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Thickness",
    id_col = "f.eid"
  )

  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    cortical_thickness_sex_interaction <- rbind(
      cortical_thickness_sex_interaction,
      unilateral_interaction(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        interaction_terms = "sex",
        sex_interaction = TRUE, 
        sex_variable = "sex",
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = UKB_CP_MDD_imaging_covariates,
        structural_subtype = "Regional Cortical Thickness"
      )
    )
  }

  cortical_thickness_general_sex_interaction <- unilateral_interaction(
    dependent = cortical_thickness_general,
    independent = disorder,
    interaction_terms = "sex",
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_T1_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates,
    structural_subtype = "Global and Lobal Cortical Thickness"
  )

  ## Cortical Area ----
  hemisphere_interactions <- hemisphere_interaction(
    dependent = cortical_area_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_T1,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Area", 
    interaction_terms = "sex", 
    sex_interaction = TRUE, 
    sex_variable = "sex"
  )

  cortical_area_sex_interaction <- bilateral_interaction(
    dependent = cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions],
    independent = disorder,
    interaction_terms = "sex",
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_T1_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Regional Cortical Area",
    id_col = "f.eid"
  )

  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    cortical_area_sex_interaction <- rbind(
      cortical_area_sex_interaction,
      unilateral_interaction(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        interaction_terms = "sex",
        sex_interaction = TRUE, 
        sex_variable = "sex",
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = UKB_CP_MDD_imaging_covariates,
        structural_subtype = "Regional Cortical Area"
      )
    )
  }

  cortical_area_general_sex_interaction <- unilateral_interaction(
    dependent = cortical_area_general,
    independent = disorder,
    interaction_terms = "sex",
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_T1_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates,
    structural_subtype = "Global and Lobal Cortical Area"
  )

  ## FA ----
  hemisphere_interactions <- hemisphere_interaction(
    dependent = FA_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_diffusion,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Fractional Anisotropy",
    interaction_terms = "sex", 
    sex_interaction = TRUE, 
    sex_variable = "sex"
  )

  FA_bilateral_sex_interaction <- bilateral_interaction(
    dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions],
    independent = disorder,
    interaction_terms = "sex",
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_diffusion_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Fractional Anisotropy",
    id_col = "f.eid"
  )

  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    FA_bilateral_sex_interaction <- rbind(
      FA_bilateral_sex_interaction,
      unilateral_interaction(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        interaction_terms = "sex",
        sex_interaction = TRUE, 
        sex_variable = "sex",
        covariates = brain_structure_covariates_diffusion_no_sex,
        dataset = UKB_CP_MDD_imaging_covariates,
        structural_subtype = "Fractional Anisotropy"
      )
    )
  }

  FA_sex_interaction <- rbind(
    FA_bilateral_sex_interaction,
      unilateral_interaction(
      dependent = FA_unilateral,
      independent = disorder,
      interaction_terms = "sex",
      sex_interaction = TRUE, 
      sex_variable = "sex",
      covariates = brain_structure_covariates_diffusion_no_sex,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Fractional Anisotropy"
      )
    )

  FA_general_sex_interaction <- unilateral_interaction(
    dependent = FA_general,
    independent = disorder,
    interaction_terms = "sex",
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_diffusion_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates,
    structural_subtype = "General Fractional Anisotropy"
  )
  
  ## MD ----
  hemisphere_interactions <- hemisphere_interaction(
    dependent = MD_bilateral,
    independent = disorder,
    covariates = brain_structure_covariates_diffusion,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Mean Diffusivity",
    interaction_terms = "sex", 
    sex_interaction = TRUE, 
    sex_variable = "sex"
  )

  MD_bilateral_sex_interaction <- bilateral_interaction(
    dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions],
    independent = disorder,
    interaction_terms = "sex",
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_diffusion_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates_long,
    hemisphere_col = "hemi",
    structural_subtype = "Mean Diffusivity",
    id_col = "f.eid"
  )

  if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
    MD_bilateral_sex_interaction <- rbind(
      MD_bilateral_sex_interaction,
      unilateral_interaction(
        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
        independent = disorder,
        interaction_terms = "sex",
        sex_interaction = TRUE, 
        sex_variable = "sex",
        covariates = brain_structure_covariates_diffusion_no_sex,
        dataset = UKB_CP_MDD_imaging_covariates,
        structural_subtype = "Mean Diffusivity"
      )
    )
  }

  MD_sex_interaction <- rbind(
    MD_bilateral_sex_interaction,
    unilateral_interaction(
      dependent = MD_unilateral,
      independent = disorder,
      interaction_terms = "sex",
      sex_interaction = TRUE, 
      sex_variable = "sex",
      covariates = brain_structure_covariates_diffusion_no_sex,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Mean Diffusivity"
    )
  )

  MD_general_sex_interaction <- unilateral_interaction(
    dependent = MD_general,
    independent = disorder,
    interaction_terms = "sex",
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_diffusion_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates,
    structural_subtype = "General Mean Diffusivity"
  )

  ## Combine all interaction results
  all_sex_interaction <- do.call("rbind", list(
    subcortical_volume_sex_interaction, cortical_volume_sex_interaction, cortical_volume_general_sex_interaction, cortical_thickness_sex_interaction, cortical_thickness_general_sex_interaction, cortical_area_sex_interaction, cortical_area_general_sex_interaction, FA_sex_interaction, FA_general_sex_interaction, MD_sex_interaction, MD_general_sex_interaction
  ))

  if (disorder == "chronic_pain_status") {
    CP_MDD_structure_sex_interaction_all <- all_sex_interaction
  } else {
    CP_MDD_structure_sex_interaction_all <- rbind(CP_MDD_structure_sex_interaction_all, all_sex_interaction)
  }

  paste(disorder, "and brain structure sex interaction association complete")
}

```

## Carry out sex-stratified association analysis
```{r sex-stratified association analysis}

UKB_CP_MDD_imaging_covariates_long_male <- subset(UKB_CP_MDD_imaging_covariates_long, sex == 0)
UKB_CP_MDD_imaging_covariates_long_female <- subset(UKB_CP_MDD_imaging_covariates_long, sex == 1)

## Loop through each disorder and sex to carry out association analysis
for (sex in c("female", "male")){
  for (disorder in c("chronic_pain_status", "depression", "depression_sensitivity")){
    
   df_sex_interactions <- filter(CP_MDD_structure_sex_interaction_all, disorder == get("disorder", envir = .env))
    
    ##Subcortical Volume ----
    sig_sex_interaction <- unique(
      df_sex_interactions$brain_phenotype[df_sex_interactions$brain_structure_type == "Regional Subcortical Volume" & df_sex_interactions$p < 0.05]
      )
    
    sig_sex_interaction_bilateral <- sig_sex_interaction[!grepl("left|right", sig_sex_interaction)]
    sig_sex_interaction_unilateral <- sig_sex_interaction[grepl("left|right", sig_sex_interaction)]
    
    if (length(sig_sex_interaction) > 0){
      if(length(sig_sex_interaction_bilateral)){
        subcortical_volume_assoc <- bilateral_structure_assoc(
          dependent = sig_sex_interaction_bilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
          n_comparisons = length(sig_sex_interaction_bilateral),
          hemisphere_col = "hemi",
          structural_subtype = "Regional Subcortical Volume",
          id_col = "f.eid"
        )
      } else{
        subcortical_volume_assoc <- data.frame()
      }
      
      if(length(sig_sex_interaction_unilateral) > 0){
        subcortical_volume_assoc <- rbind(
        subcortical_volume_assoc,
        unilateral_structure_assoc(
          dependent = sig_sex_interaction_unilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
          n_comparisons = length(sig_sex_interaction_unilateral),
          structural_subtype = "Regional Subcortical Volume")
        )
      }
    }else{
        subcortical_volume_assoc <- data.frame()
    }
    
    ## Adjust pvalues
    subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr")

    ## Cortical Volume ----
    
    sig_sex_interaction <-unique(df_sex_interactions$brain_phenotype[df_sex_interactions$brain_structure_type == "Regional Cortical Volume" & df_sex_interactions$p < 0.05])
    
    sig_sex_interaction_bilateral <- sig_sex_interaction[!grepl("left|right", sig_sex_interaction)]
    sig_sex_interaction_unilateral <- sig_sex_interaction[grepl("left|right", sig_sex_interaction)]

    if (length(sig_sex_interaction) > 0){
      if(length(sig_sex_interaction_bilateral)){
        cortical_volume_assoc <- bilateral_structure_assoc(
          dependent = sig_sex_interaction_bilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
          n_comparisons = length(sig_sex_interaction_bilateral),
          hemisphere_col = "hemi",
          structural_subtype = "Regional Cortical Volume",
          id_col = "f.eid"
        )
      } else{
        cortical_volume_assoc <- data.frame()
      }
      
      if(length(sig_sex_interaction_unilateral) > 0){
        cortical_volume_assoc <- rbind(
        cortical_volume_assoc,
        unilateral_structure_assoc(
          dependent = sig_sex_interaction_unilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
          n_comparisons = length(sig_sex_interaction_unilateral),
          structural_subtype = "Regional Cortical Volume")
        )
      }
    } else{
        cortical_volume_assoc <- data.frame()
    }
    ## Adjust pvalues
    cortical_volume_assoc$p.adjust <- p.adjust.new(cortical_volume_assoc$p.value, method = "fdr")

    sig_sex_interaction_general <- cortical_volume_general[cortical_volume_general %in% unique(df_sex_interactions$brain_phenotype[df_sex_interactions$brain_structure_type == "Global and Lobal Cortical Volume" & df_sex_interactions$p < 0.05])]
    
    if (length(sig_sex_interaction_general) > 0){
      cortical_volume_general_assoc <- unilateral_structure_assoc(
        dependent = sig_sex_interaction_general,
        independent = disorder,
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
        n_comparisons = length(sig_sex_interaction_general),
        structural_subtype = "Global and Lobal Cortical Volume")
      
    } else{
      cortical_volume_general_assoc <- data.frame()
    }
            
    ## Cortical Thickness ----
    
    sig_sex_interaction <-unique(df_sex_interactions$brain_phenotype[df_sex_interactions$brain_structure_type == "Regional Cortical Thickness" & df_sex_interactions$p < 0.05])
    
    sig_sex_interaction_bilateral <- sig_sex_interaction[!grepl("left|right", sig_sex_interaction)]
    sig_sex_interaction_unilateral <- sig_sex_interaction[grepl("left|right", sig_sex_interaction)]

    if (length(sig_sex_interaction) > 0){
      if(length(sig_sex_interaction_bilateral)){
        cortical_thickness_assoc <- bilateral_structure_assoc(
          dependent = sig_sex_interaction_bilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
          n_comparisons = length(sig_sex_interaction_bilateral),
          hemisphere_col = "hemi",
          structural_subtype = "Regional Cortical Thickness",
          id_col = "f.eid"
        )
      } else{
        cortical_thickness_assoc <- data.frame()
      }
      
      if(length(sig_sex_interaction_unilateral) > 0){
        cortical_thickness_assoc <- rbind(
        cortical_thickness_assoc,
        unilateral_structure_assoc(
          dependent = sig_sex_interaction_unilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
          n_comparisons = length(sig_sex_interaction_unilateral),
          structural_subtype = "Regional Cortical Thickness")
        )
      }
    } else{
        cortical_thickness_assoc <- data.frame()
    }
    ## Adjust pvalues
    cortical_thickness_assoc$p.adjust <- p.adjust.new(cortical_thickness_assoc$p.value, method = "fdr")

    sig_sex_interaction_general <- cortical_thickness_general[cortical_thickness_general %in% unique(df_sex_interactions$brain_phenotype[df_sex_interactions$brain_structure_type == "Global and Lobal Cortical Thickness" & df_sex_interactions$p < 0.05])]
    
    if (length(sig_sex_interaction_general) > 0){
      cortical_thickness_general_assoc <- unilateral_structure_assoc(
        dependent = sig_sex_interaction_general,
        independent = disorder,
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
        n_comparisons = length(sig_sex_interaction_general),
        structural_subtype = "Global and Lobal Cortical Thickness")
      
    } else{
      cortical_thickness_general_assoc <- data.frame()
    }
    
    ## Cortical Area ----
    
    sig_sex_interaction <-unique(df_sex_interactions$brain_phenotype[df_sex_interactions$brain_structure_type == "Regional Cortical Area" & df_sex_interactions$p < 0.05])
    
    sig_sex_interaction_bilateral <- sig_sex_interaction[!grepl("left|right", sig_sex_interaction)]
    sig_sex_interaction_unilateral <- sig_sex_interaction[grepl("left|right", sig_sex_interaction)]

    if (length(sig_sex_interaction) > 0){
      if(length(sig_sex_interaction_bilateral)){
        cortical_area_assoc <- bilateral_structure_assoc(
          dependent = sig_sex_interaction_bilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
          n_comparisons = length(sig_sex_interaction_bilateral),
          hemisphere_col = "hemi",
          structural_subtype = "Regional Cortical Area",
          id_col = "f.eid"
        )
      } else{
        cortical_area_assoc <- data.frame()
      }
      
      if(length(sig_sex_interaction_unilateral) > 0){
        cortical_area_assoc <- rbind(
        cortical_area_assoc,
        unilateral_structure_assoc(
          dependent = sig_sex_interaction_unilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
          n_comparisons = length(sig_sex_interaction_unilateral),
          structural_subtype = "Regional Cortical Area")
        )
      }
    } else{
        cortical_area_assoc <- data.frame()
    }
    ## Adjust pvalues
    cortical_area_assoc$p.adjust <- p.adjust.new(cortical_area_assoc$p.value, method = "fdr")

    sig_sex_interaction_general <- cortical_area_general[cortical_area_general %in% unique(df_sex_interactions$brain_phenotype[df_sex_interactions$brain_structure_type == "Global and Lobal Cortical Area" & df_sex_interactions$p < 0.05])]
    
    if (length(sig_sex_interaction_general) > 0){
      cortical_area_general_assoc <- unilateral_structure_assoc(
        dependent = sig_sex_interaction_general,
        independent = disorder,
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
        n_comparisons = length(sig_sex_interaction_general),
        structural_subtype = "Global and Lobal Cortical Area")
      
    } else{
      cortical_area_general_assoc <- data.frame()
    }
    
    ## FA ----

    sig_sex_interaction <- unique(df_sex_interactions$brain_phenotype[df_sex_interactions$brain_structure_type == "Fractional Anisotropy" & df_sex_interactions$p < 0.05])

    sig_sex_interaction_bilateral <- sig_sex_interaction[sig_sex_interaction %in% FA_bilateral]
    sig_sex_interaction_unilateral <- c(sig_sex_interaction[grepl("left|right", sig_sex_interaction)], sig_sex_interaction[sig_sex_interaction %in% FA_unilateral])

    if (length(sig_sex_interaction) > 0){
      if(length(sig_sex_interaction_bilateral)){
        FA_assoc <- bilateral_structure_assoc(
          dependent = sig_sex_interaction_bilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
          n_comparisons = length(sig_sex_interaction_bilateral),
          hemisphere_col = "hemi",
          structural_subtype = "Fractional Anisotropy",
          id_col = "f.eid"
        )
      } else{
        FA_assoc <- data.frame()
      }
      
      if(length(sig_sex_interaction_unilateral) > 0){
        FA_assoc <- rbind(
        FA_assoc,
        unilateral_structure_assoc(
          dependent = sig_sex_interaction_unilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
          n_comparisons = length(sig_sex_interaction_unilateral),
          structural_subtype = "Fractional Anisotropy")
        )
      }
    } else{
        FA_assoc <- data.frame()
    }
    
    ## Adjust pvalues
    FA_assoc$p.adjust <- p.adjust.new(FA_assoc$p.value, method = "fdr")
    
    sig_sex_interaction_general <- unique(df_sex_interactions$brain_phenotype[df_sex_interactions$brain_structure_type == "General Fractional Anisotropy" & df_sex_interactions$p < 0.05])
    
    if (length(sig_sex_interaction_general) > 0){
      FA_general_assoc <- unilateral_structure_assoc(
        dependent = sig_sex_interaction_general,
        independent = disorder,
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
        n_comparisons = length(sig_sex_interaction_general),
        structural_subtype = "General Fractional Anisotropy")
      
    } else{
      FA_general_assoc <- data.frame()
    }
        
    ## MD ----

    sig_sex_interaction <-unique(df_sex_interactions$brain_phenotype[df_sex_interactions$brain_structure_type == "Mean Diffusivity" & df_sex_interactions$p < 0.05])

    sig_sex_interaction_bilateral <- sig_sex_interaction[sig_sex_interaction %in% MD_bilateral]
    sig_sex_interaction_unilateral <- c(sig_sex_interaction[grepl("left|right", sig_sex_interaction)], sig_sex_interaction[sig_sex_interaction %in% MD_unilateral])
    
    if (length(sig_sex_interaction) > 0){
      if(length(sig_sex_interaction_bilateral)){
        MD_assoc <- bilateral_structure_assoc(
          dependent = sig_sex_interaction_bilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
          n_comparisons = length(sig_sex_interaction_bilateral),
          hemisphere_col = "hemi",
          structural_subtype = "Mean Diffusivity",
          id_col = "f.eid"
        )
      } else{
        MD_assoc <- data.frame()
      }
      
      if(length(sig_sex_interaction_unilateral) > 0){
        MD_assoc <- rbind(
        MD_assoc,
        unilateral_structure_assoc(
          dependent = sig_sex_interaction_unilateral,
          independent = disorder,
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
          n_comparisons = length(sig_sex_interaction_unilateral),
          structural_subtype = "Mean Diffusivity")
        )
      }
    } else{
        MD_assoc <- data.frame()
    }
    
    ## Adjust pvalues
    MD_assoc$p.adjust <- p.adjust.new(MD_assoc$p.value, method = "fdr")
    
    sig_sex_interaction_general <- unique(df_sex_interactions$brain_phenotype[df_sex_interactions$brain_structure_type == "General Mean Diffusivity" & df_sex_interactions$p < 0.05])
    
    if (length(sig_sex_interaction_general) > 0){
      MD_general_assoc <- unilateral_structure_assoc(
        dependent = sig_sex_interaction_general,
        independent = disorder,
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
        n_comparisons = length(sig_sex_interaction_general),
        structural_subtype = "General Mean Diffusivity")
      
    } else{
      MD_general_assoc <- data.frame()
    }
        
    ## Combine association results
    all_assoc <- do.call("rbind", list(subcortical_volume_assoc, cortical_volume_assoc, cortical_area_assoc, cortical_thickness_assoc, cortical_area_general_assoc, cortical_thickness_general_assoc, cortical_volume_general_assoc, FA_assoc, FA_general_assoc, MD_assoc, MD_general_assoc))

    ## Add column indicating disorder
    all_assoc$disorder <- disorder

    ## append association analysis
    if (disorder == "chronic_pain_status"){
      assign(paste0("CP_MDD_structure_assoc_", sex), all_assoc)
    }else{
      assign(paste0("CP_MDD_structure_assoc_", sex) , rbind(get(paste0("CP_MDD_structure_assoc_", sex)), all_assoc))
    }
  }
}
```

## Carry out disorder interaction analysis
```{r disorder interaction analysis}
## Subcortical Volume ----
## Flag if any bilateral hemisphere measurements need to be analyzed separately  
hemisphere_interactions <- hemisphere_interaction(
  dependent = sub_cortical_volume_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Subcortical Volume",
  interaction_terms = "chronic_pain_status"
)

subcortical_volume_disorder_interaction <- bilateral_interaction(
  dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions],
  independent = "depression", 
  interaction_terms = "chronic_pain_status",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Subcortical Volume",
  id_col = "f.eid",
  sex_interaction = FALSE
)

if (!is.null(hemisphere_interactions)) {  ## If hemi interaction found, run separately
  subcortical_volume_disorder_interaction <- rbind(
    subcortical_volume_disorder_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = disorder,
      interaction_terms = "chronic_pain_status",
      covariates = brain_structure_covariates_T1_no_sex,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Regional Subcortical Volume",
      sex_interaction = FALSE
    )
  )
}

subcortical_volume_disorder_interaction$p.adjust <- p.adjust(subcortical_volume_disorder_interaction$p.value, method = "fdr")

## Cortical Volume ----
hemisphere_interactions <- hemisphere_interaction(
  dependent = cortical_volume_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Volume",
  interaction_terms = "chronic_pain_status"
)

cortical_volume_disorder_interaction <- bilateral_interaction(
  dependent = cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions],
  independent = "depression",
  interaction_terms = "chronic_pain_status",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Volume",
  id_col = "f.eid",
  sex_interaction = FALSE
)

if (!is.null(hemisphere_interactions)) {  ## If hemi interaction found, run separately
  cortical_volume_disorder_interaction <- rbind(
    cortical_volume_disorder_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = "depression",
      interaction_terms = "chronic_pain_status",
      covariates = brain_structure_covariates_T1,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Regional Cortical Volume",
      sex_interaction = FALSE
    )
  )
}

cortical_volume_disorder_interaction$p.adjust <- p.adjust(cortical_volume_disorder_interaction$p.value, method = "fdr")

## General Cortical Volume Measures
cortical_volume_general_disorder_interaction <- unilateral_interaction(
  dependent = cortical_volume_general,
  independent = "depression",
  interaction_terms = "chronic_pain_status",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates,
  structural_subtype = "Global and Lobal Cortical Volume",
  sex_interaction = FALSE
)

cortical_volume_general_disorder_interaction[!grepl("global", row.names(cortical_volume_general_disorder_interaction)),"p.adjust"] <- p.adjust.new(
  cortical_volume_general_disorder_interaction[!grepl("global", row.names(cortical_volume_general_disorder_interaction)),"p.value"], 
  method = "fdr"
)
cortical_volume_general_disorder_interaction[grepl("global", row.names(cortical_volume_general_disorder_interaction)),"p.adjust"] <- 
  cortical_volume_general_disorder_interaction[grepl("global", row.names(cortical_volume_general_disorder_interaction)),"p.value"] 

## Cortical Thickness ----
hemisphere_interactions <- hemisphere_interaction(
  dependent = cortical_thickness_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Thickness",
  interaction_terms = "chronic_pain_status"
)

cortical_thickness_disorder_interaction <- bilateral_interaction(
  dependent = cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions],
  independent = "depression",
  interaction_terms = "chronic_pain_status",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Thickness",
  id_col = "f.eid",
  sex_interaction = FALSE
)

if (!is.null(hemisphere_interactions)) {  ## If hemi interaction found, run separately
  cortical_thickness_disorder_interaction <- rbind(
    cortical_thickness_disorder_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = "depression",
      interaction_terms = "chronic_pain_status",
      covariates = brain_structure_covariates_T1,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Regional Cortical Thickness",
      sex_interaction = FALSE
    )
  )
}

cortical_thickness_disorder_interaction$p.adjust <- p.adjust(cortical_thickness_disorder_interaction$p.value, method = "fdr")

## General Cortical Thickness Measures
cortical_thickness_general_disorder_interaction <- unilateral_interaction(
  dependent = cortical_thickness_general,
  independent = "depression",
  interaction_terms = "chronic_pain_status",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates,
  structural_subtype = "Global and Lobal Cortical Thickness",
  sex_interaction = FALSE
)

cortical_thickness_general_disorder_interaction[!grepl("global", row.names(cortical_thickness_general_disorder_interaction)),"p.adjust"] <- p.adjust.new(
  cortical_thickness_general_disorder_interaction[!grepl("global", row.names(cortical_thickness_general_disorder_interaction)),"p.value"], 
  method = "fdr"
)
cortical_thickness_general_disorder_interaction[grepl("global", row.names(cortical_thickness_general_disorder_interaction)),"p.adjust"] <- 
  cortical_thickness_general_disorder_interaction[grepl("global", row.names(cortical_thickness_general_disorder_interaction)),"p.value"] 

## Cortical Area ----
hemisphere_interactions <- hemisphere_interaction(
  dependent = cortical_area_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Area",
  interaction_terms = "chronic_pain_status"
)

cortical_area_disorder_interaction <- bilateral_interaction(
  dependent = cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions],
  independent = "depression",
  interaction_terms = "chronic_pain_status",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Area",
  id_col = "f.eid",
  sex_interaction = FALSE
)

if (!is.null(hemisphere_interactions)) {  ## If hemi interaction found, run separately
  cortical_area_disorder_interaction <- rbind(
    cortical_area_disorder_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = "depression",
      interaction_terms = "chronic_pain_status",
      covariates = brain_structure_covariates_T1,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Regional Cortical Area",
      sex_interaction = FALSE
    )
  )
}

cortical_area_disorder_interaction$p.adjust <- p.adjust(cortical_area_disorder_interaction$p.value, method = "fdr")

## General Cortical Area Measures
cortical_area_general_disorder_interaction <- unilateral_interaction(
  dependent = cortical_area_general,
  independent = "depression",
  interaction_terms = "chronic_pain_status",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates,
  structural_subtype = "Global and Lobal Cortical Area",
  sex_interaction = FALSE
)

cortical_area_general_disorder_interaction[!grepl("global", row.names(cortical_area_general_disorder_interaction)),"p.adjust"] <- p.adjust.new(
  cortical_area_general_disorder_interaction[!grepl("global", row.names(cortical_area_general_disorder_interaction)),"p.value"], 
  method = "fdr"
)
cortical_area_general_disorder_interaction[grepl("global", row.names(cortical_area_general_disorder_interaction)),"p.adjust"] <- 
  cortical_area_general_disorder_interaction[grepl("global", row.names(cortical_area_general_disorder_interaction)),"p.value"] 

## FA ----
hemisphere_interactions <- hemisphere_interaction(
  dependent = FA_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Volume",
  interaction_terms = "chronic_pain_status"
)

FA_bilateral_disorder_interaction <- bilateral_interaction(
  dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions],
  independent = "depression",
  interaction_terms = "chronic_pain_status",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Fractional Anisotropy",
  id_col = "f.eid",
  sex_interaction = FALSE
)

if (!is.null(hemisphere_interactions)) {  ## If hemi interaction found, run separately
  FA_bilateral_disorder_interaction <- rbind(
    FA_bilateral_disorder_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = "depression",
      interaction_terms = "chronic_pain_status",
      covariates = brain_structure_covariates_T1,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Fractional Anisotropy",
      sex_interaction = FALSE
    )
  )
}

  FA_disorder_interaction <- rbind(
    FA_bilateral_disorder_interaction,
    unilateral_interaction(
      dependent = FA_unilateral,
      independent = "depression",
      interaction_terms = "chronic_pain_status",
      sex_interaction = FALSE, 
      covariates = brain_structure_covariates_diffusion,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Fractional Anisotropy"
    )
  )
  
  FA_disorder_interaction$p.adjust <- p.adjust(FA_disorder_interaction$p.value, method = "fdr")

  FA_general_disorder_interaction <- unilateral_interaction(
    dependent = FA_general,
    independent = "depression",
    interaction_terms = "chronic_pain_status",
    sex_interaction = FALSE, 
    covariates = brain_structure_covariates_diffusion,
    dataset = UKB_CP_MDD_imaging_covariates,
    structural_subtype = "General Fractional Anisotropy"
  )


FA_general_disorder_interaction[!grepl("global", row.names(FA_general_disorder_interaction)),"p.adjust"] <- p.adjust.new(
  FA_general_disorder_interaction[!grepl("global", row.names(FA_general_disorder_interaction)),"p.value"], 
  method = "fdr"
)
FA_general_disorder_interaction[grepl("global", row.names(FA_general_disorder_interaction)),"p.adjust"] <- 
  FA_general_disorder_interaction[grepl("global", row.names(FA_general_disorder_interaction)),"p.value"] 

## MD ----
hemisphere_interactions <- hemisphere_interaction(
  dependent = MD_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Volume",
  interaction_terms = "chronic_pain_status"
)

MD_bilateral_disorder_interaction <- bilateral_interaction(
  dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions],
  independent = "depression",
  interaction_terms = "chronic_pain_status",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Mean Diffusivity",
  id_col = "f.eid",
  sex_interaction = FALSE
)

if (!is.null(hemisphere_interactions)) {  ## If hemi interaction found, run separately
  MD_bilateral_disorder_interaction <- rbind(
    MD_bilateral_disorder_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = "depression",
      interaction_terms = "chronic_pain_status",
      covariates = brain_structure_covariates_T1,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Mean Diffusivity",
      sex_interaction = FALSE
    )
  )
}

MD_disorder_interaction <- rbind(
  MD_bilateral_disorder_interaction,
    unilateral_interaction(
      dependent = MD_unilateral,
      independent = "depression",
      interaction_terms = "chronic_pain_status",
      sex_interaction = FALSE, 
      covariates = brain_structure_covariates_diffusion,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Mean Diffusivity"
  )
)

MD_disorder_interaction$p.adjust <- p.adjust(MD_disorder_interaction$p.value, method = "fdr")

MD_general_disorder_interaction <- unilateral_interaction(
  dependent = MD_general,
  independent = "depression",
  interaction_terms = "chronic_pain_status",
  sex_interaction = FALSE, 
  covariates = brain_structure_covariates_diffusion,
  dataset = UKB_CP_MDD_imaging_covariates,
  structural_subtype = "General Mean Diffusivity"
)


MD_general_disorder_interaction[!grepl("global", row.names(MD_general_disorder_interaction)),"p.adjust"] <- p.adjust.new(
  MD_general_disorder_interaction[!grepl("global", row.names(MD_general_disorder_interaction)),"p.value"], method = "fdr")
MD_general_disorder_interaction[grepl("global", row.names(MD_general_disorder_interaction)),"p.adjust"] <- 
  MD_general_disorder_interaction[grepl("global", row.names(MD_general_disorder_interaction)),"p.value"] 


## Combine all interaction results
CP_MDD_structure_disorder_interaction_all <- do.call("rbind", list(
  subcortical_volume_disorder_interaction, cortical_volume_disorder_interaction, cortical_volume_general_disorder_interaction, cortical_thickness_disorder_interaction, cortical_thickness_general_disorder_interaction, cortical_area_disorder_interaction, cortical_area_general_disorder_interaction, FA_disorder_interaction, FA_general_disorder_interaction, MD_disorder_interaction, MD_general_disorder_interaction
  ))

```

## Carry out three-way interaction analysis of sex, chronic pain and depression
```{r three-way interaction analysis}
## Carry out sex interaction analysis  

## Subcortical Volume ----
## Flag if any bilateral hemisphere measurements need to be analyzed separately
hemisphere_interactions <- hemisphere_interaction(
  dependent = sub_cortical_volume_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Subcortical Volume", 
  interaction_terms = c("chronic_pain_status", "sex"), 
  sex_interaction = TRUE, 
  sex_variable = "sex"
)

subcortical_volume_disorder_sex_interaction <- bilateral_interaction(
  dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions],
  independent = "depression",  
  interaction_terms = c("chronic_pain_status", "sex"), 
  sex_interaction = TRUE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Subcortical Volume",
  id_col = "f.eid"
)

if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
  subcortical_volume_disorder_sex_interaction <- rbind(
    subcortical_volume_disorder_sex_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = "depression",
      sex_variable = "sex",
      covariates = brain_structure_covariates_T1_no_sex,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Regional Subcortical Volume"
    )
  )
}

## Cortical Volume ----
hemisphere_interactions <- hemisphere_interaction(
  dependent = cortical_volume_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Volume",
  interaction_terms = c("chronic_pain_status", "sex"), 
  sex_interaction = TRUE, 
  sex_variable = "sex"
)

cortical_volume_disorder_sex_interaction <- bilateral_interaction(
  dependent = cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions],
  independent = "depression", 
  interaction_terms = c("chronic_pain_status", "sex"),
  sex_interaction = TRUE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Volume",
  id_col = "f.eid"
)

if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
  cortical_volume_disorder_sex_interaction <- rbind(
    cortical_volume_disorder_sex_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = "depression",
      sex_variable = "sex",
      covariates = brain_structure_covariates_T1_no_sex,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Regional Cortical Volume",
      sex_interaction = TRUE,
      interaction_terms = c("chronic_pain_status", "sex")
    )
  )
}

cortical_volume_general_disorder_sex_interaction <- unilateral_interaction(
  dependent = cortical_volume_general,
  independent = "depression", 
  interaction_terms = c("chronic_pain_status", "sex"),
  sex_interaction = TRUE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = UKB_CP_MDD_imaging_covariates,
  structural_subtype = "Global and Lobal Cortical Volume"
)

## Cortical Thickness ----
hemisphere_interactions <- hemisphere_interaction(
  dependent = cortical_thickness_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Thickness",
  interaction_terms = c("chronic_pain_status", "sex"), 
  sex_interaction = TRUE, 
  sex_variable = "sex"
)

cortical_thickness_disorder_sex_interaction <- bilateral_interaction(
  dependent = cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions],
  independent = "depression",
  interaction_terms = c("chronic_pain_status", "sex"),
  sex_interaction = TRUE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Thickness",
  id_col = "f.eid"
)

if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
  cortical_thickness_disorder_sex_interaction <- rbind(
    cortical_thickness_disorder_sex_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = "depression",
      interaction_terms = c("chronic_pain_status", "sex"),
      sex_interaction = TRUE, 
      sex_variable = "sex",
      covariates = brain_structure_covariates_T1_no_sex,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Regional Cortical Thickness"
    )
  )
}

cortical_thickness_general_disorder_sex_interaction <- unilateral_interaction(
  dependent = cortical_thickness_general,
  independent = "depression",
  interaction_terms = c("chronic_pain_status", "sex"),
  sex_interaction = TRUE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = UKB_CP_MDD_imaging_covariates,
  structural_subtype = "Global and Lobal Cortical Thickness"
)

## Cortical Area ----
hemisphere_interactions <- hemisphere_interaction(
  dependent = cortical_area_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_T1,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Area", 
  interaction_terms = c("chronic_pain_status", "sex"), 
  sex_interaction = TRUE, 
  sex_variable = "sex"
)

cortical_area_disorder_sex_interaction <- bilateral_interaction(
  dependent = cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions],
  independent = "depression",
  interaction_terms = c("chronic_pain_status", "sex"),
  sex_interaction = TRUE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Regional Cortical Area",
  id_col = "f.eid"
)

if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
  cortical_area_disorder_sex_interaction <- rbind(
    cortical_area_disorder_sex_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = "depression",
      interaction_terms = c("chronic_pain_status", "sex"),
      sex_interaction = TRUE, 
      sex_variable = "sex",
      covariates = brain_structure_covariates_T1_no_sex,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Regional Cortical Area"
    )
  )
}

cortical_area_general_disorder_sex_interaction <- unilateral_interaction(
  dependent = cortical_area_general,
  independent = "depression",
  interaction_terms = c("chronic_pain_status", "sex"),
  sex_interaction = TRUE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = UKB_CP_MDD_imaging_covariates,
  structural_subtype = "Global and Lobal Cortical Area"
)

## FA ----
hemisphere_interactions <- hemisphere_interaction(
  dependent = FA_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_diffusion,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Fractional Anisotropy",
  interaction_terms = c("chronic_pain_status", "sex"), 
  sex_interaction = TRUE, 
  sex_variable = "sex"
)

FA_bilateral_disorder_sex_interaction <- bilateral_interaction(
  dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions],
  independent = "depression",
  interaction_terms = c("chronic_pain_status", "sex"),
  sex_interaction = TRUE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_diffusion_no_sex,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Fractional Anisotropy",
  id_col = "f.eid"
)

if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
  FA_bilateral_disorder_sex_interaction <- rbind(
    FA_bilateral_disorder_sex_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = "depression",
      interaction_terms = c("chronic_pain_status", "sex"),
      sex_interaction = TRUE, 
      sex_variable = "sex",
      covariates = brain_structure_covariates_diffusion_no_sex,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Fractional Anisotropy"
    )
  )
}

FA_disorder_sex_interaction <- rbind(
  FA_bilateral_disorder_sex_interaction,
    unilateral_interaction(
    dependent = FA_unilateral,
    independent = "depression",
    interaction_terms = c("chronic_pain_status", "sex"),
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_diffusion_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates,
    structural_subtype = "Fractional Anisotropy"
    )
)

FA_general_disorder_sex_interaction <- unilateral_interaction(
  dependent = FA_general,
  independent = "depression",
  interaction_terms = c("chronic_pain_status", "sex"),
  sex_interaction = TRUE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_diffusion_no_sex,
  dataset = UKB_CP_MDD_imaging_covariates,
  structural_subtype = "General Fractional Anisotropy"
)

## MD ----
hemisphere_interactions <- hemisphere_interaction(
  dependent = MD_bilateral,
  independent = "depression",
  covariates = brain_structure_covariates_diffusion,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Mean Diffusivity",
  interaction_terms = c("chronic_pain_status", "sex"), 
  sex_interaction = TRUE, 
  sex_variable = "sex"
)

MD_bilateral_disorder_sex_interaction <- bilateral_interaction(
  dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions],
  independent = "depression",
  interaction_terms = c("chronic_pain_status", "sex"),
  sex_interaction = TRUE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_diffusion_no_sex,
  dataset = UKB_CP_MDD_imaging_covariates_long,
  hemisphere_col = "hemi",
  structural_subtype = "Mean Diffusivity",
  id_col = "f.eid"
)

if (!is.null(hemisphere_interactions)) { ## If hemi interaction found, run separately
  MD_bilateral_disorder_sex_interaction <- rbind(
    MD_bilateral_disorder_sex_interaction,
    unilateral_interaction(
      dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")),
      independent = "depression",
      interaction_terms = c("chronic_pain_status", "sex"),
      sex_interaction = TRUE, 
      sex_variable = "sex",
      covariates = brain_structure_covariates_diffusion_no_sex,
      dataset = UKB_CP_MDD_imaging_covariates,
      structural_subtype = "Mean Diffusivity"
    )
  )
}

MD_disorder_sex_interaction <- rbind(
  MD_bilateral_disorder_sex_interaction,
  unilateral_interaction(
    dependent = MD_unilateral,
    independent = "depression",
    interaction_terms = c("chronic_pain_status", "sex"),
    sex_interaction = TRUE, 
    sex_variable = "sex",
    covariates = brain_structure_covariates_diffusion_no_sex,
    dataset = UKB_CP_MDD_imaging_covariates,
    structural_subtype = "Mean Diffusivity"
  )
)

MD_general_disorder_sex_interaction <- unilateral_interaction(
  dependent = MD_general,
  independent = "depression",
  interaction_terms = c("chronic_pain_status", "sex"),
  sex_interaction = TRUE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_diffusion_no_sex,
  dataset = UKB_CP_MDD_imaging_covariates,
  structural_subtype = "General Mean Diffusivity"
)

## Combine all interaction results
CP_MDD_structure_disorder_sex_interaction_all <- do.call("rbind", list(
  subcortical_volume_disorder_sex_interaction, cortical_volume_disorder_sex_interaction, cortical_volume_general_disorder_sex_interaction, cortical_thickness_disorder_sex_interaction, cortical_thickness_general_disorder_sex_interaction, cortical_area_disorder_sex_interaction, cortical_area_general_disorder_sex_interaction, FA_disorder_sex_interaction, FA_general_disorder_sex_interaction, MD_disorder_sex_interaction, MD_general_disorder_sex_interaction
))

paste("three-way interaction association complete")
```

## Carry out sex-stratified disorder interaction analysis
```{r sex-stratified disorder interaction analysis}
for (sex in c("female", "male")){
  
  df_disorder_sex_interactions <- CP_MDD_structure_disorder_sex_interaction_all
  
  ##Subcortical Volume ----
  sig_disorder_sex_interaction <- unique(
    df_disorder_sex_interactions$brain_phenotype[df_disorder_sex_interactions$brain_structure_type == "Regional Subcortical Volume" & df_disorder_sex_interactions$p < 0.05]
    )
  
  sig_disorder_sex_interaction_bilateral <- sig_disorder_sex_interaction[!grepl("left|right", sig_disorder_sex_interaction)]
  sig_disorder_sex_interaction_unilateral <- sig_disorder_sex_interaction[grepl("left|right", sig_disorder_sex_interaction)]
  
  if (length(sig_disorder_sex_interaction) > 0){
    if(length(sig_disorder_sex_interaction_bilateral)){
      subcortical_volume_disorder_interaction <- bilateral_interaction(
        dependent = sig_disorder_sex_interaction_bilateral,
        independent = "depression",  
        interaction_terms = "chronic_pain_status", 
        sex_interaction = FALSE, 
        sex_variable = "sex",
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
        hemisphere_col = "hemi",
        structural_subtype = "Regional Subcortical Volume",
        id_col = "f.eid"
        )
    } else{
      subcortical_volume_disorder_interaction <- data.frame()
    }
    
    if(length(sig_disorder_sex_interaction_unilateral) > 0){
      subcortical_volume_disorder_interaction <- rbind(
        subcortical_volume_disorder_interaction,
        unilateral_interaction(
          dependent = sig_disorder_sex_interaction_unilateral,
          independent = "depression", 
          interaction_terms = "chronic_pain_status", 
          sex_interaction = FALSE,
          sex_variable = "sex",
          covariates = brain_structure_covariates_T1_no_sex,
          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
          structural_subtype = "Regional Subcortical Volume"
        )
      )
    }
  }else{
      subcortical_volume_disorder_interaction <- data.frame()
  }
  
  ## Adjust pvalues
  subcortical_volume_disorder_interaction$p.adjust <- p.adjust.new(subcortical_volume_disorder_interaction$p.value, method = "fdr")

  ## Cortical Volume ----
  
  sig_disorder_sex_interaction <- unique(df_disorder_sex_interactions$brain_phenotype[df_disorder_sex_interactions$brain_structure_type == "Regional Cortical Volume" & df_disorder_sex_interactions$p < 0.05])
  
  sig_disorder_sex_interaction_bilateral <- sig_disorder_sex_interaction[!grepl("left|right", sig_disorder_sex_interaction)]
  sig_disorder_sex_interaction_unilateral <- sig_disorder_sex_interaction[grepl("left|right", sig_disorder_sex_interaction)]
  
  if (length(sig_disorder_sex_interaction) > 0){
    if(length(sig_disorder_sex_interaction_bilateral)){
      cortical_volume_disorder_interaction <- bilateral_interaction(
        dependent = sig_disorder_sex_interaction_bilateral,
        independent = "depression", 
        interaction_terms = "chronic_pain_status",
        sex_interaction = FALSE, 
        sex_variable = "sex",
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
        hemisphere_col = "hemi",
        structural_subtype = "Regional Cortical Volume",
        id_col = "f.eid"
)
    } else{
      cortical_volume_disorder_interaction <- data.frame()
    }
    
    if(length(sig_disorder_sex_interaction_unilateral) > 0){
  cortical_volume_disorder_interaction <- rbind(
    cortical_volume_disorder_interaction,
    unilateral_interaction(
      dependent = sig_disorder_sex_interaction_unilateral,
      independent = "depression",
      sex_variable = "sex",
      covariates = brain_structure_covariates_T1_no_sex,
      dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
      structural_subtype = "Regional Cortical Volume",
      sex_interaction = FALSE,
      interaction_terms = "chronic_pain_status"
      )
    )
    }
  } else{
      cortical_volume_disorder_interaction <- data.frame()
  }
  ## Adjust pvalues
  cortical_volume_disorder_interaction$p.adjust <- p.adjust.new(cortical_volume_disorder_interaction$p.value, method = "fdr")
  
  sig_disorder_sex_interaction_general <- cortical_volume_general[cortical_volume_general %in% unique(df_disorder_sex_interactions$brain_phenotype[df_disorder_sex_interactions$brain_structure_type == "Global and Lobal Cortical Volume" & df_disorder_sex_interactions$p < 0.05])]
  
  if (length(sig_disorder_sex_interaction_general) > 0){
    cortical_volume_general_disorder_interaction <- unilateral_interaction(
  dependent = sig_disorder_sex_interaction_general,
  independent = "depression", 
  interaction_terms = "chronic_pain_status",
  sex_interaction = FALSE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
  structural_subtype = "Global and Lobal Cortical Volume"
)
  } else{
    cortical_volume_general_disorder_interaction <- data.frame()
  }
  
  cortical_volume_general_disorder_interaction[!grepl("global", row.names(cortical_volume_general_disorder_interaction)),"p.adjust"] <- p.adjust.new(
  cortical_volume_general_disorder_interaction[!grepl("global", row.names(cortical_volume_general_disorder_interaction)),"p.value"], 
  method = "fdr"
)
cortical_volume_general_disorder_interaction[grepl("global", row.names(cortical_volume_general_disorder_interaction)),"p.adjust"] <- 
  cortical_volume_general_disorder_interaction[grepl("global", row.names(cortical_volume_general_disorder_interaction)),"p.value"] 

  ## Cortical Thickness ----
  
  sig_disorder_sex_interaction <- unique(df_disorder_sex_interactions$brain_phenotype[df_disorder_sex_interactions$brain_structure_type == "Regional Cortical Thickness" & df_disorder_sex_interactions$p < 0.05])
  
  sig_disorder_sex_interaction_bilateral <- sig_disorder_sex_interaction[!grepl("left|right", sig_disorder_sex_interaction)]
  sig_disorder_sex_interaction_unilateral <- sig_disorder_sex_interaction[grepl("left|right", sig_disorder_sex_interaction)]
  
  if (length(sig_disorder_sex_interaction) > 0){
    if(length(sig_disorder_sex_interaction_bilateral)){
      cortical_thickness_disorder_interaction <- bilateral_interaction(
        dependent = sig_disorder_sex_interaction_bilateral,
        independent = "depression", 
        interaction_terms = "chronic_pain_status",
        sex_interaction = FALSE, 
        sex_variable = "sex",
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
        hemisphere_col = "hemi",
        structural_subtype = "Regional Cortical Thickness",
        id_col = "f.eid"
)
    } else{
      cortical_thickness_disorder_interaction <- data.frame()
    }
    
    if(length(sig_disorder_sex_interaction_unilateral) > 0){
  cortical_thickness_disorder_interaction <- rbind(
    cortical_thickness_disorder_interaction,
    unilateral_interaction(
      dependent = sig_disorder_sex_interaction_unilateral,
      independent = "depression",
      sex_variable = "sex",
      covariates = brain_structure_covariates_T1_no_sex,
      dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
      structural_subtype = "Regional Cortical Thickness",
      sex_interaction = FALSE,
      interaction_terms = "chronic_pain_status"
      )
    )
    }
  } else{
      cortical_thickness_disorder_interaction <- data.frame()
  }
  ## Adjust pvalues
  cortical_thickness_disorder_interaction$p.adjust <- p.adjust.new(cortical_thickness_disorder_interaction$p.value, method = "fdr")
  
  sig_disorder_sex_interaction_general <- cortical_thickness_general[cortical_thickness_general %in% unique(df_disorder_sex_interactions$brain_phenotype[df_disorder_sex_interactions$brain_structure_type == "Global and Lobal Cortical Thickness" & df_disorder_sex_interactions$p < 0.05])]
  
  if (length(sig_disorder_sex_interaction_general) > 0){
    cortical_thickness_general_disorder_interaction <- unilateral_interaction(
  dependent = sig_disorder_sex_interaction_general,
  independent = "depression", 
  interaction_terms = "chronic_pain_status",
  sex_interaction = FALSE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
  structural_subtype = "Global and Lobal Cortical Thickness"
)
  } else{
    cortical_thickness_general_disorder_interaction <- data.frame()
  }
  
  cortical_thickness_general_disorder_interaction[!grepl("global", row.names(cortical_thickness_general_disorder_interaction)),"p.adjust"] <- p.adjust.new(
  cortical_thickness_general_disorder_interaction[!grepl("global", row.names(cortical_thickness_general_disorder_interaction)),"p.value"], 
  method = "fdr"
)
cortical_thickness_general_disorder_interaction[grepl("global", row.names(cortical_thickness_general_disorder_interaction)),"p.adjust"] <- 
  cortical_thickness_general_disorder_interaction[grepl("global", row.names(cortical_thickness_general_disorder_interaction)),"p.value"] 
  
  ## Cortical Area ----
  
  sig_disorder_sex_interaction <- unique(df_disorder_sex_interactions$brain_phenotype[df_disorder_sex_interactions$brain_structure_type == "Regional Cortical Area" & df_disorder_sex_interactions$p < 0.05])
  
  sig_disorder_sex_interaction_bilateral <- sig_disorder_sex_interaction[!grepl("left|right", sig_disorder_sex_interaction)]
  sig_disorder_sex_interaction_unilateral <- sig_disorder_sex_interaction[grepl("left|right", sig_disorder_sex_interaction)]
  
  if (length(sig_disorder_sex_interaction) > 0){
    if(length(sig_disorder_sex_interaction_bilateral)){
      cortical_area_disorder_interaction <- bilateral_interaction(
        dependent = sig_disorder_sex_interaction_bilateral,
        independent = "depression", 
        interaction_terms = "chronic_pain_status",
        sex_interaction = FALSE, 
        sex_variable = "sex",
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
        hemisphere_col = "hemi",
        structural_subtype = "Regional Cortical Area",
        id_col = "f.eid"
)
    } else{
      cortical_area_disorder_interaction <- data.frame()
    }
    
    if(length(sig_disorder_sex_interaction_unilateral) > 0){
  cortical_area_disorder_interaction <- rbind(
    cortical_area_disorder_interaction,
    unilateral_interaction(
      dependent = sig_disorder_sex_interaction_unilateral,
      independent = "depression",
      sex_variable = "sex",
      covariates = brain_structure_covariates_T1_no_sex,
      dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
      structural_subtype = "Regional Cortical Area",
      sex_interaction = FALSE,
      interaction_terms = "chronic_pain_status"
      )
    )
    }
  } else{
      cortical_area_disorder_interaction <- data.frame()
  }
  ## Adjust pvalues
  cortical_area_disorder_interaction$p.adjust <- p.adjust.new(cortical_area_disorder_interaction$p.value, method = "fdr")
  
  sig_disorder_sex_interaction_general <- cortical_area_general[cortical_area_general %in% unique(df_disorder_sex_interactions$brain_phenotype[df_disorder_sex_interactions$brain_structure_type == "Global and Lobal Cortical Area" & df_disorder_sex_interactions$p < 0.05])]
  
  if (length(sig_disorder_sex_interaction_general) > 0){
    cortical_area_general_disorder_interaction <- unilateral_interaction(
  dependent = sig_disorder_sex_interaction_general,
  independent = "depression", 
  interaction_terms = "chronic_pain_status",
  sex_interaction = FALSE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
  structural_subtype = "Global and Lobal Cortical Area"
)
  } else{
    cortical_area_general_disorder_interaction <- data.frame()
  }
  
  cortical_area_general_disorder_interaction[!grepl("global", row.names(cortical_area_general_disorder_interaction)),"p.adjust"] <- p.adjust.new(
  cortical_area_general_disorder_interaction[!grepl("global", row.names(cortical_area_general_disorder_interaction)),"p.value"], 
  method = "fdr"
)
cortical_area_general_disorder_interaction[grepl("global", row.names(cortical_area_general_disorder_interaction)),"p.adjust"] <- 
  cortical_area_general_disorder_interaction[grepl("global", row.names(cortical_area_general_disorder_interaction)),"p.value"] 
  

  ## FA ----
  
  sig_disorder_sex_interaction <- unique(df_disorder_sex_interactions$brain_phenotype[df_disorder_sex_interactions$brain_structure_type == "Fractional Anisotropy" & df_disorder_sex_interactions$p < 0.05])
  
    sig_disorder_sex_interaction_bilateral <- sig_disorder_sex_interaction[sig_disorder_sex_interaction %in% FA_bilateral]
    sig_disorder_sex_interaction_unilateral <- c(sig_disorder_sex_interaction[grepl("left|right", sig_disorder_sex_interaction)], sig_disorder_sex_interaction[sig_disorder_sex_interaction %in% FA_unilateral])
    
  if (length(sig_disorder_sex_interaction) > 0){
    if(length(sig_disorder_sex_interaction_bilateral)){
      FA_disorder_interaction <- bilateral_interaction(
        dependent = sig_disorder_sex_interaction_bilateral,
        independent = "depression", 
        interaction_terms = "chronic_pain_status",
        sex_interaction = FALSE, 
        sex_variable = "sex",
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
        hemisphere_col = "hemi",
        structural_subtype = "Fractional Anisotropy",
        id_col = "f.eid"
)
    } else{
      FA_disorder_interaction <- data.frame()
    }
    
    if(length(sig_disorder_sex_interaction_unilateral) > 0){
  FA_disorder_interaction <- rbind(
    FA_disorder_interaction,
    unilateral_interaction(
      dependent = sig_disorder_sex_interaction_unilateral,
      independent = "depression",
      sex_variable = "sex",
      covariates = brain_structure_covariates_T1_no_sex,
      dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
      structural_subtype = "Fractional Anisotropy",
      sex_interaction = FALSE,
      interaction_terms = "chronic_pain_status"
      )
    )
    }
  } else{
      FA_disorder_interaction <- data.frame()
  }
  ## Adjust pvalues
  FA_disorder_interaction$p.adjust <- p.adjust.new(FA_disorder_interaction$p.value, method = "fdr")
  
  sig_disorder_sex_interaction_general <- unique(df_disorder_sex_interactions$brain_phenotype[df_disorder_sex_interactions$brain_structure_type == "General Fractional Anisotropy" & df_disorder_sex_interactions$p < 0.05])
  
  if (length(sig_disorder_sex_interaction_general) > 0){
    FA_general_disorder_interaction <- unilateral_interaction(
  dependent = sig_disorder_sex_interaction_general,
  independent = "depression", 
  interaction_terms = "chronic_pain_status",
  sex_interaction = FALSE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
  structural_subtype = "General Fractional Anisotropy"
)
  } else{
    FA_general_disorder_interaction <- data.frame()
  }
  
  FA_general_disorder_interaction[!grepl("global", row.names(FA_general_disorder_interaction)),"p.adjust"] <- p.adjust.new(
  FA_general_disorder_interaction[!grepl("global", row.names(FA_general_disorder_interaction)),"p.value"], 
  method = "fdr"
)
  FA_general_disorder_interaction[grepl("global", row.names(FA_general_disorder_interaction)),"p.adjust"] <- 
  FA_general_disorder_interaction[grepl("global", row.names(FA_general_disorder_interaction)),"p.value"] 
  

  ## MD ----
  
  sig_disorder_sex_interaction <- unique(df_disorder_sex_interactions$brain_phenotype[df_disorder_sex_interactions$brain_structure_type == "Mean Diffusivity" & df_disorder_sex_interactions$p < 0.05])
  
    sig_disorder_sex_interaction_bilateral <- sig_disorder_sex_interaction[sig_disorder_sex_interaction %in% MD_bilateral]
    sig_disorder_sex_interaction_unilateral <- c(sig_disorder_sex_interaction[grepl("left|right", sig_disorder_sex_interaction)], sig_disorder_sex_interaction[sig_disorder_sex_interaction %in% MD_unilateral])
    
  if (length(sig_disorder_sex_interaction) > 0){
    if(length(sig_disorder_sex_interaction_bilateral)){
      MD_disorder_interaction <- bilateral_interaction(
        dependent = sig_disorder_sex_interaction_bilateral,
        independent = "depression", 
        interaction_terms = "chronic_pain_status",
        sex_interaction = FALSE, 
        sex_variable = "sex",
        covariates = brain_structure_covariates_T1_no_sex,
        dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)),
        hemisphere_col = "hemi",
        structural_subtype = "Mean Diffusivity",
        id_col = "f.eid"
)
    } else{
      MD_disorder_interaction <- data.frame()
    }
    
    if(length(sig_disorder_sex_interaction_unilateral) > 0){
  MD_disorder_interaction <- rbind(
    MD_disorder_interaction,
    unilateral_interaction(
      dependent = sig_disorder_sex_interaction_unilateral,
      independent = "depression",
      sex_variable = "sex",
      covariates = brain_structure_covariates_T1_no_sex,
      dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
      structural_subtype = "Mean Diffusivity",
      sex_interaction = FALSE,
      interaction_terms = "chronic_pain_status"
      )
    )
    }
  } else{
      MD_disorder_interaction <- data.frame()
  }
  ## Adjust pvalues
  MD_disorder_interaction$p.adjust <- p.adjust.new(MD_disorder_interaction$p.value, method = "fdr")
  
  sig_disorder_sex_interaction_general <- unique(df_disorder_sex_interactions$brain_phenotype[df_disorder_sex_interactions$brain_structure_type == "General Mean Diffusivity" & df_disorder_sex_interactions$p < 0.05])
  
  if (length(sig_disorder_sex_interaction_general) > 0){
    MD_general_disorder_interaction <- unilateral_interaction(
  dependent = sig_disorder_sex_interaction_general,
  independent = "depression", 
  interaction_terms = "chronic_pain_status",
  sex_interaction = FALSE, 
  sex_variable = "sex",
  covariates = brain_structure_covariates_T1_no_sex,
  dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)),
  structural_subtype = "General Mean Diffusivity"
)
  } else{
    MD_general_disorder_interaction <- data.frame()
  }
  
  MD_general_disorder_interaction[!grepl("global", row.names(MD_general_disorder_interaction)),"p.adjust"] <- p.adjust.new(
  MD_general_disorder_interaction[!grepl("global", row.names(MD_general_disorder_interaction)),"p.value"], 
  method = "fdr"
)
  MD_general_disorder_interaction[grepl("global", row.names(MD_general_disorder_interaction)),"p.adjust"] <- 
  MD_general_disorder_interaction[grepl("global", row.names(MD_general_disorder_interaction)),"p.value"] 

  ## Combine association results
  all_assoc <- do.call("rbind", list(subcortical_volume_disorder_interaction, cortical_volume_disorder_interaction, cortical_area_disorder_interaction, cortical_thickness_disorder_interaction, cortical_area_general_disorder_interaction, cortical_thickness_general_disorder_interaction, cortical_volume_general_disorder_interaction, FA_disorder_interaction, FA_general_disorder_interaction, MD_disorder_interaction, MD_general_disorder_interaction))
  
  assign(paste0("CP_MDD_structure_disorder_interaction_", sex), all_assoc)
}
```

## Save results
```{r Save output}
## Save output
write.csv(CP_MDD_structure_assoc_all, paste0(work_dir,"/output/CP_MDD_structure_assoc_all.csv"), quote = FALSE, row.names = FALSE)

write.csv(CP_MDD_structure_sex_interaction_all, paste0(work_dir,"/output/CP_MDD_structure_sex_interaction_all.csv"), quote = FALSE, row.names = FALSE)

write.csv(CP_MDD_structure_assoc_female, paste0(work_dir,"/output/CP_MDD_structure_assoc_female.csv"), quote = FALSE, row.names = FALSE)

write.csv(CP_MDD_structure_assoc_male, paste0(work_dir,"/output/CP_MDD_structure_assoc_male.csv"), quote = FALSE, row.names = FALSE)

write.csv(CP_MDD_structure_disorder_interaction_all, paste0(work_dir,"/output/CP_MDD_structure_disorder_interaction_all.csv"), quote = FALSE, row.names = FALSE)

write.csv(CP_MDD_structure_disorder_sex_interaction_all, paste0(work_dir,"/output/CP_MDD_structure_disorder_sex_interaction_all.csv"), quote = FALSE, row.names = FALSE)

write.csv(CP_MDD_structure_disorder_interaction_female, paste0(work_dir,"/output/CP_MDD_structure_disorder_interaction_female.csv"), quote = FALSE, row.names = FALSE)

write.csv(CP_MDD_structure_disorder_interaction_male, paste0(work_dir,"/output/CP_MDD_structure_disorder_interaction_male.csv"), quote = FALSE, row.names = FALSE)

write.csv(descriptives_df, paste0(work_dir,"/output/descriptives.csv"), quote = TRUE, row.names = FALSE)
```














<!-- ## Function to analyze unilateral brain structures in groups -->
<!-- unilateral_structure_assoc_group <- function(dependent, independent, covariates, dataset, n_comparisons, structural_subtype){ -->

<!--   ## Input: -->
<!--   ## dependent: names of dependent variables -->
<!--   ## independent: name of independent variable -->
<!--   ## covariates: array of covariates -->
<!--   ## dataset: df contating data -->
<!--   ## n_comparisons: number of multiple comparisons to account for -->
<!--   ## structural_subtype: name of structural subtype being analysed -->

<!--   ## Create dataframe to store association analysis output -->
<!--   output <-  data.frame(brain_phenotype=character(), groups=character(), beta=numeric(), std=numeric(), p.value=numeric(),p.adjust=numeric(), Lower_95CI=numeric(), Upper_95CI=numeric(), n=numeric()) -->

<!--   for (i in 1:length(dependent)){ -->

<!--     mod <- paste0(dependent[i], "~", independent,  "+" ,  paste(covariates, collapse = " + ")) -->

<!--     anova1 <- aov(as.formula(mod), -->
<!--                 data = dataset) -->

<!--     ## If significant between group difference found, carry out pairwise assoication -->
<!--     if (summary(anova1)[[1]][independent, "Pr(>F)"] < 0.05){ -->

<!--       emmeans1 <- emmeans(anova1, specs = pairwise ~ comorbidity_group, adjust = "none") -->

<!--       output[rep(dependent[i], 6), "brain_phenotype"] <-  dependent[i] -->
<!--       output[output$brain_phenotype == dependent[i], "groups"] <-  as.data.frame(emmeans1$contrasts)[1] -->
<!--       output[output$brain_phenotype == dependent[i], "beta"] <-  as.data.frame(emmeans1$contrasts)["estimate"] -->
<!--       output[output$brain_phenotype == dependent[i], "std"] <-  as.data.frame(emmeans1$contrasts)["SE"] -->
<!--       output[output$brain_phenotype == dependent[i], "p.value"] <-  as.data.frame(emmeans1$contrasts)["p.value"] -->
<!--       output[output$brain_phenotype == dependent[i], c("Lower_95CI", "Upper_95CI")] <- confint(emmeans1$contrasts)[c(5,6)] -->
<!--       output[output$brain_phenotype == dependent[i], c("n")] <- nobs(anova1) -->

<!--     }else{ -->
<!--       ## Do nothing -->
<!--     } -->
<!--   } -->

<!--   ## If some significant differences were detected between groups, apply p-value adjustment -->
<!--   if(nrow(output) > 0){ -->

<!--     ## Adjust p-value -->
<!--     output$p.adjust[!grepl("global|Global", output$brain_phenotype)] <- p.adjust.new(output$p.value[!grepl("global|Global", output$brain_phenotype)], method = "fdr", n = nrow(output)) -->

<!--     ## Check if global measures present -->
<!--     if(any(grepl("global|Global", output$brain_phenotype))){ -->
<!--       ## Iterate through each gloabl measute and addjust for group comparison -->
<!--       for (global_measure in unique(grep("global|Global", output$brain_phenotype, value = T))){ -->
<!--         output$p.adjust[output$brain_phenotype == global_measure] <- p.adjust.new(output$p.value[output$brain_phenotype == global_measure], method = "fdr", n = 6) -->
<!--       } -->
<!--     } -->

<!--     ## Add column indicating brain strucutre sup type being analysed -->
<!--     output$brain_structure_type <- structural_subtype -->

<!--     }else{ -->
<!--       ## Do nothing -->
<!--     } -->
<!--   return(output) -->
<!-- } -->

<!-- ## Function to analyze hemisphere interaction in groups -->
<!-- hemisphere_interaction_group <- function(dependent, independent, covariates, dataset, hemisphere_col, structural_subtype){ -->

<!--   ## Input: -->
<!--   ## dependent: names of dependent variables -->
<!--   ## independent: name of independent variable -->
<!--   ## covariates: array of covariates -->
<!--   ## dataset: df contating data -->
<!--   ## hemisphere_col: name of hemisphere column -->
<!--   ## structural_subtype: name of structural subtype being analysed -->

<!--   ## Create dataframe to store interaction analysis output -->
<!--   output <- data.frame(interaction_p=numeric()) -->
<!--   ## Run interaction analysis -->
<!--   for (i in dependent){ -->

<!--     mod <- paste0("`",i,"`", "~", independent, " + ", independent , ":", hemisphere_col, "+", paste(covariates, collapse = " + ")) -->

<!--     ## Carry out interaction analysis -->
<!--     anova1 <- aov(as.formula(mod), data = dataset) -->

<!--     output[i,"brain_phenotype"] <- i -->
<!--     output[i,"interaction_p"] <- summary(anova1)[[1]]["comorbidity_group:hemi", "Pr(>F)"] -->
<!--   } -->

<!--   ## Adjust p-value -->
<!--   #output$interaction_p_adjust <- p.adjust.new(output$interaction_p, method = "fdr", n = n_comparisons) -->
<!--   #output$interaction_p_adjust <- output$interaction_p -->

<!--   ## If statement to notify if any significant interactions are present -->
<!--   if (any(output$interaction_p < 0.05)){ -->
<!--     return(row.names(output)[output$interaction_p < 0.05]) -->
<!--   }else{ -->
<!--   } -->
<!-- } -->

<!-- ## Function to analyze bilateral brain structures in groups -->
<!-- bilateral_structure_assoc_group <- function(dependent, independent, covariates, dataset, n_comparisons, hemisphere_col, id_col, structural_subtype){ -->

<!--   ## Input: -->
<!--   ## dependent: names of dependent variables -->
<!--   ## independent: name of independent variable -->
<!--   ## covariates: array of covariates -->
<!--   ## dataset: df contating data -->
<!--   ## n_comparisons: number of multiple comparisons to account for -->
<!--   ## hemisphere_col: name of hemisphere column -->
<!--   ## id_col: name of ID column -->
<!--   ## structural_subtype: name of structural subtype being analysed -->

<!--   ## Create dataframe to store association analysis output -->
<!--   output <-  data.frame(brain_phenotype=character(), groups=character(), beta=numeric(), std=numeric(), p.value=numeric(),p.adjust=numeric(), Lower_95CI=numeric(), Upper_95CI=numeric(), n=numeric()) -->

<!--   ## Run association analysis using lme -->
<!--   for (i in 1:length(dependent)){ -->

<!--     mod <- paste0("`",dependent[i],"`","~", independent , "+", paste(covariates, collapse = " + "),"+", hemisphere_col ," +(1 |" , id_col,")") -->

<!--     lme1 <- lmerTest::lmer(as.formula(as.character(mod)),data=dataset, -->
<!--                  na.action=na.exclude) -->

<!--     anova1 <- anova(lme1) -->

<!--     ## If significant between group difference found, carry out pairwise assoication -->
<!--     if (anova1[independent, "Pr(>F)"] < 0.05){ -->

<!--       emmeans1 <- emmeans(lme1, list(pairwise ~ comorbidity_group), adjust = "none") -->

<!--       output[rep(dependent[i], 6), "brain_phenotype"] <-  dependent[i] -->
<!--       output[output$brain_phenotype == dependent[i], "groups"] <-  as.data.frame(emmeans1$`pairwise differences of comorbidity_group`)[[1]] -->
<!--       output[output$brain_phenotype == dependent[i], "beta"] <-  as.data.frame(emmeans1$`pairwise differences of comorbidity_group`)["estimate"] -->
<!--       output[output$brain_phenotype == dependent[i], "std"] <-  as.data.frame(emmeans1$`pairwise differences of comorbidity_group`)["SE"] -->
<!--       output[output$brain_phenotype == dependent[i], "p.value"] <-  as.data.frame(emmeans1$`pairwise differences of comorbidity_group`)["p.value"] -->
<!--       output[output$brain_phenotype == dependent[i], c("Lower_95CI", "Upper_95CI")] <- confint(emmeans1)$`pairwise differences of comorbidity_group`[c(5,6)] -->
<!--       output[output$brain_phenotype == dependent[i], c("n")] <- sapply(ranef(lme1),nrow) -->

<!--     }else{ -->
<!--       ## Do nothing -->
<!--     } -->
<!--   } -->

<!--   ## If some significant differences were detected between groups, apply p-value adjustment -->
<!--   if(nrow(output) > 0){ -->

<!--     ## Adjust p-value -->
<!--     output$p.adjust <- p.adjust.new(output$p.value, method = "fdr", n = nrow(output)) -->

<!--     ## Add column indicating brain strucutre sup type being analysed -->
<!--     output$brain_structure_type <- structural_subtype -->

<!--     }else{ -->
<!--       ## Do nothing -->
<!--     } -->
<!--   return(output) -->
<!-- } -->

<!-- bilateral_interaction_group <- function(dependent, independent, interaction_variable, covariates, dataset, hemisphere_col, id_col, structural_subtype){ -->

<!--   ## Input: -->
<!--   ## dependent: names of dependent variables -->
<!--   ## independent: name of independent variable -->
<!--   ## interaction_variable: name of sex variable -->
<!--   ## covariates: array of covariates -->
<!--   ## dataset: df contating data -->
<!--   ## hemisphere_col: name of hemisphere column -->
<!--   ## id_col: name of ID column -->
<!--   ## structural_subtype: name of structural subtype being analysed -->

<!--   ## Create dataframe to store interaction analysis output -->
<!--   output <- data.frame() -->
<!--   ## Run interaction analysis -->
<!--   for (i in dependent){ -->


<!--     ## Carry out interaction analysis -->

<!--     ## Define formula -->
<!--     mod <- paste0(i,""," ~ ", independent, " + ", independent , ":", interaction_variable, " + ", paste0(c(covariates, hemisphere_col), collapse = paste0(":", interaction_variable, " + ")), ":", interaction_variable, " +(1 |" , id_col, ")") -->

<!--     ## Interaction analysis -->
<!--     lme1 <- lmerTest::lmer(as.formula(as.character(mod)),data=dataset, -->
<!--                        na.action=na.exclude) -->

<!--     anova1 <- anova(lme1) -->

<!--     ## If significant between group difference found, carry out pairwise assoication -->
<!--     if (anova1[paste0(independent, ":", interaction_variable), "Pr(>F)"] < 0.05){ -->

<!--       emmeans1 <- emmeans(lme1, list(pairwise ~  comorbidity_group:sex), adjust = "none") -->
<!--       contrast1 <- contrast(emmeans1, interaction = "pairwise") -->

<!--       output[rep(i,6), "brain_phenotype"] <- i -->
<!--       output[output$brain_phenotype == i,"groups"] <- as.data.frame(contrast1)$comorbidity_group_pairwise -->
<!--       output[output$brain_phenotype == i,"contrast"] <- as.data.frame(contrast1)$sex_pairwise -->
<!--       output[output$brain_phenotype == i, "beta"] <- as.data.frame(contrast1)$estimate -->
<!--       output[output$brain_phenotype == i, "std"] <- as.data.frame(contrast1)$SE -->
<!--       output[output$brain_phenotype == i, "p.value"] <- as.data.frame(contrast1)$p.value -->

<!--       ## Add column indicating brain strucutre sup type being analysed -->
<!--       output$brain_structure_type <- structural_subtype -->

<!--     }else{ -->
<!--       ## Do nothing -->
<!--     } -->
<!--   } -->
<!--   return(output) -->
<!-- } -->

<!-- unilateral_interaction_group <- function(dependent, independent, interaction_variable, covariates, dataset, structural_subtype){ -->

<!--   ## Input: -->
<!--   ## dependent: names of dependent variables -->
<!--   ## independent: name of independent variable -->
<!--   ## interaction_variable: name of sex variable -->
<!--   ## covariates: array of covariates -->
<!--   ## dataset: df contating data -->
<!--   ## structural_subtype: name of structural subtype being analysed -->

<!--   ## Create dataframe to store interaction analysis output -->
<!--   output <- data.frame() -->
<!--   ## Run interaction analysis -->
<!--   for (i in dependent){ -->


<!--     ## Carry out interaction analysis -->

<!--     ## Define formula -->
<!--     mod <- paste0(i," ~ ", independent, " + ", independent , ":", interaction_variable, " + ", paste0(covariates, collapse = paste0(":", interaction_variable, " + ")), ":", interaction_variable) -->

<!--     ## Interaction analysis -->
<!--     anova1 <- aov(as.formula(mod), -->
<!--                   data = dataset) -->

<!--     ## If significant between group difference found, carry out pairwise assoication -->
<!--     if (summary(anova1)[[1]][paste0(independent, ":", interaction_variable), "Pr(>F)"] < 0.05){ -->

<!--       emmeans1 <- emmeans(anova1, list(pairwise ~  comorbidity_group:sex), adjust = "none") -->
<!--       contrast1 <- contrast(emmeans1, interaction = "pairwise") -->

<!--       output[rep(i,6), "brain_phenotype"] <- i -->
<!--       output[output$brain_phenotype == i,"groups"] <- as.data.frame(contrast1)$comorbidity_group_pairwise -->
<!--       output[output$brain_phenotype == i,"contrast"] <- as.data.frame(contrast1)$sex_pairwise -->
<!--       output[output$brain_phenotype == i, "beta"] <- as.data.frame(contrast1)$estimate -->
<!--       output[output$brain_phenotype == i, "std"] <- as.data.frame(contrast1)$SE -->
<!--       output[output$brain_phenotype == i, "p.value"] <- as.data.frame(contrast1)$p.value -->

<!--       ## Add column indicating brain strucutre sup type being analysed -->
<!--       output$brain_structure_type <- structural_subtype -->

<!--     }else{ -->
<!--       ## Do nothing -->
<!--     } -->
<!--   } -->

<!--   return(output) -->
<!-- } -->



<!-- ## Carry out association for comorbidity groups -->
<!-- ```{r association in comorbidity groups} -->

<!-- ## Set CP-MDD- as reference group -->
<!-- UKB_CP_MDD_imaging_covariates_long$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_long$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain")  -->
<!-- UKB_CP_MDD_imaging_covariates$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain")  -->


<!-- ##Subcortical Volume ---- -->
<!-- ## flag if any bilateral hemisphere measurements need to be analyzed separately -->
<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = sub_cortical_volume_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_T1, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Regional Subcortical Volume") -->


<!-- subcortical_volume_assoc <- bilateral_structure_assoc_group(dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_T1, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          n_comparisons =  length(sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Regional Subcortical Volume", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   subcortical_volume_assoc <- rbind(subcortical_volume_assoc, -->
<!--                                     unilateral_structure_assoc_group(dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                                                                independent = "comorbidity_group", -->
<!--                                                                covariates = brain_structure_covariates_T1, -->
<!--                                                                dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                                                                n_comparisons = length(sub_cortical_volume_bilateral), ## Adjusted for after -->
<!--                                                                structural_subtype = "Regional Subcortical Volume") -->
<!--   ) -->

<!--   ## Adjust pvalues -->
<!--   subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr") -->
<!-- } -->

<!-- ## Cortical Volume ---- -->

<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_volume_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_T1, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Regional Cortical Volume") -->

<!-- cortical_volume_assoc <- bilateral_structure_assoc_group(dependent =  cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_T1, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          n_comparisons =  length(cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Regional Cortical Volume", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   cortical_volume_assoc <- rbind(cortical_volume_assoc, -->
<!--                                     unilateral_structure_assoc_group( -->
<!--                                       dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                                       independent = "comorbidity_group", -->
<!--                                       covariates = brain_structure_covariates_T1, -->
<!--                                       dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                                       n_comparisons = length(sub_cortical_volume_bilateral), ## Adjusted for after -->
<!--                                       structural_subtype = "Regional Cortical Volume") -->
<!--   ) -->

<!--   ## Adjust pvalues -->
<!--   cortical_volume_assoc$p.adjust <- p.adjust.new(cortical_volume_assoc$p.value, method = "fdr") -->
<!-- } -->


<!-- cortical_volume_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_volume_general, -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_T1, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                          n_comparisons = length(cortical_volume_general) -1, -->
<!--                          structural_subtype = "Global and Lobal Cortical Volume") -->


<!-- ## Cortical Thickness ---- -->

<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_thickness_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_T1, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Regional Cortical Thickness") -->

<!-- cortical_thickness_assoc <- bilateral_structure_assoc_group(dependent =  cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_T1, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          n_comparisons = length(cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Regional Cortical Thickness", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   cortical_thickness_assoc <- rbind(cortical_thickness_assoc, -->
<!--                                     unilateral_structure_assoc_group( -->
<!--                                       dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                                       independent = "comorbidity_group", -->
<!--                                       covariates = brain_structure_covariates_T1, -->
<!--                                       dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                                       n_comparisons = length(sub_cortical_thickness_bilateral), ## Adjusted for after -->
<!--                                       structural_subtype = "Regional Cortical Thickness") -->
<!--   ) -->

<!--   ## Adjust pvalues -->
<!--   cortical_thickness_assoc$p.adjust <- p.adjust.new(cortical_thickness_assoc$p.value, method = "fdr") -->
<!-- } -->

<!-- cortical_thickness_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_thickness_general, -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_T1, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                          n_comparisons = length(cortical_thickness_general) -1, -->
<!--                          structural_subtype = "Global and Lobal Cortical Thickness") -->

<!-- ## Cortical Area ---- -->

<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_area_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_T1, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Regional Cortical Area") -->

<!-- cortical_area_assoc <- bilateral_structure_assoc_group(dependent =  cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_T1, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          n_comparisons = length(cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Regional Cortical Area", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   cortical_area_assoc <- rbind(cortical_area_assoc, -->
<!--                                     unilateral_structure_assoc_group(dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                                                                independent = "comorbidity_group", -->
<!--                                                                covariates = brain_structure_covariates_T1, -->
<!--                                                                dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                                                                n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after -->
<!--                                                                structural_subtype = "Regional Cortical Area") -->
<!--   ) -->

<!--   ## Adjust pvalues -->
<!--   cortical_area_assoc$p.adjust <- p.adjust.new(cortical_area_assoc$p.value, method = "fdr") -->
<!-- } -->

<!-- cortical_area_general_assoc <- unilateral_structure_assoc_group(dependent = cortical_area_general, -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_T1, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                          n_comparisons = length(cortical_area_general) -1, -->
<!--                          structural_subtype = "Global and Lobal Cortical Area") -->


<!-- ##FA ---- -->

<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = FA_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_diffusion, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Fractional Anisotropy") -->


<!-- FA_bilateral_assoc <- bilateral_structure_assoc_group(dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_diffusion, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Fractional Anisotropy", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   FA_bilateral_assoc <- rbind(FA_bilateral_assoc, -->
<!--                         unilateral_structure_assoc_group(dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                         independent = "comorbidity_group", -->
<!--                         covariates = brain_structure_covariates_T1, -->
<!--                         dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                         n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after -->
<!--                         structural_subtype = "Fractional Anisotropy") -->
<!--   ) -->

<!--   ## Adjust pvalues -->
<!--   FA_bilateral_assoc$p.adjust <- p.adjust.new(FA_bilateral_assoc$p.value, method = "fdr") -->
<!-- } -->


<!-- FA_unilateral_assoc <- unilateral_structure_assoc_group(dependent = FA_unilateral, -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_diffusion, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                          n_comparisons = length(FA_unilateral), -->
<!--                          structural_subtype = "Fractional Anisotropy") -->


<!-- FA_general_assoc <- unilateral_structure_assoc_group(dependent = FA_general, -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_diffusion, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                          n_comparisons = length(FA_general) -1, -->
<!--                          structural_subtype = "General Fractional Anisotropy") -->

<!-- ##MD ---- -->

<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = MD_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_diffusion, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Mean Diffusivity") -->

<!-- MD_bilateral_assoc <- bilateral_structure_assoc_group(dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_diffusion, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Mean Diffusivity", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   MD_bilateral_assoc <- rbind(MD_bilateral_assoc, -->
<!--                         unilateral_structure_assoc_group(dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                         independent = "comorbidity_group", -->
<!--                         covariates = brain_structure_covariates_T1, -->
<!--                         dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                         n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after -->
<!--                         structural_subtype = "Mean Diffusivity") -->
<!--   ) -->

<!--   ## Adjust pvalues -->
<!--   FA_bilateral_assoc$p.adjust <- p.adjust.new(FA_bilateral_assoc$p.value, method = "fdr") -->
<!-- } -->

<!-- MD_unilateral_assoc <- unilateral_structure_assoc_group(dependent = MD_unilateral, -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_diffusion, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                          n_comparisons = length(MD_unilateral), -->
<!--                          structural_subtype = "Mean Diffusivity") -->

<!-- MD_general_assoc <- unilateral_structure_assoc_group(dependent = MD_general, -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_diffusion, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                          n_comparisons = length(MD_general) -1, -->
<!--                          structural_subtype = "General Mean Diffusivity") -->

<!-- ## Combine association results -->
<!-- comorbidity_structure_assoc_all <- do.call("rbind", list(subcortical_volume_assoc, cortical_volume_assoc, cortical_area_assoc, cortical_thickness_assoc, cortical_area_general_assoc, cortical_thickness_general_assoc, cortical_volume_general_assoc, FA_bilateral_assoc, FA_general_assoc, FA_unilateral_assoc, MD_bilateral_assoc, MD_general_assoc, MD_unilateral_assoc)) -->

<!-- ## Add column indicating disorder -->
<!-- comorbidity_structure_assoc_all$disorder<- "comorbidity" -->
<!-- ``` -->

<!-- ## Carry out sex interaction for comorbidity groups -->
<!-- ```{r association in comorbidity groups} -->

<!-- ##Subcortical Volume ---- -->
<!-- ## flag if any bilateral hemisphere measurements need to be analyzed separately -->
<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = sub_cortical_volume_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_T1, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Regional Subcortical Volume") -->


<!-- subcortical_volume_sex_interaction <- bilateral_interaction_group(dependent = sub_cortical_volume_bilateral[!sub_cortical_volume_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          interaction_variable = "sex", -->
<!--                          covariates = brain_structure_covariates_T1_no_sex, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Regional Subcortical Volume", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   subcortical_volume_sex_interaction <- rbind(subcortical_volume_sex_interaction, -->
<!--                                     unilateral_interaction_group( -->
<!--                                       dependent = c(paste0(hemisphere_interactions, "_right"), -->
<!--                                                     paste0(hemisphere_interactions, "_left")), -->
<!--                                       independent = "comorbidity_group", -->
<!--                                       interaction_variable = "sex", -->
<!--                                       covariates = brain_structure_covariates_T1_no_sex, -->
<!--                                       dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                                       structural_subtype = "Regional Subcortical Volume") -->
<!--   ) -->
<!-- } -->

<!-- ## Cortical Volume ---- -->

<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_volume_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_T1, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Regional Cortical Volume") -->

<!-- cortical_volume_sex_interaction <- bilateral_interaction_group(dependent =  cortical_volume_bilateral[!cortical_volume_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          interaction_variable = "sex", -->
<!--                          covariates = brain_structure_covariates_T1_no_sex, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Regional Cortical Volume", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   cortical_volume_sex_interaction <- rbind(cortical_volume_sex_interaction, -->
<!--                                     unilateral_interaction_group( -->
<!--                                       dependent = c(paste0(hemisphere_interactions, "_right"), -->
<!--                                                     paste0(hemisphere_interactions, "_left")), -->
<!--                                       independent = "comorbidity_group", -->
<!--                                       covariates = brain_structure_covariates_T1_no_sex, -->
<!--                                       interaction_variable = "sex", -->
<!--                                       dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                                       structural_subtype = "Regional Cortical Volume") -->
<!--                                  ) -->
<!--   } -->


<!-- cortical_volume_general_sex_interaction <- unilateral_interaction_group(dependent = cortical_volume_general, -->
<!--                                                                   independent = "comorbidity_group", -->
<!--                                                                   covariates = brain_structure_covariates_T1_no_sex, -->
<!--                                                                   interaction_variable = "sex", -->
<!--                                                                   dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                                                                   structural_subtype = "Global and Lobal Cortical Volume") -->


<!-- ## Cortical Thickness ---- -->

<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_thickness_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_T1, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Regional Cortical Thickness") -->

<!-- cortical_thickness_sex_interaction <- bilateral_interaction_group(dependent =  cortical_thickness_bilateral[!cortical_thickness_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          interaction_variable = "sex", -->
<!--                          covariates = brain_structure_covariates_T1_no_sex, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Regional Cortical Thickness", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   cortical_thickness_sex_interaction <- rbind(cortical_thickness_sex_interaction, -->
<!--                                     unilateral_interaction_group( -->
<!--                                       dependent = c(paste0(hemisphere_interactions, "_right"), -->
<!--                                                     paste0(hemisphere_interactions, "_left")), -->
<!--                                       independent = "comorbidity_group", -->
<!--                                       covariates = brain_structure_covariates_T1_no_sex, -->
<!--                                       interaction_variable = "sex", -->
<!--                                       dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                                       structural_subtype = "Regional Cortical Thickness") -->
<!--                                  ) -->
<!--   } -->


<!-- cortical_thickness_general_sex_interaction <- unilateral_interaction_group(dependent = cortical_thickness_general, -->
<!--                                                                   independent = "comorbidity_group", -->
<!--                                                                   covariates = brain_structure_covariates_T1_no_sex, -->
<!--                                                                   interaction_variable = "sex", -->
<!--                                                                   dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                                                                   structural_subtype = "Global and Lobal Cortical Thickness") -->

<!-- ## Cortical Area ---- -->

<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = cortical_area_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_T1, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Regional Cortical Area") -->

<!-- cortical_area_sex_interaction <- bilateral_interaction_group(dependent =  cortical_area_bilateral[!cortical_area_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          interaction_variable = "sex", -->
<!--                          covariates = brain_structure_covariates_T1_no_sex, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Regional Cortical Area", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   cortical_area_sex_interaction <- rbind(cortical_area_sex_interaction, -->
<!--                                     unilateral_interaction_group( -->
<!--                                       dependent = c(paste0(hemisphere_interactions, "_right"), -->
<!--                                                     paste0(hemisphere_interactions, "_left")), -->
<!--                                       independent = "comorbidity_group", -->
<!--                                       covariates = brain_structure_covariates_T1_no_sex, -->
<!--                                       interaction_variable = "sex", -->
<!--                                       dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                                       structural_subtype = "Regional Cortical Area") -->
<!--                                  ) -->
<!--   } -->


<!-- cortical_area_general_sex_interaction <- unilateral_interaction_group(dependent = cortical_area_general, -->
<!--                                                                   independent = "comorbidity_group", -->
<!--                                                                   covariates = brain_structure_covariates_T1_no_sex, -->
<!--                                                                   interaction_variable = "sex", -->
<!--                                                                   dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                                                                   structural_subtype = "Global and Lobal Cortical Area") -->

<!-- ##FA ---- -->

<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = FA_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_diffusion, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Fractional Anisotropy") -->


<!-- FA_bilateral_interaction <- bilateral_interaction_group(dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                          interaction_variable = "sex", -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Fractional Anisotropy", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   FA_bilateral_interaction <- rbind(FA_bilateral_interaction, -->
<!--                         unilateral_interaction_group( -->
<!--                           dependent = c(paste0(hemisphere_interactions, "_right"), -->
<!--                                         paste0(hemisphere_interactions, "_left")), -->
<!--                         independent = "comorbidity_group", -->
<!--                         covariates = brain_structure_covariates_T1_no_sex, -->
<!--                         interaction_variable = "sex", -->
<!--                         dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                         structural_subtype = "Fractional Anisotropy") -->
<!--   ) -->
<!-- } -->

<!-- FA_unilateral_interaction <- unilateral_interaction_group(dependent = FA_unilateral, -->
<!--                          independent = "comorbidity_group", -->
<!--                          interaction_variable = "sex", -->
<!--                          covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                          structural_subtype = "Fractional Anisotropy") -->


<!-- FA_general_sex_interaction <- unilateral_interaction_group(dependent = FA_general, -->
<!--                          independent = "comorbidity_group", -->
<!--                          interaction_variable = "sex", -->
<!--                          covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                          structural_subtype = "General Fractional Anisotropy") -->

<!-- ##MD ---- -->

<!-- hemisphere_interactions <- hemisphere_interaction_group(dependent = MD_bilateral, -->
<!--                        independent = "comorbidity_group", -->
<!--                        covariates = brain_structure_covariates_diffusion, -->
<!--                        dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                        hemisphere_col = "hemi", -->
<!--                        structural_subtype = "Mean Diffusivity") -->


<!-- MD_bilateral_interaction <- bilateral_interaction_group(dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions], -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                          interaction_variable = "sex", -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates_long, -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Mean Diffusivity", -->
<!--                          id_col = "f.eid") -->

<!-- if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--   MD_bilateral_interaction <- rbind(MD_bilateral_interaction, -->
<!--                         unilateral_interaction_group( -->
<!--                           dependent = c(paste0(hemisphere_interactions, "_right"), -->
<!--                                         paste0(hemisphere_interactions, "_left")), -->
<!--                         independent = "comorbidity_group", -->
<!--                         covariates = brain_structure_covariates_T1_no_sex, -->
<!--                         interaction_variable = "sex", -->
<!--                         dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                         structural_subtype = "Mean Diffusivity") -->
<!--   ) -->
<!-- } -->

<!-- MD_unilateral_interaction <- unilateral_interaction_group(dependent = MD_unilateral, -->
<!--                          independent = "comorbidity_group", -->
<!--                          interaction_variable = "sex", -->
<!--                          covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                          structural_subtype = "Mean Diffusivity") -->


<!-- MD_general_sex_interaction <- unilateral_interaction_group(dependent = MD_general, -->
<!--                          independent = "comorbidity_group", -->
<!--                          interaction_variable = "sex", -->
<!--                          covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                          dataset = UKB_CP_MDD_imaging_covariates, -->
<!--                          structural_subtype = "General Mean Diffusivity") -->

<!-- ## Combine association results -->
<!-- comorbidity_structure_sex_interaction_all <- do.call("rbind", list(subcortical_volume_sex_interaction, cortical_volume_sex_interaction, cortical_area_sex_interaction, cortical_thickness_sex_interaction, cortical_area_general_sex_interaction, cortical_thickness_general_sex_interaction, cortical_volume_general_sex_interaction, FA_bilateral_interaction, FA_general_sex_interaction, FA_unilateral_interaction, MD_bilateral_interaction, MD_general_sex_interaction, MD_unilateral_interaction)) -->


<!-- ``` -->

<!-- ## Carry out sex-stratified association for comorbidity groups -->
<!-- ```{r sex-stratified assocaition in comorbidity groups} -->

<!-- ## Set CP-MDD- as reference group -->
<!-- UKB_CP_MDD_imaging_covariates_long_females$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_long_females$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") -->
<!-- UKB_CP_MDD_imaging_covariates_females$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_females$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") -->

<!-- ## Set CP-MDD- as reference group -->
<!-- UKB_CP_MDD_imaging_covariates_long_males$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_long_males$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") -->
<!-- UKB_CP_MDD_imaging_covariates_males$comorbidity_group <- relevel(factor(UKB_CP_MDD_imaging_covariates_males$comorbidity_group), ref = "No Probable Recurrent MDD + No Chronic Pain") -->

<!-- for (sex in c("females", "males")){ -->

<!--   sig_sex_interaction_bilateral <- unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Regional Subcortical Volume" & comorbidity_structure_sex_interaction_all$p < 0.05]) -->

<!--   if (length(sig_sex_interaction_bilateral) > 0){ -->

<!--   ##Subcortical Volume ---- -->
<!--   hemisphere_interactions <- hemisphere_interaction_group( -->
<!--     dependent = sig_sex_interaction_bilateral, -->
<!--     independent = "comorbidity_group", -->
<!--     covariates = brain_structure_covariates_T1_no_sex, -->
<!--     dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--     hemisphere_col = "hemi", -->
<!--     structural_subtype = "Regional Subcortical Volume") -->

<!--   if(!all(sig_sex_interaction_bilateral %in% hemisphere_interactions)){ -->

<!--       subcortical_volume_assoc <- bilateral_structure_assoc_group( -->
<!--         dependent = sig_sex_interaction_bilateral[!sig_sex_interaction_bilateral %in% hemisphere_interactions], -->
<!--         independent = "comorbidity_group", -->
<!--         covariates = brain_structure_covariates_T1_no_sex, -->
<!--         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--         n_comparisons = length(sig_sex_interaction_bilateral[!sig_sex_interaction_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--         hemisphere_col = "hemi", -->
<!--         structural_subtype = "Regional Subcortical Volume", -->
<!--         id_col = "f.eid") -->

<!--   } else{subcortical_volume_assoc <- data.frame()} -->

<!--     if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--       subcortical_volume_assoc <- rbind(subcortical_volume_assoc, -->
<!--                                         unilateral_structure_assoc_group( -->
<!--                                           dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                                           independent = "comorbidity_group", -->
<!--                                           covariates = brain_structure_covariates_T1_no_sex, -->
<!--                                           dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--                                           n_comparisons = length(sig_sex_interaction_bilateral), ## Adjusted for after -->
<!--                                           structural_subtype = "Regional Subcortical Volume") -->
<!--       ) -->

<!--       ## Adjust pvalues -->
<!--       subcortical_volume_assoc$p.adjust <- p.adjust.new(subcortical_volume_assoc$p.value, method = "fdr") -->
<!--     } -->
<!--   }else{subcortical_volume_assoc <- data.frame()} -->


<!--   ## Cortical Volume ---- -->

<!--   sig_sex_interaction_bilateral <- cortical_volume_bilateral[cortical_volume_bilateral %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Regional Cortical Volume" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--   if (length(sig_sex_interaction_bilateral) > 0){ -->

<!--     hemisphere_interactions <- hemisphere_interaction_group( -->
<!--       dependent = sig_sex_interaction_bilateral, -->
<!--       independent = "comorbidity_group", -->
<!--       covariates = brain_structure_covariates_T1_no_sex, -->
<!--       dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--       hemisphere_col = "hemi", -->
<!--       structural_subtype = "Regional Cortical Volume") -->

<!--     if(!all(sig_sex_interaction_bilateral %in% hemisphere_interactions)){ -->

<!--     cortical_volume_assoc <- bilateral_structure_assoc_group( -->
<!--       dependent = sig_sex_interaction_bilateral[!sig_sex_interaction_bilateral %in% hemisphere_interactions], -->
<!--       independent = "comorbidity_group", -->
<!--       covariates = brain_structure_covariates_T1_no_sex, -->
<!--       dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--       n_comparisons = length(sig_sex_interaction_bilateral[!sig_sex_interaction_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--       hemisphere_col = "hemi", -->
<!--       structural_subtype = "Regional Cortical Volume", -->
<!--       id_col = "f.eid") -->

<!--     } else{cortical_volume_assoc <- data.frame()} -->

<!--     if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--       cortical_volume_assoc <- rbind(cortical_volume_assoc, -->
<!--                                      unilateral_structure_assoc_group( -->
<!--                                        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                                         independent = "comorbidity_group", -->
<!--                                         covariates = brain_structure_covariates_T1_no_sex, -->
<!--                                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--                                         n_comparisons = length(sig_sex_interaction_bilateral), ## Adjusted for after -->
<!--                                         structural_subtype = "Regional Cortical Volume") -->
<!--       ) -->

<!--       ## Adjust pvalues -->
<!--       cortical_volume_assoc$p.adjust <- p.adjust.new(cortical_volume_assoc$p.value, method = "fdr") -->
<!--     } -->
<!--   } -->

<!--   sig_sex_interaction_general <- cortical_volume_general[cortical_volume_general %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Global and Lobal Cortical Volume" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--   if (length(sig_sex_interaction_general) > 0){ -->
<!--   cortical_volume_general_assoc <- unilateral_structure_assoc_group( -->
<!--     dependent = sig_sex_interaction_general, -->
<!--     independent = "comorbidity_group", -->
<!--     covariates = brain_structure_covariates_T1_no_sex, -->
<!--     dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--     n_comparisons = length(sig_sex_interaction_general), -->
<!--     structural_subtype = "Global and Lobal Cortical Volume") -->

<!--   } else{cortical_volume_general_assoc <- data.frame()} -->


<!--   # Cortical Thickness ---- -->

<!--   sig_sex_interaction_bilateral <- cortical_thickness_bilateral[cortical_thickness_bilateral %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Regional Cortical Thickness" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--   if (length(sig_sex_interaction_bilateral) > 0){ -->

<!--     hemisphere_interactions <- hemisphere_interaction_group( -->
<!--       dependent = sig_sex_interaction_bilateral, -->
<!--       independent = "comorbidity_group", -->
<!--       covariates = brain_structure_covariates_T1_no_sex, -->
<!--       dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--       hemisphere_col = "hemi", -->
<!--       structural_subtype = "Regional Cortical Thickness") -->

<!--     if(!all(sig_sex_interaction_bilateral %in% hemisphere_interactions)){ -->

<!--     cortical_thickness_assoc <- bilateral_structure_assoc_group( -->
<!--       dependent = sig_sex_interaction_bilateral[!sig_sex_interaction_bilateral %in% hemisphere_interactions], -->
<!--       independent = "comorbidity_group", -->
<!--       covariates = brain_structure_covariates_T1_no_sex, -->
<!--       dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--       n_comparisons = length(sig_sex_interaction_bilateral[!sig_sex_interaction_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--       hemisphere_col = "hemi", -->
<!--       structural_subtype = "Regional Cortical Thickness", -->
<!--       id_col = "f.eid") -->

<!--     } else{cortical_thickness_assoc <- data.frame()} -->

<!--     if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--       cortical_thickness_assoc <- rbind(cortical_thickness_assoc, -->
<!--                                      unilateral_structure_assoc_group( -->
<!--                                        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                                         independent = "comorbidity_group", -->
<!--                                         covariates = brain_structure_covariates_T1_no_sex, -->
<!--                                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--                                         n_comparisons = length(sig_sex_interaction_bilateral), ## Adjusted for after -->
<!--                                         structural_subtype = "Regional Cortical Thickness") -->
<!--       ) -->

<!--       ## Adjust pvalues -->
<!--       cortical_thickness_assoc$p.adjust <- p.adjust.new(cortical_thickness_assoc$p.value, method = "fdr") -->
<!--     } -->
<!--   } -->

<!--   sig_sex_interaction_general <- cortical_thickness_general[cortical_thickness_general %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Global and Lobal Cortical Thickness" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--   if (length(sig_sex_interaction_general) > 0){ -->
<!--   cortical_thickness_general_assoc <- unilateral_structure_assoc_group( -->
<!--     dependent = sig_sex_interaction_general, -->
<!--     independent = "comorbidity_group", -->
<!--     covariates = brain_structure_covariates_T1_no_sex, -->
<!--     dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--     n_comparisons = length(sig_sex_interaction_general), -->
<!--     structural_subtype = "Global and Lobal Cortical Thickness") -->

<!--   } else{cortical_thickness_general_assoc <- data.frame()} -->

<!--    ## Cortical Area ---- -->
<!--   sig_sex_interaction_bilateral <- cortical_area_bilateral[cortical_area_bilateral %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Regional Cortical Area" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--   if (length(sig_sex_interaction_bilateral) > 0){ -->

<!--     hemisphere_interactions <- hemisphere_interaction_group( -->
<!--       dependent = sig_sex_interaction_bilateral, -->
<!--       independent = "comorbidity_group", -->
<!--       covariates = brain_structure_covariates_T1_no_sex, -->
<!--       dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--       hemisphere_col = "hemi", -->
<!--       structural_subtype = "Regional Cortical Area") -->

<!--     if(!all(sig_sex_interaction_bilateral %in% hemisphere_interactions)){ -->

<!--     cortical_area_assoc <- bilateral_structure_assoc_group( -->
<!--       dependent = sig_sex_interaction_bilateral[!sig_sex_interaction_bilateral %in% hemisphere_interactions], -->
<!--       independent = "comorbidity_group", -->
<!--       covariates = brain_structure_covariates_T1_no_sex, -->
<!--       dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--       n_comparisons = length(sig_sex_interaction_bilateral[!sig_sex_interaction_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--       hemisphere_col = "hemi", -->
<!--       structural_subtype = "Regional Cortical Area", -->
<!--       id_col = "f.eid") -->

<!--     } else{cortical_area_assoc <- data.frame()} -->

<!--     if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--       cortical_area_assoc <- rbind(cortical_area_assoc, -->
<!--                                      unilateral_structure_assoc_group( -->
<!--                                        dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                                         independent = "comorbidity_group", -->
<!--                                         covariates = brain_structure_covariates_T1_no_sex, -->
<!--                                         dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--                                         n_comparisons = length(sig_sex_interaction_bilateral), ## Adjusted for after -->
<!--                                         structural_subtype = "Regional Cortical Area") -->
<!--       ) -->

<!--       ## Adjust pvalues -->
<!--       cortical_area_assoc$p.adjust <- p.adjust.new(cortical_area_assoc$p.value, method = "fdr") -->
<!--     } -->
<!--   } -->

<!--   sig_sex_interaction_general <- cortical_area_general[cortical_area_general %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Global and Lobal Cortical Area" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--   if (length(sig_sex_interaction_general) > 0){ -->
<!--   cortical_area_general_assoc <- unilateral_structure_assoc_group( -->
<!--     dependent = sig_sex_interaction_general, -->
<!--     independent = "comorbidity_group", -->
<!--     covariates = brain_structure_covariates_T1_no_sex, -->
<!--     dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--     n_comparisons = length(sig_sex_interaction_general), -->
<!--     structural_subtype = "Global and Lobal Cortical Area") -->

<!--   } else{cortical_area_general_assoc <- data.frame()} -->


<!--    ##FA ---- -->

<!--   sig_sex_interaction_bilateral <- FA_bilateral[FA_bilateral %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Fractional Anisotropy" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--   if (length(sig_sex_interaction_bilateral) > 0){ -->

<!--   hemisphere_interactions <- hemisphere_interaction_group(dependent = FA_bilateral, -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Fractional Anisotropy") -->

<!--   if(!all(sig_sex_interaction_bilateral %in% hemisphere_interactions)){ -->

<!--     FA_bilateral_assoc <- bilateral_structure_assoc_group( -->
<!--       dependent = FA_bilateral[!FA_bilateral %in% hemisphere_interactions], -->
<!--       independent = "comorbidity_group", -->
<!--       covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--       dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--       n_comparisons = length(FA_bilateral[!FA_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--       hemisphere_col = "hemi", -->
<!--       structural_subtype = "Fractional Anisotropy", -->
<!--       id_col = "f.eid") -->

<!--   } else{FA_bilateral_assoc <- data.frame()} -->

<!--     if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--       FA_bilateral_assoc <- rbind(FA_bilateral_assoc, -->
<!--                             unilateral_structure_assoc_group( -->
<!--                               dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                               independent = "comorbidity_group", -->
<!--                               covariates = brain_structure_covariates_T1_no_sex, -->
<!--                               dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--                               n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after -->
<!--                               structural_subtype = "Fractional Anisotropy") -->
<!--       ) -->

<!--       ## Adjust pvalues -->
<!--       FA_bilateral_assoc$p.adjust <- p.adjust.new(FA_bilateral_assoc$p.value, method = "fdr") -->
<!--     } -->

<!--   }else{FA_bilateral_assoc <- data.frame()} -->

<!--   sig_sex_interaction_unilateral <- FA_unilateral[FA_unilateral %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Fractional Anisotropy" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--     if (length(sig_sex_interaction_unilateral) > 0){ -->

<!--   FA_unilateral_assoc <- unilateral_structure_assoc_group(dependent = sig_sex_interaction_unilateral, -->
<!--                            independent = "comorbidity_group", -->
<!--                            covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                            dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--                            n_comparisons = length(sig_sex_interaction_unilateral), -->
<!--                            structural_subtype = "Fractional Anisotropy") -->

<!--     } else{FA_unilateral_assoc <- data.frame()} -->

<!--   sig_sex_interaction_general <- FA_general[FA_general %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Fractional Anisotropy" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--   if (length(sig_sex_interaction_general) > 0){ -->

<!--   FA_general_assoc <- unilateral_structure_assoc_group(dependent = sig_sex_interaction_general, -->
<!--                            independent = "comorbidity_group", -->
<!--                            covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                            dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--                            n_comparisons = length(sig_sex_interaction_general), -->
<!--                            structural_subtype = "General Fractional Anisotropy") -->

<!--   } else{FA_general_assoc <- data.frame()} -->

<!--   ##MD ---- -->

<!--   sig_sex_interaction_bilateral <- MD_bilateral[MD_bilateral %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Mean Diffusivity" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--   if (length(sig_sex_interaction_bilateral) > 0){ -->

<!--   hemisphere_interactions <- hemisphere_interaction_group(dependent = MD_bilateral, -->
<!--                          independent = "comorbidity_group", -->
<!--                          covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                          dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--                          hemisphere_col = "hemi", -->
<!--                          structural_subtype = "Mean Diffusivity") -->

<!--   if(!all(sig_sex_interaction_bilateral %in% hemisphere_interactions)){ -->

<!--     MD_bilateral_assoc <- bilateral_structure_assoc_group( -->
<!--       dependent = MD_bilateral[!MD_bilateral %in% hemisphere_interactions], -->
<!--       independent = "comorbidity_group", -->
<!--       covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--       dataset = get(paste0("UKB_CP_MDD_imaging_covariates_long_",sex)), -->
<!--       n_comparisons = length(MD_bilateral[!MD_bilateral %in% hemisphere_interactions]) + (length(hemisphere_interactions) * 2), -->
<!--       hemisphere_col = "hemi", -->
<!--       structural_subtype = "Mean Diffusivity", -->
<!--       id_col = "f.eid") -->

<!--   } else{MD_bilateral_assoc <- data.frame()} -->

<!--     if (!is.null(hemisphere_interactions)){ ## If hemi interaction found, run separately -->

<!--       MD_bilateral_assoc <- rbind(MD_bilateral_assoc, -->
<!--                             unilateral_structure_assoc_group( -->
<!--                               dependent = c(paste0(hemisphere_interactions, "_right"), paste0(hemisphere_interactions, "_left")), -->
<!--                               independent = "comorbidity_group", -->
<!--                               covariates = brain_structure_covariates_T1_no_sex, -->
<!--                               dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--                               n_comparisons = length(sub_cortical_area_bilateral), ## Adjusted for after -->
<!--                               structural_subtype = "Mean Diffusivity") -->
<!--       ) -->

<!--       ## Adjust pvalues -->
<!--       MD_bilateral_assoc$p.adjust <- p.adjust.new(MD_bilateral_assoc$p.value, method = "fdr") -->
<!--     } -->

<!--   }else{MD_bilateral_assoc <- data.frame()} -->

<!--   sig_sex_interaction_unilateral <- MD_unilateral[MD_unilateral %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Mean Diffusivity" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--     if (length(sig_sex_interaction_unilateral) > 0){ -->

<!--   MD_unilateral_assoc <- unilateral_structure_assoc_group(dependent = sig_sex_interaction_unilateral, -->
<!--                            independent = "comorbidity_group", -->
<!--                            covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                            dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--                            n_comparisons = length(sig_sex_interaction_unilateral), -->
<!--                            structural_subtype = "Mean Diffusivity") -->

<!--     } else{MD_unilateral_assoc <- data.frame()} -->

<!--   sig_sex_interaction_general <- MD_general[MD_general %in% unique(comorbidity_structure_sex_interaction_all$brain_phenotype[comorbidity_structure_sex_interaction_all$brain_structure_type == "Mean Diffusivity" & comorbidity_structure_sex_interaction_all$p < 0.05])] -->

<!--   if (length(sig_sex_interaction_general) > 0){ -->

<!--   MD_general_assoc <- unilateral_structure_assoc_group(dependent = sig_sex_interaction_general, -->
<!--                            independent = "comorbidity_group", -->
<!--                            covariates = brain_structure_covariates_diffusion_no_sex, -->
<!--                            dataset = get(paste0("UKB_CP_MDD_imaging_covariates_",sex)), -->
<!--                            n_comparisons = length(sig_sex_interaction_general), -->
<!--                            structural_subtype = "General Mean Diffusivity") -->

<!--   } else{MD_general_assoc <- data.frame()} -->


<!--   ## Combine association results -->
<!--   assign(paste0("comorbidity_structure_assoc_", sex), do.call("rbind", list(subcortical_volume_assoc, cortical_volume_assoc, cortical_area_assoc, cortical_thickness_assoc, cortical_area_general_assoc, cortical_thickness_general_assoc, cortical_volume_general_assoc, FA_bilateral_assoc, FA_general_assoc, FA_unilateral_assoc, MD_bilateral_assoc, MD_general_assoc, MD_unilateral_assoc))) -->

<!-- } -->

<!-- ## Remove sex-stratified analysis where no interaction was found in specific  -->
<!-- ## Females -->
<!-- comorbidity_structure_assoc_females_sig_sex_x <- comorbidity_structure_sex_interaction_all[comorbidity_structure_sex_interaction_all$p.value < 0.05, c("brain_phenotype","groups")] -->

<!-- comorbidity_structure_assoc_females_sig_sex_x$brain_phenotype_filter <- gsub("_right|_left", "", comorbidity_structure_assoc_females_sig_sex_x$brain_phenotype) -->
<!-- comorbidity_structure_assoc_females$brain_phenotype_filter <- gsub("_right|_left", "", comorbidity_structure_assoc_females$brain_phenotype) -->

<!-- comorbidity_structure_assoc_females <- merge(comorbidity_structure_assoc_females, comorbidity_structure_assoc_females_sig_sex_x, by = c("brain_phenotype_filter", "groups")) -->
<!-- comorbidity_structure_assoc_females <- comorbidity_structure_assoc_females %>% -->
<!--   select(-c(brain_phenotype.y, brain_phenotype_filter)) %>% -->
<!--   rename(brain_phenotype= brain_phenotype.x) -->

<!-- ## Redo p-value adjustment -->
<!-- comorbidity_structure_assoc_females$p.adjust[comorbidity_structure_assoc_females$brain_structure_type == "Regional Cortical Thickness"] <- p.adjust(comorbidity_structure_assoc_females$p.value[comorbidity_structure_assoc_females$brain_structure_type == "Regional Cortical Thickness"], method = "fdr") -->

<!-- comorbidity_structure_assoc_females$p.adjust[comorbidity_structure_assoc_females$brain_structure_type == "Regional Cortical Volume"] <- p.adjust(comorbidity_structure_assoc_females$p.value[comorbidity_structure_assoc_females$brain_structure_type == "Regional Cortical Volume"], method = "fdr") -->


<!-- ## Males -->
<!-- comorbidity_structure_assoc_males_sig_sex_x <- comorbidity_structure_sex_interaction_all[comorbidity_structure_sex_interaction_all$p.value < 0.05, c("brain_phenotype","groups")] -->

<!-- comorbidity_structure_assoc_males_sig_sex_x$brain_phenotype_filter <- gsub("_right|_left", "", comorbidity_structure_assoc_males_sig_sex_x$brain_phenotype) -->
<!-- comorbidity_structure_assoc_males$brain_phenotype_filter <- gsub("_right|_left", "", comorbidity_structure_assoc_males$brain_phenotype) -->

<!-- comorbidity_structure_assoc_males <- merge(comorbidity_structure_assoc_males, comorbidity_structure_assoc_males_sig_sex_x, by = c("brain_phenotype_filter", "groups")) -->
<!-- comorbidity_structure_assoc_males <- comorbidity_structure_assoc_males %>% -->
<!--   select(-c(brain_phenotype.y, brain_phenotype_filter)) %>% -->
<!--   rename(brain_phenotype= brain_phenotype.x) -->

<!-- ## Redo p-value adjustment -->
<!-- comorbidity_structure_assoc_males$p.adjust <- comorbidity_structure_assoc_males$p.value -->

<!-- ## Add column indicating disorder -->
<!-- comorbidity_structure_assoc_females$disorder<- "comorbidity" -->
<!-- comorbidity_structure_assoc_males$disorder<- "comorbidity" -->

<!-- ``` -->
